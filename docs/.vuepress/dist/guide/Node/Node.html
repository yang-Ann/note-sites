<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Node | An的个人笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/note-sites/favicon.ico">
    <script type="module" src="/note-sites/js/index.js"></script>
    <meta name="description" content="记录学习笔记">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/note-sites/assets/css/0.styles.a5e0cdd4.css" as="style"><link rel="preload" href="/note-sites/assets/js/app.b8d6499c.js" as="script"><link rel="preload" href="/note-sites/assets/js/5.2f78da70.js" as="script"><link rel="preload" href="/note-sites/assets/js/1.9e97c91a.js" as="script"><link rel="preload" href="/note-sites/assets/js/14.1d565f25.js" as="script"><link rel="prefetch" href="/note-sites/assets/js/10.85cb6931.js"><link rel="prefetch" href="/note-sites/assets/js/11.afea06bc.js"><link rel="prefetch" href="/note-sites/assets/js/12.39e2b3e2.js"><link rel="prefetch" href="/note-sites/assets/js/13.977b153e.js"><link rel="prefetch" href="/note-sites/assets/js/15.4b8ffb5e.js"><link rel="prefetch" href="/note-sites/assets/js/16.b7628662.js"><link rel="prefetch" href="/note-sites/assets/js/17.1a0b29d6.js"><link rel="prefetch" href="/note-sites/assets/js/18.06b41def.js"><link rel="prefetch" href="/note-sites/assets/js/19.61f852e8.js"><link rel="prefetch" href="/note-sites/assets/js/20.5d618384.js"><link rel="prefetch" href="/note-sites/assets/js/21.e30c4164.js"><link rel="prefetch" href="/note-sites/assets/js/22.8c8d8253.js"><link rel="prefetch" href="/note-sites/assets/js/23.fe0e18f1.js"><link rel="prefetch" href="/note-sites/assets/js/24.c9d03060.js"><link rel="prefetch" href="/note-sites/assets/js/25.4bd25a1a.js"><link rel="prefetch" href="/note-sites/assets/js/26.65844596.js"><link rel="prefetch" href="/note-sites/assets/js/27.ef2047b7.js"><link rel="prefetch" href="/note-sites/assets/js/28.44ca0eb6.js"><link rel="prefetch" href="/note-sites/assets/js/29.95665d30.js"><link rel="prefetch" href="/note-sites/assets/js/3.651ac13f.js"><link rel="prefetch" href="/note-sites/assets/js/30.63260758.js"><link rel="prefetch" href="/note-sites/assets/js/31.9be18a80.js"><link rel="prefetch" href="/note-sites/assets/js/32.0a163ba4.js"><link rel="prefetch" href="/note-sites/assets/js/33.37812b81.js"><link rel="prefetch" href="/note-sites/assets/js/34.d9681815.js"><link rel="prefetch" href="/note-sites/assets/js/35.30b7c2e4.js"><link rel="prefetch" href="/note-sites/assets/js/36.7d030294.js"><link rel="prefetch" href="/note-sites/assets/js/37.ab8de429.js"><link rel="prefetch" href="/note-sites/assets/js/38.269637f1.js"><link rel="prefetch" href="/note-sites/assets/js/39.696001c0.js"><link rel="prefetch" href="/note-sites/assets/js/4.d8e53db2.js"><link rel="prefetch" href="/note-sites/assets/js/40.87efcd2a.js"><link rel="prefetch" href="/note-sites/assets/js/41.01ebe269.js"><link rel="prefetch" href="/note-sites/assets/js/42.f0075bf6.js"><link rel="prefetch" href="/note-sites/assets/js/43.46228310.js"><link rel="prefetch" href="/note-sites/assets/js/44.e59fb071.js"><link rel="prefetch" href="/note-sites/assets/js/6.689d7b7c.js"><link rel="prefetch" href="/note-sites/assets/js/7.82514763.js"><link rel="prefetch" href="/note-sites/assets/js/8.fe1371a3.js"><link rel="prefetch" href="/note-sites/assets/js/9.a9dfe185.js">
    <link rel="stylesheet" href="/note-sites/assets/css/0.styles.a5e0cdd4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-c0d124fa><div data-v-c0d124fa><div class="password-shadow password-wrapper-out" style="display:none;" data-v-30dff670 data-v-c0d124fa data-v-c0d124fa><h3 class="title" data-v-30dff670>An的个人笔记</h3> <p class="description" data-v-30dff670>记录学习笔记</p> <label id="box" class="inputBox" data-v-30dff670><input type="password" value="" data-v-30dff670> <span data-v-30dff670>Konck! Knock!</span> <button data-v-30dff670>OK</button></label> <div class="footer" data-v-30dff670><span data-v-30dff670><i class="iconfont reco-theme" data-v-30dff670></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-30dff670>vuePress-theme-reco</a></span> <span data-v-30dff670><i class="iconfont reco-copyright" data-v-30dff670></i> <a data-v-30dff670><span data-v-30dff670>An</span>
          
        <!---->
        2023
      </a></span></div></div> <div class="hide" data-v-c0d124fa><header class="navbar" data-v-c0d124fa><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note-sites/" class="home-link router-link-active"><!----> <span class="site-name">An的个人笔记</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note-sites/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/note-sites/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  全部
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note-sites/categories/第三方库/" class="nav-link"><i class="undefined"></i>
  第三方库
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/编程语言/" class="nav-link"><i class="undefined"></i>
  编程语言
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/前端基础/" class="nav-link"><i class="undefined"></i>
  前端基础
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/版本管理/" class="nav-link"><i class="undefined"></i>
  版本管理
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/Shell/" class="nav-link"><i class="undefined"></i>
  Shell
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/数据库/" class="nav-link"><i class="undefined"></i>
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/包管理工具/" class="nav-link"><i class="undefined"></i>
  包管理工具
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/Linux/" class="nav-link"><i class="undefined"></i>
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/web开发框架/" class="nav-link"><i class="undefined"></i>
  web开发框架
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/混合开发/" class="nav-link"><i class="undefined"></i>
  混合开发
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/小程序/" class="nav-link"><i class="undefined"></i>
  小程序
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/打包工具/" class="nav-link"><i class="undefined"></i>
  打包工具
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/编程干货/" class="nav-link"><i class="undefined"></i>
  编程干货
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/系统语言/" class="nav-link"><i class="undefined"></i>
  系统语言
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note-sites/guide/HTML/HTML.html" class="nav-link"><i class="undefined"></i>
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/CSS/CSS.html" class="nav-link"><i class="undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/JavaScript/JavaScript.html" class="nav-link"><i class="undefined"></i>
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/TypeScript/TypeScript.html" class="nav-link"><i class="undefined"></i>
  TypeScript
</a></li><li class="dropdown-item"><h4>其他</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-sites/guide/JQuery/JQuery.html" class="nav-link"><i class="undefined"></i>
  JQuery
</a></li><li class="dropdown-subitem"><a href="/note-sites/guide/JavaScript/AJAX.html" class="nav-link"><i class="undefined"></i>
  AJAX
</a></li><li class="dropdown-subitem"><a href="/note-sites/guide/Axios/Axios.html" class="nav-link"><i class="undefined"></i>
  Axios
</a></li><li class="dropdown-subitem"><a href="/note-sites/guide/webpack/webpack.html" class="nav-link"><i class="undefined"></i>
  webpack
</a></li><li class="dropdown-subitem"><a href="/note-sites/guide/Three/Three.html" class="nav-link"><i class="undefined"></i>
  Three
</a></li><li class="dropdown-subitem"><a href="/note-sites/guide/Electron/Electron.html" class="nav-link"><i class="undefined"></i>
  electron
</a></li><li class="dropdown-subitem"><a href="/note-sites/guide/Electron/VS Code.html" class="nav-link"><i class="undefined"></i>
  VS Code
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/设计模式.html" class="nav-link"><i class="undefined"></i>
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/Node/Node.html" aria-current="page" class="nav-link router-link-exact-active router-link-active"><i class="undefined"></i>
  Node
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/Node/Npm.html" class="nav-link"><i class="undefined"></i>
  npm
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      框架
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note-sites/guide/Vue/Vue2.html" class="nav-link"><i class="undefined"></i>
  Vue2
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/Vue/Vue3.html" class="nav-link"><i class="undefined"></i>
  Vue3
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/React/React-16.html" class="nav-link"><i class="undefined"></i>
  React-16
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/React/React-18.html" class="nav-link"><i class="undefined"></i>
  React-18
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/微信小程序/微信小程序.html" class="nav-link"><i class="undefined"></i>
  微信小程序
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-other"></i>
      其他
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note-sites/guide/Git/Git.html" class="nav-link"><i class="undefined"></i>
  Git
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/C语言/C语言.html" class="nav-link"><i class="undefined"></i>
  C语言
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/Java/Java.html" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/ArcGIS/ArcGIS.html" class="nav-link"><i class="undefined"></i>
  ArcGIS
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/Linux/Linux.html" class="nav-link"><i class="undefined"></i>
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/Linux/Shell.html" class="nav-link"><i class="undefined"></i>
  Shell
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/Rust/Rust.html" class="nav-link"><i class="undefined"></i>
  Rust
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      博客生成工具
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://vuepress.vuejs.org/zh" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  vuepress
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://vuepress-theme-reco.recoluan.com" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  vuepress-theme-reco
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-c0d124fa></div> <aside class="sidebar" data-v-c0d124fa><div class="personal-info-wrapper" data-v-5c49c935 data-v-c0d124fa><img src="/note-sites/assets/img/logo.png" alt="author-avatar" class="personal-img" data-v-5c49c935> <h3 class="name" data-v-5c49c935>
    An
  </h3> <div class="num" data-v-5c49c935><div data-v-5c49c935><h3 data-v-5c49c935>33</h3> <h6 data-v-5c49c935>文章</h6></div> <div data-v-5c49c935><h3 data-v-5c49c935>26</h3> <h6 data-v-5c49c935>标签</h6></div></div> <ul class="social-links" data-v-5c49c935><li class="social-item" data-v-5c49c935><i class="iconfont reco-github" style="color:#f8b26a;" data-v-5c49c935></i></li><li class="social-item" data-v-5c49c935><i class="iconfont reco-mayun" style="color:#f47e60;" data-v-5c49c935></i></li><li class="social-item" data-v-5c49c935><i class="iconfont reco-juejin" style="color:#f8b26a;" data-v-5c49c935></i></li><li class="social-item" data-v-5c49c935><i class="iconfont reco-npm" style="color:#fb9b5f;" data-v-5c49c935></i></li><li class="social-item" data-v-5c49c935><i class="iconfont reco-bilibili" style="color:#f47e60;" data-v-5c49c935></i></li></ul> <hr data-v-5c49c935></div> <nav class="nav-links"><div class="nav-item"><a href="/note-sites/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/note-sites/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  全部
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note-sites/categories/第三方库/" class="nav-link"><i class="undefined"></i>
  第三方库
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/编程语言/" class="nav-link"><i class="undefined"></i>
  编程语言
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/前端基础/" class="nav-link"><i class="undefined"></i>
  前端基础
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/版本管理/" class="nav-link"><i class="undefined"></i>
  版本管理
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/Shell/" class="nav-link"><i class="undefined"></i>
  Shell
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/数据库/" class="nav-link"><i class="undefined"></i>
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/包管理工具/" class="nav-link"><i class="undefined"></i>
  包管理工具
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/Linux/" class="nav-link"><i class="undefined"></i>
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/web开发框架/" class="nav-link"><i class="undefined"></i>
  web开发框架
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/混合开发/" class="nav-link"><i class="undefined"></i>
  混合开发
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/小程序/" class="nav-link"><i class="undefined"></i>
  小程序
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/打包工具/" class="nav-link"><i class="undefined"></i>
  打包工具
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/编程干货/" class="nav-link"><i class="undefined"></i>
  编程干货
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/categories/系统语言/" class="nav-link"><i class="undefined"></i>
  系统语言
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note-sites/guide/HTML/HTML.html" class="nav-link"><i class="undefined"></i>
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/CSS/CSS.html" class="nav-link"><i class="undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/JavaScript/JavaScript.html" class="nav-link"><i class="undefined"></i>
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/TypeScript/TypeScript.html" class="nav-link"><i class="undefined"></i>
  TypeScript
</a></li><li class="dropdown-item"><h4>其他</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note-sites/guide/JQuery/JQuery.html" class="nav-link"><i class="undefined"></i>
  JQuery
</a></li><li class="dropdown-subitem"><a href="/note-sites/guide/JavaScript/AJAX.html" class="nav-link"><i class="undefined"></i>
  AJAX
</a></li><li class="dropdown-subitem"><a href="/note-sites/guide/Axios/Axios.html" class="nav-link"><i class="undefined"></i>
  Axios
</a></li><li class="dropdown-subitem"><a href="/note-sites/guide/webpack/webpack.html" class="nav-link"><i class="undefined"></i>
  webpack
</a></li><li class="dropdown-subitem"><a href="/note-sites/guide/Three/Three.html" class="nav-link"><i class="undefined"></i>
  Three
</a></li><li class="dropdown-subitem"><a href="/note-sites/guide/Electron/Electron.html" class="nav-link"><i class="undefined"></i>
  electron
</a></li><li class="dropdown-subitem"><a href="/note-sites/guide/Electron/VS Code.html" class="nav-link"><i class="undefined"></i>
  VS Code
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/设计模式.html" class="nav-link"><i class="undefined"></i>
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/Node/Node.html" aria-current="page" class="nav-link router-link-exact-active router-link-active"><i class="undefined"></i>
  Node
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/Node/Npm.html" class="nav-link"><i class="undefined"></i>
  npm
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      框架
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note-sites/guide/Vue/Vue2.html" class="nav-link"><i class="undefined"></i>
  Vue2
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/Vue/Vue3.html" class="nav-link"><i class="undefined"></i>
  Vue3
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/React/React-16.html" class="nav-link"><i class="undefined"></i>
  React-16
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/React/React-18.html" class="nav-link"><i class="undefined"></i>
  React-18
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/微信小程序/微信小程序.html" class="nav-link"><i class="undefined"></i>
  微信小程序
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-other"></i>
      其他
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note-sites/guide/Git/Git.html" class="nav-link"><i class="undefined"></i>
  Git
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/C语言/C语言.html" class="nav-link"><i class="undefined"></i>
  C语言
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/Java/Java.html" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/ArcGIS/ArcGIS.html" class="nav-link"><i class="undefined"></i>
  ArcGIS
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/Linux/Linux.html" class="nav-link"><i class="undefined"></i>
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/Linux/Shell.html" class="nav-link"><i class="undefined"></i>
  Shell
</a></li><li class="dropdown-item"><!----> <a href="/note-sites/guide/Rust/Rust.html" class="nav-link"><i class="undefined"></i>
  Rust
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      博客生成工具
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://vuepress.vuejs.org/zh" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  vuepress
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://vuepress-theme-reco.recoluan.com" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  vuepress-theme-reco
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-30dff670 data-v-c0d124fa><h3 class="title" data-v-30dff670>Node</h3> <!----> <label id="box" class="inputBox" data-v-30dff670><input type="password" value="" data-v-30dff670> <span data-v-30dff670>Konck! Knock!</span> <button data-v-30dff670>OK</button></label> <div class="footer" data-v-30dff670><span data-v-30dff670><i class="iconfont reco-theme" data-v-30dff670></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-30dff670>vuePress-theme-reco</a></span> <span data-v-30dff670><i class="iconfont reco-copyright" data-v-30dff670></i> <a data-v-30dff670><span data-v-30dff670>An</span>
          
        <!---->
        2023
      </a></span></div></div> <div data-v-c0d124fa><div data-v-c0d124fa><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">Node</h1> <div data-v-7b22c628><i class="iconfont reco-account" data-v-7b22c628><span data-v-7b22c628>An</span></i> <i class="iconfont reco-date" data-v-7b22c628><span data-v-7b22c628>2022/6/12</span></i> <!----> <i class="tags iconfont reco-tag" data-v-7b22c628><span class="tag-item" data-v-7b22c628>Node</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="node"><a href="#node" class="header-anchor">#</a> Node</h1> <blockquote><p><a href="http://nodejs.cn/learn/introduction-to-nodejs" target="_blank" rel="noopener noreferrer">官方教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://www.bookstack.cn/read/Nodejs-Roadmap/_coverpage.md" target="_blank" rel="noopener noreferrer">书栈网教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p></p><div class="table-of-contents"><ul><li><a href="#node中的js">Node中的js</a><ul><li><a href="#几个术语">几个术语</a></li></ul></li><li><a href="#ip地址和端口号">IP地址和端口号</a></li><li><a href="#node中的全局变量">node中的全局变量</a><ul><li><a href="#global">global</a></li><li><a href="#this">this</a></li><li><a href="#globalthis">globalThis</a></li><li><a href="#filename">__filename</a></li><li><a href="#dirname">__dirname</a></li><li><a href="#process">process</a></li><li><a href="#setimmediate">setImmediate</a></li></ul></li><li><a href="#fs">fs</a></li><li><a href="#readline">readline</a></li><li><a href="#path">path</a></li><li><a href="#os">os</a></li><li><a href="#events">events</a></li><li><a href="#其他模块">其他模块</a></li><li><a href="#http">http</a><ul><li><a href="#类">类</a></li><li><a href="#mime">MIME</a></li></ul></li><li><a href="#zlib">zlib</a></li><li><a href="#url">url</a><ul><li><a href="#旧版api">旧版API</a></li><li><a href="#新版api">新版API</a></li><li><a href="#转换格式api">转换格式API</a></li></ul></li><li><a href="#querystring">querystring</a><ul><li><a href="#parse-和-encode">parse 和 encode</a></li><li><a href="#escape-和-unescape">escape 和 unescape</a></li></ul></li><li><a href="#buffer">Buffer</a><ul><li><a href="#buffer的作用">Buffer的作用</a></li><li><a href="#访问-buffer-的内容">访问 buffer 的内容</a><ul><li><a href="#buffer-字符编码">Buffer 字符编码</a></li></ul></li><li><a href="#复制-buffer">复制 buffer</a></li><li><a href="#切片buffer">切片buffer</a></li></ul></li><li><a href="#stream">stream</a><ul><li><a href="#什么是流">什么是流</a></li><li><a href="#流的优点">流的优点</a></li><li><a href="#使用流读取和写入文件">使用流读取和写入文件</a></li><li><a href="#流驱动的-node-js-api">流驱动的 Node.js API</a></li><li><a href="#不同类型的流">不同类型的流</a><ul><li><a href="#自定义创建可读流">自定义创建可读流</a></li><li><a href="#自定义创建可写流">自定义创建可写流</a></li><li><a href="#从自定义可读流中获取数据">从自定义可读流中获取数据</a></li></ul></li></ul></li><li><a href="#crypto">crypto</a></li><li><a href="#child-process">child_process</a></li><li><a href="#开发环境与生产环境">开发环境与生产环境</a></li><li><a href="#断点调试">断点调试</a></li><li><a href="#错误处理">错误处理</a><ul><li><a href="#创建异常">创建异常</a></li><li><a href="#错误对象">错误对象</a></li><li><a href="#处理异常">处理异常</a></li><li><a href="#捕获未捕获的异常">捕获未捕获的异常</a></li><li><a href="#promise-异常">Promise 异常</a></li></ul></li><li><a href="#node-js-中记录对象">Node.js 中记录对象</a></li><li><a href="#node-模块化">Node 模块化</a></li><li><a href="#使用-typescript">使用 TypeScript</a></li><li><a href="#webassembly">WebAssembly</a><ul><li><a href="#关键概念">关键概念</a></li><li><a href="#生成-webassembly-模块">生成 WebAssembly 模块</a></li><li><a href="#与操作系统交互">与操作系统交互</a></li></ul></li><li><a href="#express">Express</a><ul><li><a href="#app-use">app.use</a></li><li><a href="#请求和响应">请求和响应</a></li><li><a href="#覆盖-express-api">覆盖 Express API</a><ul><li><a href="#修改方法">修改方法</a></li><li><a href="#添加特性">添加特性</a></li></ul></li><li><a href="#静态文件">静态文件</a></li><li><a href="#路由">路由</a><ul><li><a href="#路由参数">路由参数</a></li><li><a href="#多个回调函数处理路由">多个回调函数处理路由</a></li><li><a href="#响应方法">响应方法</a></li><li><a href="#路由模块化">路由模块化</a></li><li><a href="#跨域配置">跨域配置</a></li></ul></li><li><a href="#中间件">中间件</a><ul><li><a href="#express-中间件的定义">Express 中间件的定义</a></li><li><a href="#全局中间件">全局中间件</a></li><li><a href="#可配置的中间件">可配置的中间件</a></li><li><a href="#路由中间件">路由中间件</a></li><li><a href="#处理-404-和服务器错误">处理 404 和服务器错误</a></li></ul></li><li><a href="#使用token">使用token</a></li><li><a href="#解析body参数">解析body参数</a></li><li><a href="#文件上传">文件上传</a></li><li><a href="#文件下载">文件下载</a></li><li><a href="#模板引擎">模板引擎</a></li><li><a href="#日志管理">日志管理</a></li></ul></li><li><a href="#koa">Koa</a><ul><li><a href="#koa参数设置">Koa参数设置</a></li><li><a href="#app的常用属性-方法">app的常用属性/方法</a><ul><li><a href="#app-use方法">app.use方法</a></li><li><a href="#app-listen方法">app.listen方法</a></li><li><a href="#app-context属性">app.context属性</a></li><li><a href="#ctx-app">ctx.app</a></li><li><a href="#app-emit">app.emit</a></li><li><a href="#ctx-respond">ctx.respond</a></li></ul></li><li><a href="#中间件">中间件</a><ul><li><a href="#洋葱模型">洋葱模型</a><ul><li><a href="#koa-中间件的定义">Koa 中间件的定义</a></li></ul></li></ul></li><li><a href="#上下文-context">上下文(Context)</a><ul><li><a href="#请求处理-ctx-request-https-koa-bootcss-com-request">请求处理(ctx.request)</a></li><li><a href="#ctx-request-fresh">ctx.request.fresh</a></li><li><a href="#ctx-request-stale">ctx.request.stale</a></li><li><a href="#request-is-types">request.is(types...)</a></li><li><a href="#request-accepts-types">request.accepts(types)</a></li><li><a href="#request别名">Request别名</a></li><li><a href="#响应处理-ctx-response-https-koa-bootcss-com-response">响应处理(ctx.response)</a></li><li><a href="#ctx-response-append-field-value">ctx.response.append(field, value)</a></li><li><a href="#response-别名">Response 别名</a></li></ul></li><li><a href="#错误处理">错误处理</a></li><li><a href="#koa流行依赖-包">Koa流行依赖(包)</a><ul><li><a href="#koa-router">koa-router</a></li><li><a href="#静态文件">静态文件</a></li><li><a href="#koa-bodyparser">koa-bodyparser</a></li><li><a href="#koa-cors">@koa/cors</a></li><li><a href="#koa-multer">@koa/multer</a></li><li><a href="#koa-views">koa-views</a></li><li><a href="#koa-compose">koa-compose</a></li><li><a href="#koa封装数据库操作">Koa封装数据库操作</a></li><li><a href="#koa记录日志">Koa记录日志</a></li></ul></li></ul></li><li><a href="#rest">REST</a><ul><li><a href="#http-方法">HTTP 方法</a></li></ul></li><li><a href="#网络请求">网络请求</a><ul><li><a href="#axios">axios</a><ul><li><a href="#文件上传">文件上传</a></li><li><a href="#分片下载文件">分片下载文件</a></li></ul></li><li><a href="#request">request</a><ul><li><a href="#get请求">GET请求</a></li><li><a href="#post请求">POST请求</a></li><li><a href="#保存文件">保存文件</a></li></ul></li></ul></li><li><a href="#命令行输出颜色">命令行输出颜色</a></li><li><a href="#typescript">TypeScript</a></li><li><a href="#node-连接-mysql">Node 连接 MySQL</a></li></ul></div><p></p> <p>官网安装完<code>Node</code>以后就可以使用<code>node</code>来进入<code>node</code>环境和使用<code>node</code>来执行<code>.{js,cjs,mjs}</code>文件</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># 运行当前目录中的 index.mjs 文件</span>
$ <span class="token function">node</span> index.mjs

$ <span class="token function">node</span> <span class="token comment"># 进入 node 环境</span>
Welcome to Node.js v16.15.0.
Type <span class="token string">&quot;.help&quot;</span> <span class="token keyword">for</span> <span class="token function">more</span> information.
<span class="token operator">&gt;</span> console.log<span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hello world
<span class="token operator">&gt;</span> .exit <span class="token comment"># 退出</span>

<span class="token comment"># 命令行执行代码</span>
<span class="token function">node</span> <span class="token parameter variable">-p</span> <span class="token string">&quot;require('./package.json').version&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="node中的js"><a href="#node中的js" class="header-anchor">#</a> Node中的js</h2> <ul><li><p>EcmaScript</p> <ul><li>node 中采用 EcmaScript标准, 但是没有BOM和DOM</li> <li>文件名还是js, 但是命名不能是 node.js</li></ul></li> <li><p>核心模块</p> <ul><li>在 node 中为 js 提供了 很多服务器级别的API, 这些API都被包装到一个具名的核心模块
<ul><li>例如: 文件操作的 <code>fs</code> 模块, http服务的 <code>http</code> 模块, 路径操作模块 <code>path</code>, 操作系统模块 <code>os</code> 等等</li> <li>这些核心模块都可以直接引入<code>const xxx = require('xxx')</code></li></ul></li></ul></li> <li><p>模块化</p> <ul><li><p>具名模块:</p> <ul><li>例如 fs, http, path</li></ul></li> <li><p>自定义模块</p> <ul><li>node中的模块化标准都是 <code>commomjs</code> <ul><li><code>module.exports</code> 和 <code>exports</code> 是默认模块接口对象</li> <li><code>require('xxx')</code> 加载并执行 xxx 模块里的代码并返回对应模块的 <code>module.exports/exports</code> 对象</li></ul></li></ul> <blockquote><p><code>exports 和 module.exports</code> 是等价的, 都是默认的接口对象, 不能直接赋值修改</p></blockquote></li></ul> <p>node的模块查找顺序是先找<code>核心模块</code>, 然后是<code>当前目录</code>, 最后才是<code>node_modules</code></p></li></ul> <h3 id="几个术语"><a href="#几个术语" class="header-anchor">#</a> 几个术语</h3> <ul><li><strong>CURRENT</strong>：指代最新的 Node.js 版本系列（单数）</li> <li><strong>Active</strong>：指正在积极维护和升级的版本系列, 包括向后移植非破坏性功能和改进, 解决错误以及修补安全漏洞</li> <li><strong>Maintenance</strong>：这是一个维护的 LTS 版本系列, 直到它的生命周期终止, 只会在短时间内收到错误修复和安全补丁</li> <li><strong>LTS</strong>：是 Long-Term Support 的缩写, 代表 Node.js 长期支持的版本（版本号为复数）</li> <li><strong>EOL</strong>：EOL 是 End of Life 的首字母缩写, 进入到 EOL 时间线的版本, 将不在维护</li></ul> <h2 id="ip地址和端口号"><a href="#ip地址和端口号" class="header-anchor">#</a> IP地址和端口号</h2> <p>所有联网的程序都需要进行网络通信, 计算机中只有一个物理网卡, 而且同一个局域网中, 网卡的地址必须是唯一的.</p> <p>网卡是通过唯一的 IP 地址进行定位的</p> <ul><li><p>IP地址定位具体的计算机(服务器)</p></li> <li><p>端口号定位具体的应用程序(软件APP)</p> <p>所有需要联网通信的软件都必须占用一个端口号, 端口号范围从<code>0 ~ 65535</code></p></li></ul> <h2 id="node中的全局变量"><a href="#node中的全局变量" class="header-anchor">#</a> node中的全局变量</h2> <p>浏览器中全局对象是<code>window</code>,在node中全局对象就是<code>global</code></p> <h3 id="global"><a href="#global" class="header-anchor">#</a> global</h3> <p>在<strong>Node.js</strong>中, 可以使用<code>global</code>关键字访问全局对象：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// node 环境</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>global<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// =&gt; Object [global] {...}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>window</code>、<code>self</code>或<code>frames</code> 在 Node 环境中不起作用, <strong>Node.js</strong>中的顶级作用域不是全局作用域。在浏览器中, <code>var abc = 123</code>将创建一个全局变量。 但是, 在 Node 中, 变量将是模块本身的局部变量</p> <h3 id="this"><a href="#this" class="header-anchor">#</a> this</h3> <p>在浏览器下, 可以在程序的顶层使用<code>this</code>关键字来引用全局对象:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>foo <span class="token operator">===</span> window<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// =&gt; true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在非严格模式下运行的内部函数或箭头函数中的 <code>this</code> 也引用了全局对象。 但是, 在严格模式下<code>this</code>值为<code>undefined</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// =&gt; Window {...}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// =&gt; Window {...}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// =&gt; undefined</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Node 模块中, <code>this</code>在顶层不引用全局对象。相反, 它具有与<code>module.exports</code>相同的值, 在函数(Node 环境)内部, <code>this</code>值是根据调用函数的方式确定的, 在 JS 模块中, <code>this</code> 在顶层是<code>undefined</code>的, 因为模块默认开启严格模式</p> <h3 id="globalthis"><a href="#globalthis" class="header-anchor">#</a> globalThis</h3> <p><code>globalThis</code>旨在通过定义一个标准的全局属性来整合日益分散的访问全局对象的方法, 它已经被纳入<strong>ES2020</strong>标准, 所有流行的浏览器, 包括Chrome 71+、Firefox 65+和Safari 12.1+, 都已经支持这项功能, 可以在**Node.js 12+**中使用它</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 浏览器环境</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>globalThis<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// =&gt; Window {...}</span>

<span class="token comment">// node.js 环境</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>globalThis<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// =&gt; Object [global] {...}</span>

<span class="token comment">// web worker 环境</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>globalThis<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// =&gt; DedicatedWorkerGlobalScope {...}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>通过使用<code>globalThis</code>, 你的代码将在 window 和非 window 上下文中工作, 而无需编写额外的检查或测试。在大多数环境中, <code>globalThis</code>直接引用该环境的全局对象。但是, 在浏览器中, 内部使用代理来考虑<code>iframe</code>和跨 window 安全性。 实际上, 它并不会改变我们编写代码的方式</p> <h3 id="filename"><a href="#filename" class="header-anchor">#</a> __filename</h3> <p><strong>__filename</strong> 表示当前正在执行的脚本的文件名。它将输出文件所在位置的绝对路径, 且和命令行参数所指定的文件名不一定相同。 如果在模块中, 返回的值是模块文件的路径, 注意<code>ESModule</code>下没有该变量, 可以使用<code>import.meta.url</code>模拟出来</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> url <span class="token keyword">from</span> <span class="token string">&quot;url&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'file:///F:/project/auxiliary-util/index.ts'</span>

<span class="token keyword">const</span> __filename <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">fileURLToPath</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// or</span>
<span class="token keyword">const</span> __filename <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">fileURLToPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// F:\project\auxiliary-util\index.ts</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="dirname"><a href="#dirname" class="header-anchor">#</a> __dirname</h3> <p><strong>__dirname</strong> 表示当前执行脚本所在的目录, , 注意<code>ESModule</code>下没有该变量, 但是可以通过<code>path.resolve()</code>或者<code>import.meta.url</code>模拟出来, 如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> path <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> url <span class="token keyword">from</span> <span class="token string">&quot;url&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> __dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// or</span>
<span class="token keyword">const</span> __dirname <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">fileURLToPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>还有<code>setTimeout</code> <code>clearTimeout</code> <code>setInterval</code> <code>clearInterval</code> <code>console</code>同浏览器中一样</p></blockquote> <h3 id="process"><a href="#process" class="header-anchor">#</a> process</h3> <p><strong><a href="http://nodejs.cn/api/process.html#processexitcode" target="_blank" rel="noopener noreferrer">process<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong> 是一个全局变量, 即 <strong>global</strong> 对象的属性</p> <p>它用于描述当前Node.js 进程状态的对象, 提供了一个与操作系统的简单接口</p> <p>通常在写本地命令行程序的时候, 少不了要 和它打交道</p> <p><strong>Process 事件:</strong></p> <table><thead><tr><th>事件</th> <th>描述</th></tr></thead> <tbody><tr><td><strong>exit</strong></td> <td>当进程准备退出时触发</td></tr> <tr><td><strong>beforeExit</strong></td> <td>当 node 清空事件循环, 并且没有其他安排时触发这个事件。通常来说, 当没有进程安排时 node 退出, 但是 'beforeExit' 的监听器可以异步调用, 这样 node 就会继续执行</td></tr> <tr><td><strong>uncaughtException</strong></td> <td>当一个异常冒泡回到事件循环, 触发这个事件。如果给异常添加了监视器, 默认的操作（打印堆栈跟踪信息并退出）就不会发生</td></tr> <tr><td><strong>Signal</strong></td> <td>当进程接收到信号时就触发。信号列表详见标准的 POSIX 信号名, 如 SIGINT、SIGUSR1 等</td></tr></tbody></table> <div class="language-js line-numbers-mode"><pre class="language-js"><code>process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 以下代码永远不会执行</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;该代码不会执行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'退出码为:'</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 退出码为: 0</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;程序执行结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>Process 属性:</strong></p> <table><thead><tr><th>属性</th> <th>描述</th> <th>属性</th> <th>描述</th></tr></thead> <tbody><tr><td><strong>stdout</strong></td> <td>标准输出流</td> <td><strong>stderr</strong></td> <td>标准错误流</td></tr> <tr><td><strong>stdin</strong></td> <td>标准输入流</td> <td><a href="http://nodejs.cn/learn/nodejs-accept-arguments-from-the-command-line" target="_blank" rel="noopener noreferrer"><strong>argv</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td><strong>argv</strong> 属性返回一个数组, 由命令行执行脚本时的各个参数组成<br>它的第一个成员总是node, 第二个成员是脚本文件名, 其余成员是脚本文件的参数</td></tr> <tr><td><strong>execPath</strong></td> <td>返回执行当前脚本的 Node 二进制文件的绝对路径</td> <td><strong>execArgv</strong></td> <td>返回一个数组, 成员是命令行下执行脚本时, 在Node可执行文件与脚本文件之间的命令行参数</td></tr> <tr><td><strong><a href="http://nodejs.cn/learn/how-to-read-environment-variables-from-nodejs" target="_blank" rel="noopener noreferrer">env<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong></td> <td>返回一个对象, 为当前 shell 的环境变量</td> <td><strong>exitCode</strong></td> <td>进程退出时的代码, 如果进程优通过 process.exit() 退出, 不需要指定退出码</td></tr> <tr><td><strong>version</strong></td> <td>版本信息对象, 比如<strong>v0.10.18</strong></td> <td><strong>versions</strong></td> <td>一个属性, 包含了 node 的版本和依赖</td></tr> <tr><td><strong>config</strong></td> <td>一个包含用来编译当前 node 执行文件的 javascript 配置选项的对象<br>它与运行 <strong>./configure</strong> 脚本生成的<strong>config.gypi</strong>文件相同</td> <td><strong>pid</strong></td> <td>当前进程的进程号</td></tr> <tr><td><strong>ppid</strong></td> <td>当前进程对应的父进程</td> <td></td> <td></td></tr> <tr><td><strong>title</strong></td> <td>进程名, 默认值为<strong>node</strong>, 可以自定义该值</td> <td><strong>arch</strong></td> <td>当前 CPU 的架构：<strong>arm</strong>、<strong>ia32</strong> 或者 <strong>x64</strong></td></tr> <tr><td><strong>platform</strong></td> <td>运行程序所在的平台系统 <strong>darwin</strong>, <strong>freebsd</strong>, <strong>linux</strong>, <strong>sunos</strong> 或 <strong>win32</strong></td> <td><strong>mainModule</strong></td> <td>require.main 的备选方法。不同点, 如果主模块在运行时改变, require.main可能会继续返回老的模块<br>可以认为, 这两者引用了同一个模块</td></tr></tbody></table> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 输出到终端</span>
process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World!&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello World!</span>
<span class="token comment">// 通过参数读取</span>
process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> index<span class="token punctuation">,</span> array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token string">': '</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0: C:\Program Files\nodejs\node.exe</span>
                                    <span class="token comment">// 1: E:\yjb\node\app.js</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取执行路径</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>execPath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// C:\Program Files\nodejs\node.exe </span>
<span class="token comment">// 平台信息</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>platform<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// win32</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>设置和读取环境变量</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// unix 系统中设置环境变量 NODE_ENV</span>
<span class="token constant">NODE_ENV</span><span class="token operator">=</span>producttion node app<span class="token punctuation">.</span>js

<span class="token comment">// windows 系统中设置环境变量 NODE_ENV</span>
<span class="token keyword">set</span> <span class="token constant">NODE_ENV</span><span class="token operator">=</span>producttion <span class="token operator">&amp;&amp;</span> node app<span class="token punctuation">.</span>js
<span class="token comment">// 这样环境变量就会出现在 process.env 对象中了</span>

<span class="token comment">// 读取环境变量 NODE_ENV</span>
<span class="token keyword">const</span> env <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 对应 系统变量 Path</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>Process方法</strong></p> <table><thead><tr><th>方法</th> <th>描述</th> <th>方法</th> <th>描述</th></tr></thead> <tbody><tr><td><strong>abort()</strong></td> <td>这将导致 node 触发 abort 事件<br>会让 node 退出并生成一个核心文件</td> <td><strong>chdir(directory)</strong></td> <td>改变当前工作进程的目录, 如果操作失败抛出异常</td></tr> <tr><td><strong>cwd()</strong></td> <td>当前执行node命令的文件夹地址, 对于全局命令时很有用</td> <td><strong>exit([code])</strong></td> <td>使用指定的 <a href="http://nodejs.cn/api/process.html#process_exit_codes" target="_blank" rel="noopener noreferrer">code<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 结束进程。如果忽略, 将会使用 code 0</td></tr> <tr><td><strong>kill(pid[, signal])</strong></td> <td>发送信号给进程. pid 是进程id, 并且 signal 是发送的信号的字符串描述。信号名是字符串, 比如 'SIGINT' 或 'SIGHUP'。如果忽略, 信号会是 'SIGTERM'</td> <td><strong>memoryUsage()</strong></td> <td>返回一个对象, 描述了 Node 进程所用的内存状况, 单位为字节</td></tr> <tr><td><strong><a href="http://nodejs.cn/learn/understanding-process-nexttick" target="_blank" rel="noopener noreferrer">nextTick<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(callback)</strong></td> <td>一旦当前事件循环结束, 调用回调函数, <strong>优先级高于宏任务和微任务</strong></td> <td><strong>umask([mask])</strong></td> <td>设置或读取进程文件的掩码。子进程从父进程继承掩码。如果mask 参数有效, 返回旧的掩码。否则, 返回当前掩码</td></tr> <tr><td><strong>uptime()</strong></td> <td>返回 Node 已经运行的秒数</td> <td><strong>hrtime()</strong></td> <td>返回当前进程的高分辨时间, 形式为 [seconds, nanoseconds]数组。它是相对于过去的任意事件。该值与日期无关, 因此不受时钟漂移的影响。主要用途是可以通过精确的时间间隔, 来衡量程序的性能。<br>你可以将之前的结果传递给当前的 process.hrtime() , 会返回两者间的时间差, 用来基准和测量时间间隔</td></tr></tbody></table> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 输出当前目录</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'当前目录: '</span> <span class="token operator">+</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 当前目录: E:\yjb\node</span>
<span class="token comment">// 输出当前版本</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'当前版本: '</span> <span class="token operator">+</span> process<span class="token punctuation">.</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 当前版本: v14.17.3</span>
<span class="token comment">// 输出内存使用情况</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">memoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {...}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="setimmediate"><a href="#setimmediate" class="header-anchor">#</a> setImmediate</h3> <p>和<code>process.nextTick</code>类似只不过是在异步任务中优先级最低的比<code>setTimeout</code> <code>setInterval</code>还低</p> <blockquote><p><a href="http://nodejs.cn/learn/understanding-setimmediate" target="_blank" rel="noopener noreferrer">官方setImmediate教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="http://www.ruanyifeng.com/blog/2018/02/node-event-loop.html" target="_blank" rel="noopener noreferrer">阮一峰教程node定时器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h2 id="fs"><a href="#fs" class="header-anchor">#</a> fs</h2> <p>文件系统就是通过 node 来操作系统中的文件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 基于 回调和同步的 API 可见 http://nodejs.cn/api/fs.html#callback-api</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> fs <span class="token keyword">from</span> <span class="token string">&quot;node:fs&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 等同于 import * as fs from &quot;fs&quot;;</span>

<span class="token comment">// 基于 promise 的 API 可见 http://nodejs.cn/api/fs.html#promises-api</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> fs <span class="token keyword">from</span> <span class="token string">&quot;node:fs/promises&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p><a href="http://nodejs.cn/learn/the-nodejs-fs-module" target="_blank" rel="noopener noreferrer">Nodejs 文件系统模块<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>fs模块的 API 都分为 同步和异步两种 (带<code>Sync</code>后缀的是同步), 而异步回调函数的参数node统一约定了<strong>第一个参数是错误对象</strong></p> <p>常用方法如下:</p> <table><thead><tr><th>方法名</th> <th>说明</th></tr></thead> <tbody><tr><td>writeFile(file, data[, options], callback)</td> <td>写入文件, <code>file</code>文件路径, <code>data</code>数据, <code>options</code>写入的一些配置, <code>callback</code>回调<br><strong>Node写入不存在的文件时会创建对应的文件</strong></td></tr> <tr><td>readFile(path[, options], callback)</td> <td>文件读取, <code>path</code>读取文件路径, <code>options</code>读取的选项, <code>callback</code>回调<br><a href="http://nodejs.cn/api/fs.html#file-system-flags" target="_blank" rel="noopener noreferrer">文件标识符<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td>appendFile(path, data, callback)</td> <td>追加到文件, <code>path</code>文件路径, <code>data</code>追加的数据, <code>callback</code>回调<br></td></tr> <tr><td>existsSync(path)</td> <td>检查一个路径是否存在</td></tr> <tr><td>statSync(path)</td> <td>获取文件的状态, 返回一个对象, 对象包括文件的大小, 创建时间, 是否是文件或文件夹</td></tr> <tr><td>unlink(path, callback)</td> <td>删除文件(<code>不包括文件夹</code>)</td></tr> <tr><td>rmdir(path[, options], callback)</td> <td>删除文件夹(<code>不包括文件</code>), 要获得类似于 <code>rm -rf</code> Unix 命令的行为, 使用<code>fs.rm</code></td></tr> <tr><td>rm(path[, options], callback)</td> <td>异步地删除文件和目录</td></tr> <tr><td>readdir(path[, options], callback)</td> <td>读取一个目录的目录结构, 回调会收到目录数组</td></tr> <tr><td>truncata(path, len, callback)</td> <td>截断文件, 将文件修改为指定的大小, 单位是字节, 截断中文可能会会乱码(一个字占3个字节)</td></tr> <tr><td>mkdirSync(path[, mode])</td> <td>创建一个文件夹(<code>目录</code>), <code>mode</code>可以为<code>{ recursive: true }</code>这样可以创建父目录</td></tr> <tr><td>renameSync(oldPath, newPath)</td> <td>对文件进行重命名, <code>oldPath</code>旧的路径, <code>newPath</code>新的路径</td></tr> <tr><td>watchFile(filename[, options], listener)</td> <td>监视文件的修改, <code>filename</code>要监视的文件, <code>listener</code>回调(当文件发生变化时调用), 参数为当前文件的状态, 修改前的文件状态</td></tr> <tr><td>copyFile(path1, path2)</td> <td>复制文件</td></tr></tbody></table> <p><code>fs</code>模块的API除了读取文件的内容格式需要注意一下, 其它对着文档用就行了</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> fs <span class="token keyword">from</span> <span class="token string">&quot;fs&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> path <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> __dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> packPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./package.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>packPath<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">err</span><span class="token operator">:</span> NodeJS<span class="token punctuation">.</span>ErrnoException <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> Buffer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理错误</span>
  <span class="token punctuation">}</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Buffer 数据</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用 toString() 方法转换为字符串数据</span>
  <span class="token comment">// 或者第二个可选的配置参数设置 encoding 为 &quot;utf-8&quot; 就会自动转换对应格式的数据</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> srcPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./src&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token literal-property property">stat</span><span class="token operator">:</span> fs<span class="token punctuation">.</span>Stats <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>srcPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stat<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文件相关信息</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 是否是文件</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 是否是目录</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>srcPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取一个目录下的所有文件</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>使用 <a href="http://nodejs.cn/api/util.html#utilpromisifyoriginal" target="_blank" rel="noopener noreferrer"><code>util.promisify</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>加工回调API为<code>Promise</code>格式</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> fs <span class="token keyword">from</span> <span class="token string">&quot;fs&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> path <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> util <span class="token keyword">from</span> <span class="token string">&quot;util&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> __dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pfs <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 利用 util.promisify 将文件读取加工成 Promise 形式</span>
    <span class="token literal-property property">readeFile</span><span class="token operator">:</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readFile<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> textPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./test.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// then 方法形式的使用</span>
pfs<span class="token punctuation">.</span><span class="token function">readeFile</span><span class="token punctuation">(</span>textPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// async + await 形式</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> pfs<span class="token punctuation">.</span><span class="token function">readeFile</span><span class="token punctuation">(</span>textPath<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">&quot;utf-8&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="readline"><a href="#readline" class="header-anchor">#</a> readline</h2> <p><a href="http://nodejs.cn/learn/accept-input-from-the-command-line-in-nodejs" target="_blank" rel="noopener noreferrer">readline<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>模块 每次一行地从可读流（例如 <code>process.stdin</code> 流, 在 Node.js 程序执行期间该流就是终端输入,）中获取输入或从文件可读流里获取内容</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> fs <span class="token keyword">from</span> <span class="token string">&quot;fs&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> readline <span class="token keyword">from</span> <span class="token string">&quot;readline&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> rl <span class="token operator">=</span> readline<span class="token punctuation">.</span><span class="token function">createInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">input</span><span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">&quot;./package.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ws <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">&quot;./package2.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;line&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">line</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">文件的单行内容: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>line<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token string">&quot;\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;读取结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> readline <span class="token keyword">from</span> <span class="token string">&quot;node:readline&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> rl <span class="token operator">=</span> readline<span class="token punctuation">.</span><span class="token function">createInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">input</span><span class="token operator">:</span> process<span class="token punctuation">.</span>stdin<span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> process<span class="token punctuation">.</span>stdout
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;我是估值一个亿的人工智能, 我可以回答你的问题: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;line&quot;</span><span class="token punctuation">,</span> <span class="token parameter">input</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">===</span> <span class="token string">&quot;exit&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rl<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> str <span class="token operator">=</span> input
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;吗&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;bye bye&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="path"><a href="#path" class="header-anchor">#</a> path</h2> <p>path 模块提供了一些用于处理文件路径的工具函数</p> <table><thead><tr><th>方法或属性名</th> <th>说明</th></tr></thead> <tbody><tr><td>sep</td> <td>作为路径段分隔符, 在 Windows 上是 <code>\</code>, 在 Linux/macOS 上是 <code>/</code></td></tr> <tr><td>delimiter</td> <td>作为路径定界符, 在 Windows 上是 <code>;</code>, 在 Linux/macOS 上是 <code>:</code></td></tr> <tr><td>basename()</td> <td>返回路径的最后一部分。 第二个参数可以过滤掉文件的扩展名</td></tr> <tr><td>dirname()</td> <td>返回路径的目录部分</td></tr> <tr><td>extname(path)</td> <td>返回路径中文件的后缀名, 即路径中最后一个<code>.</code>之后的部分<br>如果一个路径中并不包含<code>.</code>或该路径只包含一个<code>.</code> 且这个<code>.</code>为路径的第一个字符, 则此命令返回空字符串</td></tr> <tr><td>isAbsolute()</td> <td>判断是否是绝对路径, 返回布尔值</td></tr> <tr><td>parse()</td> <td>解析对象的路径为组成其的片段</td></tr> <tr><td>format()</td> <td>将<code>path.parse()</code>格式的对象转换为字符串路径<br>当向 <code>pathObject</code> 提供属性时，存在一个属性优先于另一个属性的组合: <br>如果提供 <code>pathObject.dir</code>，则忽略 <code>pathObject.root</code> <br>如果 <code>pathObject.base</code> 存在，则忽略 <code>pathObject.ext</code> 和 <code>pathObject.name</code></td></tr> <tr><td>resolve([from ...], to)</td> <td>将 <strong>to</strong> 参数解析为绝对路径, 给定的路径的序列是从右往左被处理的, 后面每个 <strong>path</strong> 被依次解析, 直到构造完成一个绝对路径<br>会把 <strong>/</strong> 或 <strong>\</strong> 开头的字符串片段解析成<strong>根目录</strong></td></tr> <tr><td>join(path1, path2[, ...])</td> <td>用于连接路径, 主要用途在于, 会正确使用当前系统的路径分隔符, Unix系统是**/<strong>, Windows系统是</strong>\**<br>对 <strong>/</strong> 或 <strong>\</strong> 开头的字符串片段只返回自身(<strong>不会解析成根路径</strong>)</td></tr> <tr><td>normalize(path)</td> <td>会尝试计算<strong>path</strong>实际的路径(归一化路径)</td></tr></tbody></table> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> path <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> __dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>sep<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>sep<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// /</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>delimiter<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>delimiter<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// :</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token string">&quot;/test/something&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// something</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token string">&quot;/test/something.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// something.txt</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span><span class="token string">&quot;/test/something&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// /test</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span><span class="token string">&quot;/test/something/file.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// /test/something</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span><span class="token string">&quot;index.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// .js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span><span class="token string">&quot;./package.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// .json</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span><span class="token string">&quot;/test/something&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span><span class="token string">&quot;./test/something&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// false</span>

<span class="token keyword">const</span> fileObj <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;/abc/hello/test.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fileObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">//   root: &quot;/&quot;, // 根路径</span>
<span class="token comment">//   dir: &quot;/abc/hello&quot;, // 从根路径开始的文件夹路径</span>
<span class="token comment">//   base: &quot;test.txt&quot;, // 文件名 + 扩展名</span>
<span class="token comment">//   ext: &quot;.txt&quot;, // 文件扩展名</span>
<span class="token comment">//   name: &quot;test&quot; // 文件名</span>
<span class="token comment">// }</span>


<span class="token comment">// 归一化</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token string">&quot;/users/joe/..//test.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \users\test.txt</span>


console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./src/index.ts&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// F:\project\auxiliary-util\src\index.ts</span>

<span class="token comment">// resolve 最后参数以 ./开头 表示当前目录正常拼接</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;/bar/foo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./baz&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// F:\bar\foo\baz</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;www&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;images/png/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;../gif/image.gif&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// F:\project\auxiliary-util\www\images\gif\image.gif</span>

<span class="token comment">// resolve 最后的参数以 /开头 表示从根路径开始处理</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;/foo/bar&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/tmp/file/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// F:\tmp\file</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;www&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;images/png/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/gif/image.gif&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// F:\gif\image.gif</span>


<span class="token comment">// join 使用系统的连接符连接路径</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./src/index.ts&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// F:\project\auxiliary-util\src\index.ts</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;/bar/foo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./baz&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \bar\foo\baz</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;www&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;images/png/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;../gif/image.gif&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// www\images\gif\image.gif</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;/foo/bar&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/tmp/file/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \foo\bar\tmp\file\</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;www&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;images/png/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/gif/image.gif&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// www\images\png\gif\image.gif</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><h2 id="os"><a href="#os" class="header-anchor">#</a> os</h2> <p>操作系统模块, 该模块提供了许多函数, 可用于从底层的操作系统和程序运行所在的计算机上检索信息并与其进行交互</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p><a href="http://nodejs.cn/learn/the-nodejs-os-module" target="_blank" rel="noopener noreferrer">Nodejs 操作系统模块<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>有一些有用的属性可以告诉我们一些与处理文件有关的关键事项：</p> <p><code>os.EOL</code> 可给出行定界符序列。 在 Linux 和 macOS 上为 <code>\n</code>, 在 Windows 上为 <code>\r\n</code></p> <p><code>os.constants.signals</code> 可告知所有与处理过程信号相关的常量, 例如 SIGHUP、SIGKILL 等</p> <p><code>os.constants.errno</code> 可设置用于错误报告的常量, 例如 EADDRINUSE、EOVERFLOW 等</p> <blockquote><p><a href="http://nodejs.cn/api/os.html#os_signal_constants" target="_blank" rel="noopener noreferrer">信号常量<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p><code>os.arch()</code></p> <p>返回标识底层架构的字符串, 例如 <code>arm</code>、<code>x64</code>、<code>arm64</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">arch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// x64</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>os.cpus()</code></p> <p>返回关于系统上可用的 CPU 的信息</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [{...},{...},...]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>os.endianness()</code></p> <p>根据是使用<a href="https://zh.wikipedia.org/wiki/%E5%AD%97%E8%8A%82%E5%BA%8F" target="_blank" rel="noopener noreferrer">大端序或小端序<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>编译 Node.js, 返回 <code>BE</code> 或 <code>LE</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">endianness</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// LE</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>os.freemem()</code></p> <p>返回代表系统中可用内存的字节数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">freemem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 8299479040</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>os.homedir()</code></p> <p>返回到当前用户的主目录的路径</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">homedir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// C:\Users\AOC</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>os.hostname()</code></p> <p>返回主机名</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">hostname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// DESKTOP-9QBQ1DF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>os.loadavg()</code></p> <p>返回操作系统对平均负载的计算, 这仅在 Linux 和 macOS 上返回有意义的值</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">loadavg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// windows 上没有意义 [ 0, 0, 0 ]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>os.networkInterfaces()</code></p> <p>返回系统上可用的网络接口的详细信息</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">networkInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {...}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>os.platform()</code></p> <p>返回为 Node.js 编译的平台：</p> <ul><li><code>darwin</code></li> <li><code>freebsd</code></li> <li><code>linux</code></li> <li><code>openbsd</code></li> <li><code>win32</code></li> <li>...等</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">platform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// win32</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>os.release()</code></p> <p>返回标识操作系统版本号的字符串</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10.0.19042</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>os.tmpdir()</code></p> <p>返回指定的临时文件夹的路径</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">tmpdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// C:\Users\AOC\AppData\Local\Temp</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>os.totalmem()</code></p> <p>返回表示系统中可用的总内存的字节数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">totalmem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 17045225472</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>os.type()</code></p> <p>标识操作系统：</p> <ul><li><code>Linux</code></li> <li>macOS 上为<code>Darwin</code></li> <li>Windows 上为 <code>Windows_NT</code></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Windows_NT</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>os.uptime()</code></p> <p>返回自上次重新启动以来计算机持续运行的秒数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">uptime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 177559</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>os.userInfo()</code></p> <p>返回包含当前 <code>username</code>, <code>uid</code>,<code>gid</code>,<code>shell</code> 和 <code>homedir</code> 的对象</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">userInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">{</span>
    <span class="token literal-property property">uid</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">gid</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'AOC'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">homedir</span><span class="token operator">:</span> <span class="token string">'C:\\Users\\AOC'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">shell</span><span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="events"><a href="#events" class="header-anchor">#</a> events</h2> <p>事件模块提供了 <strong>EventEmitter</strong> 类, 这是在 Nodejs 中处理事件的关键</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p><a href="http://nodejs.cn/learn/the-nodejs-events-module" target="_blank" rel="noopener noreferrer">Node事件模块<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>事件监听器返回及使用以下事件：</p> <ul><li>当监听器被添加时返回 <code>newListener</code></li> <li>当监听器被移除时返回 <code>removeListener</code></li></ul> <p><code>emitter.addListener()</code></p> <p><strong>emitter.on()</strong> 的别名</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>emitter<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span> handleEvent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 绑定 hello 事件</span>
<span class="token comment">// emitter.on('hello', handleEvent); // 绑定 hello 事件</span>

<span class="token comment">// 触发 hello 事件的回调</span>
<span class="token keyword">function</span> <span class="token function">handleEvent</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello 事件触发了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'收到的格式是: '</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>emitter.emit()</code></p> <p>触发事件, 按照事件被注册的顺序同步地调用每个事件监听器</p> <p>第一个参数是事件名, 后面携带参数即可</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span> <span class="token string">&quot;我是hello事件的参数&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>emitter.eventNames()</code></p> <p>返回字符串（表示在当前 <code>EventEmitter</code> 对象上注册的事件）数组：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>emitter<span class="token punctuation">.</span><span class="token function">eventNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ['hello']</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>emitter.getMaxListeners()</code></p> <p>获取可以添加到 <code>EventEmitter</code> 对象的监听器的最大数量（默认为 10, 但可以使用 <code>setMaxListeners(n)</code> 进行设置）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>emitter<span class="token punctuation">.</span><span class="token function">getMaxListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>emitter.listenerCount()</code></p> <p>获取作为参数传入的事件监听器的计数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>emitter<span class="token punctuation">.</span><span class="token function">listenerCount</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>emitter.listeners()</code></p> <p>获取作为参数传入的事件监听器的数组</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>emitter<span class="token punctuation">.</span><span class="token function">listeners</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ f ]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>emitter.off()</code></p> <p><strong>emitter.removeListener()</strong> 的别名, 新增于 Node.js 10</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>emitter<span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span> handleEvent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除事件</span>
<span class="token comment">// emitter.off('hello', handleEvent); // 删除事件</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>emitter<span class="token punctuation">.</span><span class="token function">eventNames</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// []</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>emitter.once()</code></p> <p>添加事件, 该事件只会被触发一次</p> <p><code>emitter.prependListener()</code></p> <p>当使用 <code>on</code> 或 <code>addListener</code> 添加监听器时, 监听器会被添加到监听器队列中的最后一个, 并且触发事件时是最后一个被调用的, 使用 <code>prependListener</code> 则可以在其他监听器之前添加并调用</p> <p><code>emitter.prependOnceListener()</code></p> <p>当使用 <code>once</code> 添加监听器时和<code>emitter.prependListener()</code>效果一样</p> <p><code>emitter.removeAllListeners()</code></p> <p>移除 <code>EventEmitter</code> 对象的所有监听特定事件的监听器</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 监听3个hello事件</span>
emitter<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span>handleEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
emitter<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span>handleEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
emitter<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span>handleEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">handleEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'事件处理函数'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 获取 hello 事件的数量</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>emitter<span class="token punctuation">.</span><span class="token function">listenerCount</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>

<span class="token comment">// 删除所有 hello 事件</span>
emitter<span class="token punctuation">.</span><span class="token function">removeAllListeners</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>emitter<span class="token punctuation">.</span><span class="token function">listenerCount</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>emitter.setMaxListeners()</code></p> <p>设置可以添加到 <code>EventEmitter</code> 对象的监听器的最大数量（默认为 10, 但可以增加或减少）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>emitter<span class="token punctuation">.</span><span class="token function">getMaxListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10</span>
<span class="token comment">// 修改监听器的最大数量</span>
emitter<span class="token punctuation">.</span><span class="token function">setMaxListeners</span><span class="token punctuation">(</span><span class="token number">999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>emitter<span class="token punctuation">.</span><span class="token function">getMaxListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 999</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="其他模块"><a href="#其他模块" class="header-anchor">#</a> 其他模块</h2> <table><thead><tr><th>模块名</th> <th>描述</th></tr></thead> <tbody><tr><td><a href="https://www.runoob.com/nodejs/nodejs-util.html" target="_blank" rel="noopener noreferrer"><code>util模块</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>node提供常用函数的集合</td></tr> <tr><td><a href="https://www.runoob.com/nodejs/nodejs-net-module.html" target="_blank" rel="noopener noreferrer"><code>net模块</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>用于底层的网络通信。提供了服务端和客户端的的操作</td></tr> <tr><td><a href="https://www.runoob.com/nodejs/nodejs-dns-module.html" target="_blank" rel="noopener noreferrer"><code>dns模块</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>用于解析域名</td></tr> <tr><td><a href="https://www.runoob.com/nodejs/nodejs-domain-module.html" target="_blank" rel="noopener noreferrer"><code>domain模块</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>简化异步代码的异常处理, 可以捕捉处理try catch无法捕捉的错误</td></tr></tbody></table> <h2 id="http"><a href="#http" class="header-anchor">#</a> http</h2> <p>http 模块专门用来创建 http 服务</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> http <span class="token keyword">from</span> <span class="token string">&quot;http&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">8888</span><span class="token punctuation">;</span>

<span class="token comment">// 创建一个 http 实例</span>
http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// console.log(&quot;请求对象&quot;, req);</span>
  <span class="token comment">// console.log(&quot;响应对象&quot;, res);</span>
  
  <span class="token keyword">const</span> urlObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http:127.0.0.1:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/index&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>urlObj<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 响应</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;hello index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;404 not found&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 监听 8888 端口</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">服务启动 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 端口</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><blockquote><p><a href="http://nodejs.cn/learn/the-nodejs-http-module" target="_blank" rel="noopener noreferrer">Nodejs http模块<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p><code>http.METHODS</code></p> <p>此属性列出了所有支持的 HTTP 方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token constant">METHODS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [</span>
<span class="token comment">//     'ACL',        'BIND',        'CHECKOUT',</span>
<span class="token comment">//     'CONNECT',    'COPY',        'DELETE',</span>
<span class="token comment">//     'GET',        'HEAD',        'LINK',</span>
<span class="token comment">//     'LOCK',       'M-SEARCH',    'MERGE',</span>
<span class="token comment">//     'MKACTIVITY', 'MKCALENDAR',  'MKCOL',</span>
<span class="token comment">//     'MOVE',       'NOTIFY',      'OPTIONS',</span>
<span class="token comment">//     'PATCH',      'POST',        'PRI',</span>
<span class="token comment">//     'PROPFIND',   'PROPPATCH',   'PURGE',</span>
<span class="token comment">//     'PUT',        'REBIND',      'REPORT',</span>
<span class="token comment">//     'SEARCH',     'SOURCE',      'SUBSCRIBE',</span>
<span class="token comment">//     'TRACE',      'UNBIND',      'UNLINK',</span>
<span class="token comment">//     'UNLOCK',     'UNSUBSCRIBE'</span>
<span class="token comment">// ]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>STATUS_CODES</code></p> <p>此属性列出了所有的 HTTP 状态代码及其描述</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token constant">STATUS_CODES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span>
  <span class="token string-property property">'100'</span><span class="token operator">:</span> <span class="token string">'Continue'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'101'</span><span class="token operator">:</span> <span class="token string">'Switching Protocols'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'102'</span><span class="token operator">:</span> <span class="token string">'Processing'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'103'</span><span class="token operator">:</span> <span class="token string">'Early Hints'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'200'</span><span class="token operator">:</span> <span class="token string">'OK'</span><span class="token punctuation">,</span>
   <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>http.globalAgent</code></p> <p>指向 Agent 对象的全局实例, 该实例是 <code>http.Agent</code> 类的实例</p> <p>用于管理 HTTP 客户端连接的持久性和复用, 它是 Node.js HTTP 网络的关键组件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>globalAgent<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Agent {</span>
<span class="token comment">//     _eventsCount: 2,</span>
<span class="token comment">//     _maxListeners: undefined,</span>
<span class="token comment">//     defaultPort: 80, </span>
<span class="token comment">//     protocol: 'http:',</span>
<span class="token comment">//     options: { path: null },</span>
<span class="token comment">//     requests: {},</span>
<span class="token comment">//     sockets: {},</span>
<span class="token comment">//     freeSockets: {},</span>
<span class="token comment">//     keepAliveMsecs: 1000,</span>
<span class="token comment">//     keepAlive: false,</span>
<span class="token comment">//     maxSockets: Infinity,</span>
<span class="token comment">//     maxFreeSockets: 256,</span>
<span class="token comment">//     scheduling: 'lifo',</span>
<span class="token comment">//     maxTotalSockets: Infinity,</span>
<span class="token comment">//     totalSocketCount: 0,</span>
<span class="token comment">//     ...</span>
<span class="token comment">// }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><code>http.createServer()</code></p> <p>返回 <code>http.Server</code> 类的新实例</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">http<span class="token punctuation">.</span>createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以给 server 实例 注册 <code>request</code> 事件, 当接收到请求就会触发回调</p> <p>回调的参数</p> <ul><li><p><code>request</code> 请求对象
请求对象可以获取客户端的一些请求信息</p></li> <li><p><code>response</code> 响应对象</p> <p>响应对象可以给客户端响应消息, 是一个可写流</p></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// request.url属性 获取请求端口号以后地址</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'收到客户端请求了, 地址是: '</span> <span class="token operator">+</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
        response.write方法 可以给客户端端发送响应数据
            write 方法可以使用多次, 但是最后一定要使用 end方法 来结束响应
                不然客户端就会一直等待
    */</span>
    <span class="token comment">// response.write('hello');</span>
    <span class="token comment">// response.write(' nodejs');</span>

    <span class="token comment">/*
        response.end方法 结束响应, 可以直接在括号里改定数据就不需要写 write方法了
            响应数据只能是 字符串 JSON 和二进制数据
    */</span> 
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'你好 nodejs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 绑定端口号, 启动服务, 调用回调   </span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器启动成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><code>http.request()</code></p> <p>发送 HTTP 请求到服务器, 并创建 <code>http.ClientRequest</code> 类的实例。</p> <p><code>http.get()</code></p> <p>类似于 <code>http.request()</code>, 但会自动地设置 HTTP 方法为 GET, 并自动地调用 <code>req.end()</code></p> <h3 id="类"><a href="#类" class="header-anchor">#</a> 类</h3> <p>HTTP 模块提供了 5 个类：</p> <ul><li><a href="http://nodejs.cn/api/http.html#class-httpagent" target="_blank" rel="noopener noreferrer"><code>http.Agent</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://nodejs.cn/api/http.html#class-httpclientrequest" target="_blank" rel="noopener noreferrer"><code>http.ClientRequest</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://nodejs.cn/api/http.html#class-httpserver" target="_blank" rel="noopener noreferrer"><code>http.Server</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://nodejs.cn/api/http.html#class-httpserverresponse" target="_blank" rel="noopener noreferrer"><code>http.ServerResponse</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://nodejs.cn/api/http.html#class-httpincomingmessage" target="_blank" rel="noopener noreferrer"><code>http.IncomingMessage</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p><code>http.Agent</code></p> <p>Nodejs 会创建 <code>http.Agent</code> 类的全局实例, 以管理 HTTP 客户端连接的持久性和复用, 这是 Nodejs HTTP 网络的关键组成部分, 该对象会确保对服务器的每个请求进行排队并且单个 socket 被复用, 出于性能原因, 它还维护一个 socket 池</p> <p><code>http.ClientRequest</code></p> <p>当 <code>http.request()</code> 或 <code>http.get()</code> 被调用时, 会创建 <code>http.ClientRequest</code> 对象</p> <p>当响应被接收时, 则会使用响应（<code>http.IncomingMessage</code> 实例作为<code>request</code>参数）来调用 <code>response</code> 事件</p> <p><code>http.Server</code></p> <p>当使用 <code>http.createServer()</code> 创建新的服务器时, 通常会实例化并返回此类</p> <p>拥有服务器对象后, 就可以访问其方法：</p> <ul><li><code>close()</code> 停止服务器不再接受新的连接</li> <li><code>listen()</code> 启动 HTTP 服务器并监听连接</li></ul> <p><code>http.ServerResponse</code></p> <p>由 <code>http.Server</code> 创建, 并作为<code>response</code>参数传给它触发的 <code>request</code> 事件</p> <p>必须在每个响应事件处理函数上调用 <code>end()</code>方法, 它会关闭响应, 当消息完成时服务器会将其发送给客户端</p> <p>与 HTTP 消息头进行交互的方法：</p> <ul><li><code>getHeaderNames()</code> 获取已设置的 HTTP 消息头名称的列表</li> <li><code>getHeaders()</code> 获取已设置的 HTTP 消息头的副本</li> <li><code>setHeader('headername', value)</code> 设置 HTTP 消息头的值</li> <li><code>getHeader('headername')</code> 获取已设置的 HTTP 消息头</li> <li><code>removeHeader('headername')</code> 删除已设置的 HTTP 消息头</li> <li><code>hasHeader('headername')</code> 如果响应已设置该消息头, 则返回 true</li> <li><code>headersSent()</code> 如果消息头已被发送给客户端, 则返回 true</li></ul> <p>在处理消息头之后, 可以通过调用 <code>response.writeHead()</code></p> <p>该方法接受 statusCode 作为第一个参数, 可选的状态消息和消息头对象, 将它们发送给客户端</p> <p>如果消息头还未被发送, 还可以手动赋值</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>response<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
response<span class="token punctuation">.</span>statusMessage <span class="token operator">=</span> <span class="token string">'内部服务器错误'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>http.IncomingMessage</code></p> <p><code>http.IncomingMessage</code> 对象可通过以下方式创建：</p> <ul><li><code>http.Server</code>, 当监听 <code>request</code> 事件时</li> <li><code>http.ClientRequest</code>, 当监听 <code>response</code> 事件时</li></ul> <p>它可以用来访问响应：</p> <ul><li>使用<code>statusCode</code>和<code>statusMessage</code> 方法来访问状态</li> <li>使用<code>headers()</code>或 <code>rawHeaders</code> 来访问消息头</li> <li>使用<code>method()</code>来访问 HTTP 方法</li> <li>使用<code>httpVersion()</code>来访问 HTTP 版本</li> <li>使用url()`来访问 URL</li> <li>使用<code>socket()</code>来访问底层的 socket</li></ul> <p>因为 <code>http.IncomingMessage</code> 实现了可读流接口, 因此数据可以使用流访问</p> <h3 id="mime"><a href="#mime" class="header-anchor">#</a> MIME</h3> <p>MIME 就是响应内容类型<code>Content-type</code></p> <p>在服务器端默认发送的数据是 <strong>utf-8</strong> 编码的, 浏览器时默认使用当前的操作系统的默认编码解析的,</p> <p>中文操作系统默认的编码是 <strong>gdk</strong>
在 http 协议中, 可以设置响应头里<code>Content-type</code>来指定对应的解码方式(一般都用 utf-8) 和文本类型</p> <p>具体的其他资源内容类型可以参考: https://www.runoob.com/http/http-content-type.html</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 普通文本</span>
res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span><span class="token string">'text/plain; charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// html格式的文本</span>
res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span><span class="token string">'text/html; charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// jpeg 图片数据</span>
<span class="token comment">// 图片资源不需要指定字符编码, 只有字符数据才需要指定编码</span>
res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span><span class="token string">'image/jpeg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可以使用<code>mime</code>包来判断需要的MIME类型</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> mime <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;mime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token string">&quot;/paht/hello/file.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;text/plain&quot;</span>
mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token string">&quot;file.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;text/plain&quot;</span>
mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token string">&quot;.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;application/javascript&quot;</span>
mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token string">&quot;html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;text/html&quot;</span>
mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token string">&quot;md&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;text/markdown&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>有的时候我们不需要客户端去打开响应内容, 比如附件下载, 这个时候可以使用<code>Content-Disposition</code>字段去控制, 该字段可以用来控制客户端是即时打开浏览还是下载附件, 内容查看对应<code>inline</code>, 数据为附件下载时<code>attachment</code>, 该字段还可以控制下载的文件名, 格式如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Content<span class="token operator">-</span>Disposition<span class="token operator">:</span> attachment<span class="token punctuation">;</span> filename<span class="token operator">=</span><span class="token string">&quot;filename.txt&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="zlib"><a href="#zlib" class="header-anchor">#</a> zlib</h2> <p>用于压缩文件, 可以减少数据传输的大小</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> fs <span class="token keyword">from</span> <span class="token string">&quot;fs&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> http <span class="token keyword">from</span> <span class="token string">&quot;http&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> zlib <span class="token keyword">from</span> <span class="token string">&quot;zlib&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">8888</span><span class="token punctuation">;</span>

<span class="token comment">// 获取 gzip</span>
<span class="token keyword">const</span> gzip <span class="token operator">=</span> zlib<span class="token punctuation">.</span><span class="token function">createGzip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 读取一个html文件</span>
  <span class="token keyword">const</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">&quot;./index.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 写入响应和响应头同样和 end方法一样只能调用一次</span>
  res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;Content-Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text/html; charset=utf-8&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 指定MIME和字符集不然会乱码</span>
    <span class="token string-property property">&quot;Content-Encoding&quot;</span><span class="token operator">:</span> <span class="token string">&quot;gzip&quot;</span> <span class="token comment">// 指定压缩格式</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  rs<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gzip<span class="token punctuation">)</span> <span class="token comment">// 压缩后传输指定的流</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">服务启动 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 端口</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="url"><a href="#url" class="header-anchor">#</a> url</h2> <p>用于解析url路径</p> <h3 id="旧版api"><a href="#旧版api" class="header-anchor">#</a> 旧版API</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> urlStr <span class="token operator">=</span> <span class="token string">&quot;http://example.com:8080/one/two?a=1&amp;b=2&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 将url转换为对象</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>urlStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// const obj = url.parse(urlStr, true);</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">//   protocol: 'http:',</span>
<span class="token comment">//   slashes: true,</span>
<span class="token comment">//   auth: null,</span>
<span class="token comment">//   host: 'example.com:8080',</span>
<span class="token comment">//   port: '8080',</span>
<span class="token comment">//   hostname: 'example.com',</span>
<span class="token comment">//   hash: null,</span>
<span class="token comment">//   search: '?a=1&amp;b=2',</span>
<span class="token comment">//   query: 'a=1&amp;b=2', // url.parse() 第二个参数为true时会将其解析成对象, 变成: { a: '1', b: '2' }</span>
<span class="token comment">//   pathname: '/one/two',</span>
<span class="token comment">//   path: '/one/two?a=1&amp;b=2',</span>
<span class="token comment">//   href: 'http://example.com:8080/one/two?a=1&amp;b=2'</span>
<span class="token comment">// }</span>

<span class="token comment">// 将对象转换为url</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// http://example.com:8080/one/two?a=1&amp;b=2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="新版api"><a href="#新版api" class="header-anchor">#</a> 新版API</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> url <span class="token keyword">from</span> <span class="token string">&quot;url&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> urlObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">&quot;/two&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://example.com:8080/one?a=1&amp;b=2#hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>urlObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// URL {</span>
<span class="token comment">//   href: 'http://example.com:8080/one/two?a=1&amp;b=2#hello',</span>
<span class="token comment">//   origin: 'http://example.com:8080',</span>
<span class="token comment">//   protocol: 'http:',</span>
<span class="token comment">//   username: '',</span>
<span class="token comment">//   password: '',</span>
<span class="token comment">//   host: 'example.com:8080',</span>
<span class="token comment">//   hostname: 'example.com',</span>
<span class="token comment">//   port: '8080',</span>
<span class="token comment">//   pathname: '/one/two',</span>
<span class="token comment">//   search: '?a=1&amp;b=2',</span>
<span class="token comment">//   searchParams: URLSearchParams { 'a' =&gt; '1', 'b' =&gt; '2' },</span>
<span class="token comment">//   hash: '#hello'</span>
<span class="token comment">// }</span>

<span class="token comment">// url请求参数是一个迭代器对象</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>urlObj<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>


<span class="token comment">// 遍历了所有的查询参数</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> urlObj<span class="token punctuation">.</span>searchParams<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;key: &quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;value: &quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 可以对其拼接参数</span>
urlObj<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 或设置一些其他参数</span>
urlObj<span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
urlObj<span class="token punctuation">.</span>password <span class="token operator">=</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">;</span>


<span class="token comment">// 使用 url.format 同样可以将其转换为url字符串 </span>
url<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>urlObj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">auth</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 用户名密码格式</span>
  <span class="token literal-property property">fragment</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// </span>
  <span class="token literal-property property">search</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 搜索字符串</span>
  <span class="token literal-property property">unicode</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// Unicode 编码转换</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// http://hello:123456@example.com:8080/one/two?a=1&amp;b=2&amp;c=3#hello</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h3 id="转换格式api"><a href="#转换格式api" class="header-anchor">#</a> 转换格式API</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> url <span class="token keyword">from</span> <span class="token string">&quot;url&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// file协议 转换为系统路径格式</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">&quot;file:///C:/path/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 错误 /C:/path/</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">fileURLToPath</span><span class="token punctuation">(</span><span class="token string">&quot;file:///C:/path/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 正确 C:\path\</span>

<span class="token comment">// 系统路径格式转换为 file协议</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">&quot;file#1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;file:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 错误 file:///file#1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">pathToFileURL</span><span class="token punctuation">(</span><span class="token string">&quot;file#1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 正确 file:///F:/project/auxiliary-util/file%231</span>

<span class="token keyword">const</span> myUrl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">&quot;https://a:b@测试?abc#f00&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">urlToHttpOptions</span><span class="token punctuation">(</span>myUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">//   protocol: 'https:',</span>
<span class="token comment">//   hostname: 'xn--0zwm56d',</span>
<span class="token comment">//   hash: '#f00',</span>
<span class="token comment">//   search: '?abc',</span>
<span class="token comment">//   pathname: '/',</span>
<span class="token comment">//   path: '/?abc',</span>
<span class="token comment">//   href: 'https://a:b@xn--0zwm56d/?abc#f00',</span>
<span class="token comment">//   auth: 'a:b'</span>
<span class="token comment">// }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><blockquote><p>使用<code>fileURLToPath</code>和<code>pathToFileURL</code>会正确的进行编码网址控制字符</p></blockquote> <h2 id="querystring"><a href="#querystring" class="header-anchor">#</a> querystring</h2> <p>用于转换查询字符串参数</p> <h3 id="parse-和-encode"><a href="#parse-和-encode" class="header-anchor">#</a> parse 和 encode</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> queryString <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;querystring&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token string">&quot;a=1&amp;b=2&amp;id=001&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> query <span class="token operator">=</span> queryString<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 转换查询字符串为对象</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { a: '1', b: '2', id: '001' }</span>
<span class="token comment">// 对象转换为查询字符串</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>queryString<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// a=1&amp;b=2&amp;id=001</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="escape-和-unescape"><a href="#escape-和-unescape" class="header-anchor">#</a> escape 和 unescape</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> queryString <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;querystring&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token string">&quot;&lt;script&gt;console.log('恶意代码')&lt;/script&gt;&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> query <span class="token operator">=</span> queryString<span class="token punctuation">.</span><span class="token function">escape</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 转义url中的一些特殊字符</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// %3Cscript%3Econsole.log('%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81')%3C%2Fscript%3E</span>

<span class="token comment">// 转换回来</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>queryString<span class="token punctuation">.</span><span class="token function">unescape</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;script&gt;console.log('恶意代码')&lt;/script&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="buffer"><a href="#buffer" class="header-anchor">#</a> Buffer</h2> <p>Buffer(缓冲区) 的结构和数组很像, 操作方法和数组类似</p> <p>数组中不能存储二进制文件, 而 Buffer 就是专门用来存储二进制数据的</p> <p>使用 Buffer 不需要引入模块, 直接使用,</p> <p>在 Buffer 中存储的都是二进制数据, 但是在显示时是以16进制显示的</p> <p>它由 Nodejs <a href="http://nodejs.cn/api/buffer.html#buffer" target="_blank" rel="noopener noreferrer">Buffer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>类实现</p> <h3 id="buffer的作用"><a href="#buffer的作用" class="header-anchor">#</a> Buffer的作用</h3> <p>Buffer 被引入用以帮助开发者处理二进制数据, 在传统生态上js只处理字符串而不是二进制数据</p> <p>Buffer 与流紧密相连, 当流处理器接收数据的速度<strong>快于</strong>其消化的速度时, 则会将数据放入 buffer 中</p> <p>在现实场景就是: 在线观看视频时预先加载后面的内容(<strong>白色的进度条</strong>), 即下载数据的速度比查看数据的速度快, 且浏览器会对数据进行缓冲</p> <p><code>Buffer.from(str)</code></p> <p>将一个字符串转换为 Buffer</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token string">&quot;hello buffer&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 将字符串转换为 Buffer 数据</span>
<span class="token keyword">const</span> buf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Buffer 68 65 6c 6c 6f 20 62 75 66 66 65 72&gt;</span>

<span class="token comment">// 将 Buffer 数据转换为字符串</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hello buffer (默认utf8)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;hex&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 68656c6c6f20627566666572</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;base64&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// aGVsbG8gYnVmZmVy</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>buffer 数据的显示都是以16进制显示的, 需要使用 <code>tostring</code> 方法来进行转换</p></blockquote> <p><code>Buffer.alloc(size)</code></p> <p>创建一个指定大小(以字节为单位)的 Buffer, 使用零进行初始化</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> buf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Buffer 00 00 00 00 ...&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>Buffer.allocUnsafe(size)</code></p> <p>创建一个指定大小(以字节为单位)的 Buffer, 不会被初始化, 可能会包含敏感数据</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 每次创建的 Buffer数据都不一样</span>
<span class="token keyword">const</span> buf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">allocUnsafe</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Buffer d8 2e db 9f f6 01 ...&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>当 <code>Buffer</code> 内存被读取时, 如果内存中存在较旧的数据, 则可以被访问或泄漏</p> <p>这就是真正使 <code>allocUnsafe</code> 不安全的原因, 在使用它时必须格外小心</p></blockquote> <h3 id="访问-buffer-的内容"><a href="#访问-buffer-的内容" class="header-anchor">#</a> 访问 buffer 的内容</h3> <p>可以像数组一样被访问</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token string">&quot;abcde&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> buf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 下标操作访问</span>
buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">65</span><span class="token punctuation">;</span> <span class="token comment">// 对应 A</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 98</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5</span>

<span class="token comment">// 循环</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> b <span class="token keyword">of</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出对应的 Unicode 码</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Abcde</span>

<span class="token comment">// 会覆盖之前的数据</span>
buf<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;ooo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ooode</span>

<span class="token comment">// 截取 Buffer</span>
<span class="token keyword">const</span> newBuf <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newBuf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// de</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>这些数字是 <strong>Unicode</strong> 码, 用于标识 buffer 位置中的字符</p> <h4 id="buffer-字符编码"><a href="#buffer-字符编码" class="header-anchor">#</a> Buffer 字符编码</h4> <p>通过使用字符编码, 可实现 Buffer 实例与 JavaScript 字符串之间的相互转换, 目前所支持的字符编码如下所示：</p> <ul><li>‘<strong>ascii</strong>’ - 仅适用于 7 位 ASCII 数据。此编码速度很快, 如果设置则会剥离高位。</li> <li>‘<strong>utf8</strong>’ - 多字节编码的 Unicode 字符。许多网页和其他文档格式都使用 UTF-8,(不指定编码为<code>utf-8</code>)</li> <li>‘<strong>utf16le</strong>’ - 2 或 4 个字节, 小端序编码的 Unicode 字符。支持代理对（U+10000 至 U+10FFFF）。</li> <li>‘<strong>ucs2</strong>’ - ‘utf16le’ 的别名。</li> <li>‘<strong>base64</strong>’ - Base64 编码。当从字符串创建 Buffer 时, 此编码也会正确地接受 RFC 4648 第 5 节中指定的 “URL 和文件名安全字母”。</li> <li>‘<strong>latin1</strong>’ - 一种将 Buffer 编码成单字节编码字符串的方法（由 RFC 1345 中的 IANA 定义, 第 63 页, 作为 Latin-1 的补充块和 C0/C1 控制码）。</li> <li>‘<strong>binary</strong>’ - ‘latin1’ 的别名。</li> <li>‘<strong>hex</strong>’ - 将每个字节编码成两个十六进制的字符。</li></ul> <h3 id="复制-buffer"><a href="#复制-buffer" class="header-anchor">#</a> 复制 buffer</h3> <p>使用<code>copy()</code>可以复制 buffer</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> buf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个12字节长度的空buffer</span>
<span class="token keyword">const</span> bufCopy <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 复制 buf 到 bufCopy</span>
buf<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>bufCopy<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 查看结果</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hello</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bufCopy<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hello</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>默认情况下, 会复制整个 buffer, 另外的 3 个参数可以定义<strong>开始位置、新的buffer偏移位置、<strong>以及</strong>新的 buffer 长度</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> buf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个12字节长度的空buffer</span>
<span class="token keyword">const</span> bufCopy <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 复制 buf 到 bufCopy, 长度是依据被复制的buffer来算的</span>
buf<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>bufCopy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 查看结果</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hello</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bufCopy<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// el</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="切片buffer"><a href="#切片buffer" class="header-anchor">#</a> 切片buffer</h3> <p>如果要创建 buffer 的局部数据, 则可以创建切片,  <strong>切片不是副本</strong>, 原始 buffer 仍然是真正的来源, 如果原始 buffer改变了, 则切片数据也会改变</p> <p>和数组的切片方法类似, 也是使用 <code>slice()</code>,  第一个参数是起始位置, 可以指定第二个参数作为结束位置</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> buf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> bufSlice <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bufSlice<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hello </span>

<span class="token comment">// 负数规则和数组的 slice 一样</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hel</span>

<span class="token comment">// 修改切片的buffer</span>
bufSlice<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">104</span><span class="token punctuation">;</span>
bufSlice<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">104</span><span class="token punctuation">;</span>

<span class="token comment">// 修改后源数据和切片数据都会改变</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hhhlo</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bufSlice<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hhhlo</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="stream"><a href="#stream" class="header-anchor">#</a> stream</h2> <h3 id="什么是流"><a href="#什么是流" class="header-anchor">#</a> 什么是流</h3> <p>流是为 Nodejs 应用程序提供动力的基本概念之一</p> <p>它们是一种以高效的方式处理读/写文件、网络通信、或任何类型的端到端的信息交换</p> <p>流不是 Nodejs 特有的概念, 是在几十年前 Unix 操作系统中引入的, 程序可以通过管道运算符<code>|</code>对流进行交互</p> <p>例如, 在传统的方式中, 当告诉程序读取文件时, 这会将文件从头到尾读入内存, 然后进行处理</p> <p>如果使用流的方式, 则可以逐个片段地读取并处理, 而无需全部保存在内存中</p> <p>Node.js 的 <a href="http://nodejs.cn/api/stream.html" target="_blank" rel="noopener noreferrer"><code>stream</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 模块 提供了构建所有流 API 的基础。 所有的流都是 <a href="http://nodejs.cn/api/events.html#events_class_eventemitter" target="_blank" rel="noopener noreferrer">EventEmitter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的实例</p> <h3 id="流的优点"><a href="#流的优点" class="header-anchor">#</a> 流的优点</h3> <ul><li><strong>内存效率</strong>: 无需加载大量的数据到内存中即可进行处理</li> <li><strong>时间效率</strong>: 当获得数据之后就可以开始处理数据, 这样所需的时间更少, 而不必等到整个数据加载完成后可用</li></ul> <blockquote><p><a href="http://nodejs.cn/learn/nodejs-streams" target="_blank" rel="noopener noreferrer">Nodejs 流<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h3 id="使用流读取和写入文件"><a href="#使用流读取和写入文件" class="header-anchor">#</a> 使用流读取和写入文件</h3> <p>使用流读取文件适用于一些比较大的文件, 会持续的读取和写入文件</p> <p><code>fs.createReadStream(path)</code></p> <p>根据给定的路径创建一个<strong>可读流</strong>对象并返回(不存在对应的文件会报错)</p> <p>可读流事件:</p> <ul><li>open 打开文件</li> <li>data 当有数据可读时触发。</li> <li>error 在读收和写入过程中发生错误时触发。</li> <li>close 关闭文件</li> <li>end 没有更多的数据可读时触发</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 大文件的读取不适合使用普通的fsAPI, 容易导致内存溢出, 使用流为最佳</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> fs <span class="token keyword">from</span> <span class="token string">&quot;fs&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> path <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> __dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 可读流 </span>
<span class="token keyword">const</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./assets/test.zip&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;可读流打开了文件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;可读流读取完成&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;可读流关闭了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 取消可读流</span>
  rs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>可读流可以在http模块中使用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> http <span class="token keyword">from</span> <span class="token string">&quot;http&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> fs <span class="token keyword">from</span> <span class="token string">&quot;fs&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> path <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 可读流 </span>
  <span class="token keyword">const</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./data.text&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 使用 pipe方法 </span>
  rs<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>当要发送的数据块已获得时就立即开始将其流式传输到 HTTP 客户端, 而不是等待直到文件被完全读取</p> <p><code>pipe()</code></p> <p>可以在文件流上调用 <code>pipe()</code> 方法, 在来源流上调用它, 它会获取自动来源流, 并将其通过管道传输到目标流</p> <p><code>pipe()</code> 方法的返回值是目标流, 这使得可以链式多个调用<code>pipe()</code>如下所示</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>src<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>dest1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>dest2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 相当于</span>
src<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>dest1<span class="token punctuation">)</span><span class="token punctuation">;</span>
dest1<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>dest2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p><code>pipe()</code>传输流是异步的</p></blockquote> <p><code>fs.createWriteStream(path)</code></p> <p>根据给定的路径创建一个<strong>可写流</strong>对象并返回(不存在对应的文件时会被创建)</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 大文件的写入也同样使用流为最佳</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> fs <span class="token keyword">from</span> <span class="token string">&quot;fs&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> path <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> __dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 可读流 </span>
<span class="token keyword">const</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./assets/test.zip&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 可写流</span>
<span class="token keyword">const</span> ws <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./assets/test2.zip&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 通过 write方法可以同步的向可写流向文件中写入内容</span>
ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;通过可写流写入的内容\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;通过可写流写入的第二次内容\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;最后一行就不写了\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 通过 pipe方法 将可读流传输到可写流里</span>
rs<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span>

ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;write方法写入的数据永远在pipe方法传输的数据前面(同步)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;读取完成&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 关闭流</span>
  ws<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="流驱动的-node-js-api"><a href="#流驱动的-node-js-api" class="header-anchor">#</a> 流驱动的 Node.js API</h3> <p>标准输入流</p> <p>由于流的优点, 许多 Nodejs 核心模块都提供了原生的流处理功能, 最值得注意的有：</p> <ul><li><code>process.stdin</code> 返回连接到 <strong>stdin</strong> 的流(<code>标准输入流</code>)</li> <li><code>process.stdout</code> 返回连接到 <strong>stdout</strong> 的流(<code>标准输出流</code>)</li> <li><code>process.stderr</code> 返回连接到 <strong>stderr</strong> 的流(<code>标准错误流</code>)</li> <li><code>fs.createReadStream()</code> 创建文件的可读流</li> <li><code>fs.createWriteStream()</code> 创建到文件的可写流</li> <li><code>net.connect()</code> 启动基于流的连接</li> <li><code>http.request()</code> 返回 <strong>http.ClientRequest</strong> 类的实例, 该实例是可写流</li> <li><code>zlib.createGzip()</code> 使用 <strong>gzip</strong>（压缩算法）将数据压缩到流中</li> <li><code>zlib.createGunzip()</code> 解压缩 <strong>gzip</strong> 流</li> <li><code>zlib.createDeflate()</code> 使用 <strong>deflate</strong>（压缩算法）将数据压缩到流中</li> <li><code>zlib.createInflate()</code> 解压缩 <strong>deflate</strong> 流</li></ul> <h3 id="不同类型的流"><a href="#不同类型的流" class="header-anchor">#</a> 不同类型的流</h3> <p>流分为四类：</p> <ul><li><code>Readable</code>(可读流): 可以通过管道读取、但不能通过管道写入的流（可以接收数据, 但不能向其发送数据）, 当推送数据到可读流中时, 会对其进行缓冲, 直到使用者开始读取数据为止</li> <li><code>Writable</code>(可写流): 可以通过管道写入、但不能通过管道读取的流（可以发送数据, 但不能从中接收数据）</li> <li><code>Duplex</code>(双工流): 可以通过管道写入和读取的流, 基本上相对于是可读流和可写流的组合</li> <li><code>Transform</code>(转换流): 类似于双工流、但其输出是其输入的转换的转换流</li></ul> <h4 id="自定义创建可读流"><a href="#自定义创建可读流" class="header-anchor">#</a> 自定义创建可读流</h4> <p>从 <a href="http://nodejs.cn/api/stream.html#stream" target="_blank" rel="noopener noreferrer"><code>stream</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 模块获取可读流类<a href="http://nodejs.cn/api/stream.html#class-streamreadable" target="_blank" rel="noopener noreferrer"><code>Readable</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, 对其进行初始化并实现 <code>readable._read()</code> 方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> stream <span class="token keyword">from</span> <span class="token string">&quot;stream&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 实例化</span>
<span class="token keyword">const</span> readableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">stream<span class="token punctuation">.</span>Stream<span class="token punctuation">.</span>Readable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>实现 <code>_read</code> 方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>readableStream<span class="token punctuation">.</span><span class="token function-variable function">_read</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也可以在构造时传入<code>read</code>选项来实现<code>_read</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> readableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stream<span class="token punctuation">.</span>Readable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>初始化完毕, 使用<code>push</code>方法发送数据到可读流</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>readableStream<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
readableStream<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'world'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="自定义创建可写流"><a href="#自定义创建可写流" class="header-anchor">#</a> 自定义创建可写流</h4> <p>若要创建可写流, 需要实例化 <a href="http://nodejs.cn/api/stream.html#class-streamwritable" target="_blank" rel="noopener noreferrer"><code>Writable</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 类, 并实现其 <code>_write()</code> 方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>writableStream<span class="token punctuation">.</span><span class="token function-variable function">_write</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>同样可以在构造时传入 <code>write</code> 选项</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> writableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stream<span class="token punctuation">.</span>Writable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="从自定义可读流中获取数据"><a href="#从自定义可读流中获取数据" class="header-anchor">#</a> 从自定义可读流中获取数据</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Stream <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> readableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stream<span class="token punctuation">.</span>Readable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> writableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stream<span class="token punctuation">.</span>Writable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// chunk 数据块, encoding 编码 next函数用于放行</span>
    <span class="token function">write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 打印收到的数据块</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 通过 pipe方法 传输数据到可写流里</span>
readableStream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>writableStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 发送数据到可读流</span>
readableStream<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
readableStream<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'world'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>也可以使用 <code>readable</code> 事件直接地消费可读流</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>readableStream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'readable'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> readableStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Buffer 68 65 6c 6c 6f 77 6f 72 6c 64&gt;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// helloworld</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>使用可写流的 <code>write()</code> 方法发送数据到可写流</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>writableStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'hey!\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用<code>end()</code>方法来结束可写流</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>writableStream<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'结束'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="crypto"><a href="#crypto" class="header-anchor">#</a> crypto</h2> <p><a href="http://nodejs.cn/api/crypto.html" target="_blank" rel="noopener noreferrer"><code>crypto模块</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是 Node.js 内置的密码模块, 封装了一些密码处理方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> crypto <span class="token keyword">from</span> <span class="token string">&quot;crypto&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>摘要算法</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> cipher <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">&quot;md5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定算法</span>
<span class="token comment">/**
 * update方法, 可以多次调用
 * 第一个参数表示要加密的数据, 必须是字符串格式
 * 第二参数表示要传入数据的格式, 可以是&quot;utf8&quot;, &quot;binary&quot;, &quot;ascii&quot;, &quot;latin1&quot;, 默认: &quot;utf8&quot;
 * 第三个参数表示要加密数据的输出格式, 可以是&quot;latin1&quot;,  &quot;base64&quot; 或者 &quot;hex&quot;, 没有则返回Buffer
 */</span>
cipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;张三&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 指定输出的加密格式, </span>
<span class="token keyword">const</span> md5 <span class="token operator">=</span> cipher<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">&quot;base64&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>md5<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// RChFS9qOBovOqHnadv2tRA==</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>hmac 算法</strong></p> <p>hmac算法, 增强版的摘要算法, 需要一个密钥(也叫做<strong>盐</strong>)</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> crypto <span class="token keyword">from</span> <span class="token string">&quot;crypto&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> secret <span class="token operator">=</span> <span class="token string">&quot;密钥&quot;</span>
<span class="token comment">// 使用 createHmac方法, 指定为 sha256 算法, 然后给定一个密钥</span>
<span class="token keyword">const</span> hmacsha256 <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">&quot;sha256&quot;</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 加密数据</span>
hmacsha256<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hmacsha256<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;append data1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hmacsha256<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;append data2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 加密后的格式为 hex</span>
<span class="token keyword">const</span> pwd <span class="token operator">=</span> hmacsha256<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">&quot;hex&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pwd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1433c412d4400ff24832a79305a5be8a4bdde65ff03042cc8e68e254d43fe17a</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>对称加密</strong></p> <p>对称加密是一种双向加密算法, 跟摘要算法的单向加密不同, 它是支持加解密的, 通过配备一个<code>密钥</code>完成</p> <p>AES 是对称加密的一种, 常见算法有 <code>aes192</code> <code>aes-128-ecb</code> <code>aes-256-cbc</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> crypto <span class="token keyword">from</span> <span class="token string">&quot;crypto&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> dataJson <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;张三&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> key <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化密钥(16为字节)</span>
<span class="token keyword">const</span> iv <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化向量(16为字节)</span>

<span class="token comment">// 加密</span>
<span class="token keyword">const</span> <span class="token function-variable function">encrypt</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cipher <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createCipheriv</span><span class="token punctuation">(</span><span class="token string">&quot;aes-128-cbc&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 加密数据格式为 utf8, 输出加密格式为 hex</span>
    <span class="token comment">// 调用了 cipher.final() 方法，则 Cipher 对象就不能再用于加密数据, 多次调用 cipher.final() 将导致抛出错误 </span>
    <span class="token keyword">return</span> cipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">&quot;utf8&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hex&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> cipher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span><span class="token string">&quot;hex&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;加密失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> e<span class="token punctuation">.</span>message <span class="token operator">||</span> e<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 加密数据</span>
<span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> dataJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 30ea685209dd3fce13aa8e90a147d475ed42922aaff8faefd0cd2fb569dd0e25</span>

<span class="token comment">// 解密</span>
<span class="token keyword">const</span> <span class="token function-variable function">decipher</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> crypted</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ciphed <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createDecipheriv</span><span class="token punctuation">(</span><span class="token string">&quot;aes-128-cbc&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 解密数据格式为 hex, 输出解密格式为 utf8</span>
    <span class="token keyword">return</span> ciphed<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>crypted<span class="token punctuation">,</span> <span class="token string">&quot;hex&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;utf8&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> ciphed<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span><span class="token string">&quot;utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;解密失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> e<span class="token punctuation">.</span>message <span class="token operator">||</span> e<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> dataStr <span class="token operator">=</span> <span class="token function">decipher</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dataStr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {&quot;id&quot;:1,&quot;name&quot;:&quot;张三&quot;}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h2 id="child-process"><a href="#child-process" class="header-anchor">#</a> child_process</h2> <p><a href="http://nodejs.cn/api/child_process.html" target="_blank" rel="noopener noreferrer">child_process<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是 Node.js 的内置模块, 用于创建子进程</p> <h2 id="开发环境与生产环境"><a href="#开发环境与生产环境" class="header-anchor">#</a> 开发环境与生产环境</h2> <p><strong>在 Node 中可以为生产环境和开发环境使用不同的配置</strong></p> <p>Node.js 假定其始终运行在开发环境中, 可以通过设置 <code>NODE_ENV=production</code> 环境变量来向 Node.js 发出正在生产环境中运行的信号</p> <p>通常通过在 <strong>shell</strong> 中执行以下命令来完成</p> <p>设置 Windows 中的环境变量</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>SET <span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>production <span class="token comment"># 设置为生产环境</span>
SET <span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>development <span class="token comment"># 设置为开发环境</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>设置 Linux 中的环境变量</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>production <span class="token comment"># 设置为生产环境</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>development <span class="token comment"># 设置为开发环境</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>未设置环境变量时默认为<code>undefined</code></p></blockquote> <p>但最好将其放在的 shell 配置文件中（例如, 使用 Bash shell 的 <code>.bash_profile</code>）, 否则当系统重启时, 该设置不会被保留</p> <p>也可以通过将环境变量放在应用程序的初始化命令之前来应用它</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>production <span class="token function">node</span> app.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>设置环境为 <code>production</code> 通常可以确保：</p> <ul><li>日志记录保持在最低水平</li> <li>更高的缓存级别以优化性能</li></ul> <p><strong>可以使用条件语句在不同的环境中执行代码</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 开发环境代码</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 生产环境代码</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;production&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;staging&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>例如, 在 Express 应用中, 可以使用此工具为每个环境设置不同的错误处理程序</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">errorHandler</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">dumpExceptions</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">showStack</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">errorHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="断点调试"><a href="#断点调试" class="header-anchor">#</a> 断点调试</h2> <p>node 中的断点调试直接添加断点然后<code>node xxx</code>是不会生效的, 需要设置环境, 以 VS Code 为例, 先生成配置文件<code>运行 -&gt; 添加配置</code>会生成一个<code>.vscode</code>目录里面有一个<code>launch.json</code>配置文件, 里面可以设置<a href="https://code.visualstudio.com/docs/nodejs/nodejs-debugging#_launch-configuration-attributes" target="_blank" rel="noopener noreferrer">很多字段<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, 通过设置<code>program</code>字段, 这个字段可以配置需要调试的文件, 支持字符串目录, 也可以使用变量<code>${file}</code>(表示当前打开的文件)</p> <blockquote><p>了解更多可以见<a href="https://code.visualstudio.com/docs/nodejs/nodejs-debugging" target="_blank" rel="noopener noreferrer">VSCode 中的Node 调试<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h2 id="错误处理"><a href="#错误处理" class="header-anchor">#</a> 错误处理</h2> <p>Node.js 中的错误通过异常进行处理</p> <h3 id="创建异常"><a href="#创建异常" class="header-anchor">#</a> 创建异常</h3> <p>使用 <code>throw</code> 关键字创建异常</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">throw</span> value<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>一旦 JavaScript 执行到此行, 则常规的程序流会被停止, 且控制会被交给最近的异常处理程序</p> <p>通常, 在客户端代码中, <code>value</code> 可以是任何 JavaScript 值（包括字符串、数字、或对象）</p> <p>在 Node.js 中, 一般不抛出字符串, 而仅抛出 <code>Error</code> 对象</p> <h3 id="错误对象"><a href="#错误对象" class="header-anchor">#</a> 错误对象</h3> <p>错误对象是 Error 对象的实例、或者继承自 Error 类, 由 <a href="http://nodejs.cn/api/errors.html#errors" target="_blank" rel="noopener noreferrer">Error<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 核心模块提供</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;错误信息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// or</span>

<span class="token keyword">class</span> <span class="token class-name">myError</span> <span class="token keyword">extends</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
<span class="token punctuation">}</span>
<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">myError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="处理异常"><a href="#处理异常" class="header-anchor">#</a> 处理异常</h3> <p>异常处理程序是 <code>try/catch</code> 语句, 与客户端一致</p> <h3 id="捕获未捕获的异常"><a href="#捕获未捕获的异常" class="header-anchor">#</a> 捕获未捕获的异常</h3> <p>如果在程序执行过程中引发了未捕获的异常, 则程序会崩溃</p> <p>若要解决此问题, 则监听 <code>process</code> 对象上的 <code>uncaughtException</code> 事件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;uncaughtException&quot;</span><span class="token punctuation">,</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'有一个未捕获的错误'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 强制性的退出 shell</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>Node 在处理异常是约定了, 将异常作为回调函数的第一个实参传回, 如果为空则表示此次调用没有异常</p></blockquote> <h3 id="promise-异常"><a href="#promise-异常" class="header-anchor">#</a> Promise 异常</h3> <p>和客户端一致使用<code>.catch</code>子句或者<code>try/catch</code>语句</p> <h2 id="node-js-中记录对象"><a href="#node-js-中记录对象" class="header-anchor">#</a> Node.js 中记录对象</h2> <p>在 Node.js 中 <code>console.log()</code>控制台打印输出对象的信息, 对象结构在经过两个级别的嵌套后, Node.js 会放弃展开并打印 <code>[Object]</code> 作为占位符</p> <p>可以使用 <code>JSON.stringify</code> 进行转义后再打印</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 都可以</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>或者可以修改<code>util</code>模块的<a href="http://nodejs.cn/api/util.html#utilinspectdefaultoptions" target="_blank" rel="noopener noreferrer"><code>defaultOptions</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>配置</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>inspect<span class="token punctuation">.</span>defaultOptions<span class="token punctuation">.</span>depth <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 之后打印的对象层级都会被展开</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>通过修改<code>util</code>模块配置, 也有个问题, 就是之后的嵌套对象都会被展平, 这可能会把复杂对象也全部展开了</p></blockquote> <h2 id="node-模块化"><a href="#node-模块化" class="header-anchor">#</a> Node 模块化</h2> <p>在Node中默认是使用<code>CommonJS</code>模块化的, 同时支持对标准<code>ES6</code>模块的兼容(不完全兼容),</p> <p>Node再加载模块时需要知道该模块是使用<code>require()</code>和<code>exports</code>/<code>module.exports</code>, 还是使用<code>import</code>和<code>export</code></p> <p>Node再把一个js文件加载为<code>CommonJS</code>模块时, 会自动定义<code>require()</code>函数及其标识符<code>exports</code>和<code>module</code>,</p> <p>不会启用<code>import</code>和<code>export</code>, 相反, Node在把js文件加载为<code>ES6</code>模块时, 它必须启用<code>import</code>和<code>export</code>,</p> <p>同时必须不能定义<code>require</code> <code>exports</code>和<code>module</code>等额外的关键字</p> <p><strong>指定Node加载对应的模块化</strong></p> <ul><li><p>以**.mjs**后缀的js文件, Node会始终使用<code>ES6</code>模块化加载它</p></li> <li><p>以**.cjs**后缀的js文件, Node会始终使用<code>commonjs</code>模块化加载它</p></li> <li><p>以**.js**文件后缀的js文件, 默认就是<code>CommonJS</code>模块化</p></li> <li><p>还可以在<code>package.json</code>里添加一个<code>type</code>字段, 来指定使用那种模块化标准</p> <ul><li><p><strong>module</strong>:  使用<code>ES6</code>模块化</p></li> <li><p><strong>commonjs</strong>: 使用<code>CommonJS</code>模块化</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;module&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 使用ES6模块化</span>
   ...
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li></ul></li></ul> <blockquote><p>Node中的大部分模块都是<code>CommonJS</code>模块化格式的, 故Node支持使用<code>import</code>加载<code>CommonJS</code>模块, 但是不能使用<code>require()</code>加载<code>ES6</code>模块</p></blockquote> <h2 id="使用-typescript"><a href="#使用-typescript" class="header-anchor">#</a> 使用 TypeScript</h2> <p>安装<code>typescript</code>npm包即可使用 typescript 语法和<code>tsc</code>命令</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> typescript
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>安装<code>@types/node</code>包, 以获得node模块的类型提示</p> <p><code>package.json</code>的<code>type</code>字段设置为<code>module</code>就可以使用<code>ESModule</code></p> <p>使用<code>ts-node</code>包可以直接运行<code>.ts</code>文件</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># 将 index.ts 转换为esm并运行</span>
<span class="token function">node</span> <span class="token parameter variable">--loader</span> ts-node/esm ./index.ts
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Node.js 中的知名框架</p> <ul><li><a href="https://nestjs.com/" target="_blank" rel="noopener noreferrer">NestJS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> - 健壮且功能齐全的框架, 可轻松愉快地创建可扩展且结构合理的系统</li> <li><a href="https://typeorm.io/#/" target="_blank" rel="noopener noreferrer">TypeORM<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> - 伟大的 ORM, 受其他语言（如 Hibernate、Doctrine 或 Entity Framework）的其他知名工具的影响</li> <li><a href="https://rxjs.dev/" target="_blank" rel="noopener noreferrer">RxJS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> - 广泛用于反应式编程的库</li></ul> <h2 id="webassembly"><a href="#webassembly" class="header-anchor">#</a> WebAssembly</h2> <p><a href="https://developer.mozilla.org/zh-CN/docs/WebAssembly" target="_blank" rel="noopener noreferrer">WebAssembly<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是一种高性能的类汇编语言, 可以从包括 C/C++、Rust 和 AssemblyScript 在内的无数语言进行编译。 目前, Chrome、Firefox、Safari、Edge 和 Node.js 都支持它！</p> <p>WebAssembly 规范详细说明了两种文件格式, 一种是二进制格式, 被称为 WebAssembly 模块, 扩展名为 <code>.wasm</code>；另一种是相应的文本表示格式, 被称为 WebAssembly 文本, 扩展名为 <code>.wat</code></p> <h3 id="关键概念"><a href="#关键概念" class="header-anchor">#</a> 关键概念</h3> <ul><li>模块 - 编译后的 WebAssembly 二进制文件, 即 <code>.wasm</code> 文件</li> <li>内存 - 可调整大小的 <strong>ArrayBuffer</strong></li> <li>表格 - 未存储在内存中的引用的可调整大小的类型化数组</li> <li>实例 - 模块及其内存、表格、以及变量的实例化</li></ul> <p>为了使用 WebAssembly, 需要 <code>.wasm</code> 二进制文件和一组 API 来与 WebAssembly 通信</p> <p>Node.js 通过全局的 <a href="http://nodejs.cn/api/wasi.html" target="_blank" rel="noopener noreferrer"><code>WebAssembly</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 对象提供必要的 API</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>WebAssembly<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Object [WebAssembly] {</span>
<span class="token comment">//     compile: [Function: compile],</span>
<span class="token comment">//     validate: [Function: validate],</span>
<span class="token comment">//     instantiate: [Function: instantiate]</span>
<span class="token comment">// }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="生成-webassembly-模块"><a href="#生成-webassembly-模块" class="header-anchor">#</a> 生成 WebAssembly 模块</h3> <p>有多种方法可用于生成 WebAssembly 二进制文件, 包括：</p> <ul><li>手工编写 WebAssembly（<code>.wat</code>）并使用 <a href="https://github.com/webassembly/wabt" target="_blank" rel="noopener noreferrer">wabt<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 等工具转换为二进制格式</li> <li>在 C/C++ 应用程序中使用 <a href="https://emscripten.org/" target="_blank" rel="noopener noreferrer">emscripten<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>在 Rust 应用程序中使用 <a href="https://rustwasm.github.io/wasm-pack/book/" target="_blank" rel="noopener noreferrer">wasm-pack<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>如果你喜欢类似 TypeScript 的体验, 则使用 <a href="https://www.assemblyscript.org/" target="_blank" rel="noopener noreferrer">AssemblyScript<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <blockquote><p>其中一些工具不仅会生成二进制文件, 还会生成 JavaScript 代码和相应的 HTML 文件以在浏览器中运行</p></blockquote> <p>一旦有了 WebAssembly 模块, 就可以使用 Node.js <code>WebAssembly</code> 对象来实例化它</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 假设 add.wasm 文件存在, 其中包含添加了 2 个提供的参数的函数</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> wasmBuffer <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'/path/to/add.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
WebAssembly<span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span>wasmBuffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">wasmModule</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 导出的函数位于 instance.exports 下</span>
  <span class="token keyword">const</span> add <span class="token operator">=</span> wasmModule<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>add<span class="token punctuation">;</span>
  <span class="token keyword">const</span> sum <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出：11</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="与操作系统交互"><a href="#与操作系统交互" class="header-anchor">#</a> 与操作系统交互</h3> <p>WebAssembly 模块本身不能直接访问操作系统功能</p> <p>可以使用第三方工具 <a href="https://docs.wasmtime.dev/" target="_blank" rel="noopener noreferrer">Wasmtime<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来访问此功能</p> <p><code>Wasmtime</code> 利用 <a href="https://wasi.dev/" target="_blank" rel="noopener noreferrer">WASI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> API 来访问操作系统功能</p> <h2 id="express"><a href="#express" class="header-anchor">#</a> Express</h2> <p><strong><a href="https://www.expressjs.com.cn/5x/api.html#express" target="_blank" rel="noopener noreferrer">Express<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong> 是一个简洁而灵活的 node.js Web应用框架, 提供了一系列强大特性帮助你创建各种 Web 应用, 和丰富的 HTTP 工具</p> <p>使用 Express 可以快速地搭建一个完整功能的网站</p> <p>Express 框架核心特性：</p> <ul><li>可以设置中间件来响应 HTTP 请求</li> <li>定义了路由表用于执行不同的 HTTP 请求动作</li> <li>可以通过向模板传递参数来动态渲染 HTML 页面</li></ul> <p>安装<code>npm install express -S</code></p> <p>几个比较重要的模块:</p> <ul><li><strong>body-parser</strong> - node.js 中间件, 通过<code>req.body</code>可获取<code>post</code>请求的数据</li> <li><strong>cookie-parser</strong> - 这就是一个解析<strong>cookie</strong>的工具。通过<code>req.cookies</code>可以取到传过来的<strong>cookie</strong>, 并把它们转成对象</li> <li><strong>multer</strong> - node.js 中间件, 用于处理<code>enctype=&quot;multipart/form-data&quot;</code>(设置表单的MIME编码)的表单数据</li></ul> <p><strong>基本使用:</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 引入 express</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 调用 express 获取 app对象</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// get请求 地址为 /</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// request 为请求对象</span>
    <span class="token comment">// response 为响应对象</span>
    
    <span class="token comment">// response调用json方法返回 hello wrold</span>
    response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 侦听8080端口, 侦听成功调用回调函数</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">服务启动8080端口....</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>访问<code>http://localhost:8888/</code>就可以看到<strong>hello world</strong></p> <h3 id="app-use"><a href="#app-use" class="header-anchor">#</a> app.use</h3> <p><strong>app.use([path,]callback[,callback...])</strong></p> <p>在指定路径挂载指定的<a href="http://expressjs.com/guide/using-middleware.html" target="_blank" rel="noopener noreferrer">中间件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>函数或函数：当请求路径的基匹配时执行中间件函数<code>path</code>(默认值<code>/</code>)</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="请求和响应"><a href="#请求和响应" class="header-anchor">#</a> 请求和响应</h3> <p><strong>Express</strong> 应用使用回调函数的参数： <strong>request</strong> 和 <strong>response</strong> 对象来处理请求和响应的数据</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><a href="https://www.expressjs.com.cn/en/4x/api.html#req" target="_blank" rel="noopener noreferrer"><strong>Request 对象</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>表示 HTTP 请求, 包含了请求查询字符串, 参数, 内容, HTTP 头部等属性。常见属性有：</p> <table><thead><tr><th style="text-align:center;">属性</th> <th style="text-align:center;">描述</th> <th style="text-align:center;">属性</th> <th style="text-align:center;">描述</th></tr></thead> <tbody><tr><td style="text-align:center;"><strong>req.app</strong></td> <td style="text-align:center;">当callback为外部文件时, 用<strong>req.app</strong>访问<strong>express的实例</strong></td> <td style="text-align:center;"><strong>req.baseUrl</strong></td> <td style="text-align:center;">获取路由当前安装的URL路径</td></tr> <tr><td style="text-align:center;"><strong>req.body</strong></td> <td style="text-align:center;">获取<strong>post</strong>发送的数据解析出来的对象, 需要<strong>body-parser</strong>中间件</td> <td style="text-align:center;"><strong>req.fresh  <br>req.stale</strong></td> <td style="text-align:center;">判断请求缓存是否还「新鲜」, 也就是内容没有改变</td></tr> <tr><td style="text-align:center;"><strong>req.headers</strong></td> <td style="text-align:center;">请求头信息对象</td> <td style="text-align:center;"><strong>req.cookies</strong></td> <td style="text-align:center;">获取<strong>cookies</strong></td></tr> <tr><td style="text-align:center;"><strong>res.header(key,  value)</strong></td> <td style="text-align:center;">设置响应请求头信息</td> <td style="text-align:center;"><strong>req.get()</strong></td> <td style="text-align:center;">获取指定的<strong>HTTP</strong>请求头</td></tr> <tr><td style="text-align:center;"><strong>req.hostname  req.ip</strong></td> <td style="text-align:center;">获取主机名和IP地址</td> <td style="text-align:center;"><strong>req.originalUrl</strong><br><strong>req.url</strong></td> <td style="text-align:center;">原始请求<strong>URL</strong><br>匹配<strong>url</strong></td></tr> <tr><td style="text-align:center;"><strong>req.params</strong></td> <td style="text-align:center;">在路由地址使用**/:id/:name** 匹配<strong>params</strong>的参数</td> <td style="text-align:center;"><strong>req.path</strong></td> <td style="text-align:center;">获取请求路径</td></tr> <tr><td style="text-align:center;"><strong>req.protocol</strong></td> <td style="text-align:center;">获取协议类型</td> <td style="text-align:center;"><strong>req.query</strong></td> <td style="text-align:center;">查询字符串解析出来的对象</td></tr> <tr><td style="text-align:center;"><strong>req.route</strong></td> <td style="text-align:center;">获取当前匹配的路由</td> <td style="text-align:center;"><strong>req.subdomains</strong></td> <td style="text-align:center;">获取子域名</td></tr> <tr><td style="text-align:center;"><strong>req.accepts()</strong></td> <td style="text-align:center;">检查可接受的请求的文档类型</td> <td style="text-align:center;"><strong>req.is(type)</strong></td> <td style="text-align:center;">判断请求头<strong>Content-Type</strong>的MIME类型</td></tr></tbody></table> <p><a href="https://www.expressjs.com.cn/en/4x/api.html#res" target="_blank" rel="noopener noreferrer"><strong>Response 对象</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>表示 HTTP 响应, 即在接收到请求时向客户端发送的 HTTP 响应数据(是一个可写流), 常见属性有：</p> <table><thead><tr><th style="text-align:center;">属性</th> <th style="text-align:center;">描述</th> <th style="text-align:center;">属性</th> <th style="text-align:center;">描述</th></tr></thead> <tbody><tr><td style="text-align:center;"><strong>res.headersSent</strong></td> <td style="text-align:center;">查看http响应是否响应了http头</td> <td style="text-align:center;"><strong>res.append(key, value)</strong></td> <td style="text-align:center;">追加http响应头</td></tr> <tr><td style="text-align:center;"><strong>res.attachment(filePath)</strong></td> <td style="text-align:center;">响应文件请求</td> <td style="text-align:center;"><strong>res.cookie(key,value)</strong></td> <td style="text-align:center;">设置<strong>cookie</strong></td></tr> <tr><td style="text-align:center;"><strong>res.clearCookie(cookiename)</strong></td> <td style="text-align:center;">删除<strong>cookie</strong></td> <td style="text-align:center;"><strong>res.get(key)</strong></td> <td style="text-align:center;">获取响应header数据</td></tr> <tr><td style="text-align:center;"><strong>res.header(key,  value)</strong></td> <td style="text-align:center;">设置响应请求头信息</td> <td style="text-align:center;"><strong>res.type(type)</strong></td> <td style="text-align:center;">设置<strong>Content-Type</strong>的MIME类型</td></tr> <tr><td style="text-align:center;"><strong>res.json(data)</strong></td> <td style="text-align:center;">返回json数据 会自动设置响应<strong>header Content-type</strong> 为json格式 <strong>application/json</strong></td> <td style="text-align:center;"><strong>res.setHeader()<br>res.set()</strong></td> <td style="text-align:center;">设置请求头</td></tr> <tr><td style="text-align:center;"><strong>res.redirect(301,'/api/aes')</strong></td> <td style="text-align:center;">重定向 把访问的地址跳转到另一个地址上</td> <td style="text-align:center;"><strong>res.send(data)</strong></td> <td style="text-align:center;">发送数据 可以是任意类型的数据</td></tr> <tr><td style="text-align:center;"><strong>res.sendFile(filePath)</strong></td> <td style="text-align:center;">发送文件</td> <td style="text-align:center;"><strong>res.status(404)</strong></td> <td style="text-align:center;">设置状态码, 默认200</td></tr></tbody></table> <h3 id="覆盖-express-api"><a href="#覆盖-express-api" class="header-anchor">#</a> 覆盖 Express API</h3> <p><strong>Express API</strong> 由请求和响应对象的各种方法和属性组成, 这些是由原型继承的 API 有两个扩展点：</p> <ul><li>全局原型的<code>express.request</code>和<code>express.response</code></li> <li>特定于应用程序的原型<code>app.request</code>和<code>app.response</code></li></ul> <h4 id="修改方法"><a href="#修改方法" class="header-anchor">#</a> 修改方法</h4> <p>可以通过分配自定义函数来用自己的方法覆盖现有方法的签名和行为</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 覆盖 res.sendStatus 方法的行为</span>
app<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function-variable function">sendStatus</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">statusCode<span class="token punctuation">,</span> type<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>   <span class="token comment">// 指定编码类型</span>
    <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">)</span> <span class="token comment">// 指定响应状态码</span>
    <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 响应体</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>使用</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>res<span class="token punctuation">.</span><span class="token function">sendStatus</span><span class="token punctuation">(</span>
    <span class="token number">404</span><span class="token punctuation">,</span> 
    <span class="token string">'application/json'</span><span class="token punctuation">,</span> 
    <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'响应失败了'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="添加特性"><a href="#添加特性" class="header-anchor">#</a> 添加特性</h4> <p>Express API 中的属性是：</p> <ul><li><p>分配的属性（例如：<code>req.baseUrl</code>, <code>req.originalUrl</code>）</p></li> <li><p>定义为<code>getters</code>（例如：<code>req.secure</code>, <code>req.ip</code>）</p></li></ul> <p>由于分配的属性在当前请求-响应周期的上下文中会动态分配给<code>request</code>和<code>response</code>对象, 因此它们的行为不能被覆盖, <code>getters</code>的属性是可以覆盖的</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 通过修改 app.request 来影响当前应用程序下的 req.ip 获取的值</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token string">'ip'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'Client-IP'</span><span class="token punctuation">)</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="静态文件"><a href="#静态文件" class="header-anchor">#</a> 静态文件</h3> <p><strong>Express</strong> 提供了内置的中间件 <code>express.static</code> 来设置静态文件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//将静态文件目录设置为 根目录/xxx.png</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//或者</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>设置了静态资源目录后, <strong>Express</strong> 会在静态资源目录下查找文件, 存放静态文件的目录名不会出现在 <strong>URL</strong> 中</p> <p>如果要使用多个静态资源目录, 请多次调用 <code>express.static</code> 中间件函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'files'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>访问静态资源文件时, <code>express.static</code> 中间件函数会根据目录的添加顺序查找所需的文件</p></blockquote> <p>指定静态文件的前缀</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//将静态文件目录设置为 根目录/static/xxx.png</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/static'</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="路由"><a href="#路由" class="header-anchor">#</a> 路由</h3> <p>路由决定了匹配那个函数去响应客户端请求</p> <p>请求类型共有: <code>GET</code> <code>POST</code> <code>DELETE</code> <code>PUT</code> <code>PATCH</code> <code>OPTIONS</code></p> <p>常用的就是: <code>GET</code> <code>POST</code> <code>DELETE</code> <code>PUT</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//  主页 GET 请求</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token comment">// 可以链式调用</span>
   res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">'index GET'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//  /test/post POST 请求</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/test/post'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">'/test/post POST'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//  all 方法响应所有的请求</span>
app<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'/all'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">'/all'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//  地址栏可以使用*来匹配</span>
<span class="token comment">// a和c之间可以是任何字母数字之类的合法url字符</span>
app<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'/test/a*c'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">'/test/a*c'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// * 匹配所有的所有的地址一般放到最后兜底</span>
app<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">'404 Not Found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><blockquote><p>Express 的路由匹配时基于<a href="https://www.npmjs.com/package/path-to-regexp" target="_blank" rel="noopener noreferrer"><code>Path-to-RegExp</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h4 id="路由参数"><a href="#路由参数" class="header-anchor">#</a> 路由参数</h4> <p>路由参数是命名的 URL 段, 用于捕获在 URL 中的位置指定的值</p> <p>捕获的值填充到<code>req.params</code>对象中, 路径中指定的路由参数的名称作为它们各自的键</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token literal-property property">路由地址</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">users</span><span class="token regex-delimiter">/</span></span><span class="token operator">:</span>userId<span class="token operator">/</span>books<span class="token operator">/</span><span class="token operator">:</span>bookId
请求<span class="token constant">URL</span><span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>users<span class="token operator">/</span><span class="token number">34</span><span class="token operator">/</span>books<span class="token operator">/</span><span class="token number">8989</span>
req<span class="token punctuation">.</span>params<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">&quot;userId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;34&quot;</span><span class="token punctuation">,</span> <span class="token string-property property">&quot;bookId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;8989&quot;</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>要使用路由参数定义路由, 只需在路由的路径中指定路由参数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/users/:userId/books/:bookId'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { &quot;userId&quot;: &quot;34&quot;, &quot;bookId&quot;: &quot;8989&quot; }</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>路由参数的名称必须由“单词字符”（[A-Za-z0-9_]）组成</p></blockquote> <h4 id="多个回调函数处理路由"><a href="#多个回调函数处理路由" class="header-anchor">#</a> 多个回调函数处理路由</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">cb0</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'CB0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">cb1</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'CB1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">cb2</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello express!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/express'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>cb0<span class="token punctuation">,</span> cb1<span class="token punctuation">,</span> cb2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>函数数组+匿名函数处理路由</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/express'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>cb0<span class="token punctuation">,</span> cb1<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'匿名函数处理'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="响应方法"><a href="#响应方法" class="header-anchor">#</a> 响应方法</h4> <table><thead><tr><th>方法</th> <th>描述</th></tr></thead> <tbody><tr><td><a href="https://www.expressjs.com.cn/en/4x/api.html#res.download" target="_blank" rel="noopener noreferrer">res.download()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>提示要下载的文件。</td></tr> <tr><td><a href="https://www.expressjs.com.cn/en/4x/api.html#res.end" target="_blank" rel="noopener noreferrer">res.end()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>结束响应过程。</td></tr> <tr><td><a href="https://www.expressjs.com.cn/en/4x/api.html#res.json" target="_blank" rel="noopener noreferrer">res.json()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>发送 JSON 响应。</td></tr> <tr><td><a href="https://www.expressjs.com.cn/en/4x/api.html#res.jsonp" target="_blank" rel="noopener noreferrer">res.jsonp()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>发送带有 JSONP 支持的 JSON 响应。</td></tr> <tr><td><a href="https://www.expressjs.com.cn/en/4x/api.html#res.redirect" target="_blank" rel="noopener noreferrer">res.redirect()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>重定向请求。</td></tr> <tr><td><a href="https://www.expressjs.com.cn/en/4x/api.html#res.render" target="_blank" rel="noopener noreferrer">res.render()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>渲染视图模板。</td></tr> <tr><td><a href="https://www.expressjs.com.cn/en/4x/api.html#res.send" target="_blank" rel="noopener noreferrer">res.send()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>发送各种类型的响应。</td></tr> <tr><td><a href="https://www.expressjs.com.cn/en/4x/api.html#res.sendFile" target="_blank" rel="noopener noreferrer">res.sendFile()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>将文件作为八位字节流发送。</td></tr> <tr><td><a href="https://www.expressjs.com.cn/en/4x/api.html#res.sendStatus" target="_blank" rel="noopener noreferrer">res.sendStatus()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>设置响应状态代码并将其字符串表示形式作为响应正文发送。</td></tr></tbody></table> <h4 id="路由模块化"><a href="#路由模块化" class="header-anchor">#</a> 路由模块化</h4> <p>当路由很多的时候, 就需要使用路由模块化来方便管理</p> <p>路由模块文件<code>router/test.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取路由实例</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 定义路由</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/testModule'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">'route module'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 暴露路由对象</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p><code>express.Router</code> 可以理解为一个迷你版的 <code>app</code> 对象, 但是它功能完备, 同样支持注册中间件和路由</p></blockquote> <p>入口文件<code>app.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 引入路由对象</span>
<span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router/test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 指定地址使用应用路由对象, 当访问 根路由/test 就会去匹配 test路由文件里的路由</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>访问<code>http://localhost:8888/test/testModule</code>就可以访问对应路由模块</p> <h4 id="跨域配置"><a href="#跨域配置" class="header-anchor">#</a> 跨域配置</h4> <p>在node中出现跨域可以使用<code>cors</code>模块解决</p> <p>npm下载 cors: <code>npm install cors -S</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 引入 cors 模块</span>
<span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span> <span class="token string">'cors'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 应用 cors 模块</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>应用 cors 模块一定要写在注册路由的最前面, 此模块也可以, 当做路由中间件, 指定某一个, 或者某一部分路由, 拥有跨域功能</p></blockquote> <p><strong>常规方式</strong></p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 跨域中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token operator">:</span> express<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> res<span class="token operator">:</span> express<span class="token punctuation">.</span>Response<span class="token punctuation">,</span> next<span class="token operator">:</span> express<span class="token punctuation">.</span>NextFunction<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>originalUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// console.log(req.headers.origin);</span>

  <span class="token comment">// 允许指定的请求源地址,可以填*</span>
  res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Allow-Origin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 允许携带请求凭证,如为true, 那请求地址就不能设置为*</span>
  <span class="token comment">// res.header(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);</span>
  <span class="token comment">// 允许的请求方法</span>
  res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Allow-Methods&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;GET,PUT,POST,DELETE,PATCH,OPTIONS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 允许的请求头类型</span>
  res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Allow-Headers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Content-Type, Content-Length, Authorization, Accept, X-Requested-With, Blade-Auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;options&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 让 options 请求快速结束</span>
		res<span class="token punctuation">.</span><span class="token function">sendStatus</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 路由放行</span>
		<span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><blockquote><p>同样需要写到注册路由的最前面</p></blockquote> <h3 id="中间件"><a href="#中间件" class="header-anchor">#</a> 中间件</h3> <p><strong>Express</strong> 的<a href="https://www.expressjs.com.cn/resources/middleware.html" target="_blank" rel="noopener noreferrer">中间件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>一般分成两种:</p> <ul><li>全局中间件</li> <li>路由中间件</li></ul> <p><img src="/note-sites/assets/img/Middleware.bbcd8845.png" alt="image-20220104161603645"></p> <p>首先客户端向服务器发起请求, 然后服务器依次执行每个中间件, 最后到达路由, 选择相应的逻辑来执行</p> <p>有两点需要注意：</p> <ul><li>中间件是<strong>按顺序执行</strong>的, 因此在配置中间件时顺序非常重要, 不能弄错</li> <li>中间件在执行内部逻辑的时候可以选择将请求传递给下一个中间件, 也可以直接返回用户响应</li></ul> <h4 id="express-中间件的定义"><a href="#express-中间件的定义" class="header-anchor">#</a> Express 中间件的定义</h4> <p>在 <strong>Express</strong> 中, 中间件就是一个函数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 和普通的路由一样, 只不过多了 next参数是一个方法</span>
<span class="token keyword">function</span> <span class="token function">someMiddleware</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 可以自定义逻辑, 也可以返回数据</span>
    
  <span class="token comment">// 调用 next方法 将控制权传递给下一个中间件函数</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>如果忘记在中间件中调用 <code>next</code> 函数, 并且又不直接返回响应时, 服务器会直接卡在这个中间件不会继续执行下去</p></blockquote> <h4 id="全局中间件"><a href="#全局中间件" class="header-anchor">#</a> 全局中间件</h4> <p>通过 <code>app.use</code> 函数就可以注册中间件, 并且此中间件会在用户发起<strong>任何请求</strong>都可能会执行, 例如:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>someMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// or</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="可配置的中间件"><a href="#可配置的中间件" class="header-anchor">#</a> 可配置的中间件</h4> <p>如果需要可配置中间件, 请导出一个接受选项对象或其他参数的函数, 然后根据输入参数返回中间件实现</p> <p>中间件定义假设在文件在<code>my-middleware.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里可以根据 options 对象的选项来执行不同的操作</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>导入使用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> mw <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./my-middleware.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">mw</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">namg</span><span class="token operator">:</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="路由中间件"><a href="#路由中间件" class="header-anchor">#</a> 路由中间件</h4> <p>通过在路由定义时注册中间件, 此中间件只会在用户访问该路由对应的 URI 时执行, 例如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/hello'</span><span class="token punctuation">,</span> someMiddleware<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello World'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 同样匿名函数也可以</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>只有在用户访问 <code>/hello</code> 时, 定义的 <code>someMiddleware</code> 中间件才会被触发, 访问其他路径时不会触发</p> <blockquote><p>在中间件中写 <code>console.log</code> 语句是比较糟糕的做法, 因为 <code>console.log</code>（包括其他同步的代码）都会阻塞 node 的异步事件循环, 降低服务器的吞吐率</p></blockquote> <p>中间件不仅可以读取 <code>req</code> 对象上的各个属性, 还可以添加新的属性或修改已有的属性（后面的中间件和路由函数都可以获取）, 能够很方便地实现一些复杂的业务逻辑（例如用户鉴权）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个路由中间件用于检查判断路由器, 并在需要时退出</span>
router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'x-auth'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 跳过路由器的其余中间件功能, </span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user/:id'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello, user!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/admin'</span><span class="token punctuation">,</span> router<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">sendStatus</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="处理-404-和服务器错误"><a href="#处理-404-和服务器错误" class="header-anchor">#</a> 处理 404 和服务器错误</h4> <p>客户端方面的错误(状态码 4xx), 服务器方面的错误(状态码 5xx)</p> <p>完善 <strong>Express</strong> 中间件的运作流程, 来处理错误</p> <p><img src="/note-sites/assets/img/Middleware2.2e82d65a.png" alt="image-20220104162944251"></p> <p>这张示意图和之前的图有两点重大区别：</p> <ul><li>每个路由定义本质上是一个<strong>中间件</strong>（更准确地说是一个<strong>中间件容器</strong>, 可包含多个中间件）, 当 URI 匹配成功时直接返回响应, 匹配失败时继续执行下一个路由</li> <li>每个中间件（包括路由）不仅可以调用 <code>next</code> 函数向下传递、直接返回响应, 还可以<strong>抛出异常</strong></li></ul> <p>从这张图就可以很清晰地看出怎么实现 404 和服务器错误的处理了：</p> <ul><li>对于 404, 只需在所有路由之后再加一个中间件, 用来接收所有路由均匹配失败的请求</li> <li>对于错误处理, 前面所有中间件抛出异常时都会进入错误处理函数, 可以使用 <strong>Express</strong> 自带的, 也可以自定义</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 中间件和其他路由 ...</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  req<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">'404 Not Found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p><code>*</code> 表示匹配任何路径。将此中间件放在所有路由后面, 即可捕获所有访问路径均匹配失败的请求</p></blockquote> <p><strong>Express</strong> 可以通过自定义错误处理函数来解决服务器错误的问题, 错误处理函数的形式如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 处理错误逻辑</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>和普通的中间件函数相比, 就多了<code>err</code>参数, 也就是 <code>err</code> 异常对象</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 中间件和其他路由 ...</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// console.error(err.stack);</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">'server Error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>错误处理中间件总是需要<strong>四个参数</strong>, <strong>必须</strong>提供四个参数以将其标识为错误处理中间件函数。即使是不需要使用该<code>next</code>函数, 也必须要指定它来维护签名, 否则, 该<code>next</code>函数将被解释为常规中间件并且无法处理错误</p></blockquote> <h3 id="使用token"><a href="#使用token" class="header-anchor">#</a> 使用token</h3> <p>安装依赖: <code>npm install jsonwebtoken --save</code></p> <p>基本使用如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> jsonwebtoken <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;jsonwebtoken&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> secret <span class="token operator">=</span> <span class="token string">&quot;密钥&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> token <span class="token operator">=</span> jsonwebtoken<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&quot;001&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 加密数据</span>
  secret<span class="token punctuation">,</span> <span class="token comment">// 加密密钥</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// 指定过期时间</span>
    <span class="token comment">// expiresIn: 1 // 数字以秒(s)做单位</span>
    <span class="token literal-property property">expiresIn</span><span class="token operator">:</span> <span class="token string">&quot;1000&quot;</span> <span class="token comment">// 字符串就以毫秒(ms)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;生成的token: &quot;</span> <span class="token operator">+</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> decoded <span class="token operator">=</span> jsonwebtoken<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;同步解密token:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>decoded<span class="token punctuation">)</span><span class="token punctuation">;</span>

jsonwebtoken<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> decoded</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token string">&quot;token错误&quot;</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;异步解密token: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>decoded<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 过期解密token将会报错</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> decoded <span class="token operator">=</span> jsonwebtoken<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>decoded<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>模块化封装</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> jsonwebtoken <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;jsonwebtoken&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> secret <span class="token operator">=</span> <span class="token string">&quot;密钥&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 封装操作token的方法</span>
<span class="token keyword">const</span> <span class="token constant">JWT</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 生成token</span>
  <span class="token function">generate</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> expires <span class="token operator">=</span> <span class="token string">&quot;2h&quot;</span><span class="token punctuation">,</span> stub <span class="token operator">=</span> <span class="token string">&quot;Bearer &quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> jsonwebtoken<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">expiresIn</span><span class="token operator">:</span> expires <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> stub <span class="token operator">+</span> token<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 解密token</span>
  <span class="token function">verify</span><span class="token punctuation">(</span><span class="token parameter">token</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> jsonwebtoken<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 说明token失效或过期</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 解析和重新设置token的中间件</span>
<span class="token keyword">const</span> <span class="token function-variable function">verifyAuthorization</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取token</span>
  <span class="token comment">// const token = req.headers.authorization;</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 解密</span>
  <span class="token keyword">const</span> decoded <span class="token operator">=</span> <span class="token constant">JWT</span><span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>decoded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 存在就放到请求对象中</span>
    req<span class="token punctuation">.</span>decoded <span class="token operator">=</span> decoded<span class="token punctuation">;</span>

    <span class="token comment">// 重新生成一个新的token, 用于刷新过期时间(数据就是上次解析出来的数据)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> userName <span class="token punctuation">}</span> <span class="token operator">=</span> decoded<span class="token punctuation">;</span>
    <span class="token keyword">const</span> newToken <span class="token operator">=</span> <span class="token constant">JWT</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token punctuation">,</span> userName <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 重新存到响应请求头中传递给前端 </span>
    res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">,</span> newToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 否则返回错误码</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">&quot;没有权限&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token constant">JWT</span><span class="token punctuation">,</span>
    verifyAuthorization
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h3 id="解析body参数"><a href="#解析body参数" class="header-anchor">#</a> 解析body参数</h3> <p>使用body-parser</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// app.use(bodyParser()); // 弃用</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">extended</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="文件上传"><a href="#文件上传" class="header-anchor">#</a> 文件上传</h3> <p>使用<a href="https://www.npmjs.com/package/multer" target="_blank" rel="noopener noreferrer">multer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, 该模块专门用于接受<code>multipart/form-data</code>格式的文件数据</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> join<span class="token punctuation">,</span> sep<span class="token punctuation">,</span> normalize<span class="token punctuation">,</span> basename <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> multer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'multer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 指定文件上传保存的路径</span>
<span class="token keyword">const</span> uploadFilePath <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../public/uploads/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> storage <span class="token operator">=</span> multer<span class="token punctuation">.</span><span class="token function">diskStorage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// 定义上传文件保存目录</span>
    <span class="token function">destination</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> file<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> uploadFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 定义文件保存的文件名</span>
    <span class="token function">filename</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> file<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> fieldname<span class="token punctuation">,</span> originalname <span class="token punctuation">}</span> <span class="token operator">=</span> file<span class="token punctuation">;</span>
        <span class="token keyword">let</span> uniqueSuffix <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'-'</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1E9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 拼接文件扩展名</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>originalname<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            uniqueSuffix <span class="token operator">+=</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> originalname<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span>fieldname <span class="token operator">+</span> <span class="token string">'-'</span> <span class="token operator">+</span> uniqueSuffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> upload <span class="token operator">=</span> <span class="token function">multer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">storage</span><span class="token operator">:</span> storage <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/fileUpload'</span><span class="token punctuation">,</span> upload<span class="token punctuation">.</span><span class="token function">single</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// req.file 就是上传的文件</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 可以返回一个文件的完整路径给前端显示</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> headers<span class="token punctuation">,</span> file <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">;</span>
    <span class="token keyword">const</span> filePath <span class="token operator">=</span> headers<span class="token punctuation">.</span>host <span class="token operator">+</span> sep <span class="token operator">+</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token function">basename</span><span class="token punctuation">(</span>uploadFilePath<span class="token punctuation">)</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token literal-property property">mag</span><span class="token operator">:</span> <span class="token string">'文件上传成功'</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">filePath</span><span class="token operator">:</span> <span class="token function">normalize</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="文件下载"><a href="#文件下载" class="header-anchor">#</a> 文件下载</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> mime <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;mime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">setFileDownload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">filePath<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取文件信息</span>
    <span class="token keyword">const</span> stat <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取可读流</span>
    <span class="token keyword">const</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置内容</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置长度</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Length&quot;</span><span class="token punctuation">,</span> stat<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置为附件</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Disposition&quot;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">attachment; filename=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">basename</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 或者这样写也一样</span>
    <span class="token comment">// res.writeHead(200, {</span>
    <span class="token comment">//     &quot;Content-Type&quot;: mime.getType(filePath),</span>
    <span class="token comment">//     &quot;Content-Length&quot;: stat.size,</span>
    <span class="token comment">//     &quot;Content-Disposition&quot;: `attachment; filename=${basename(filePath)}`</span>
    <span class="token comment">// });</span>
    
    <span class="token comment">// 管道写入</span>
    rs<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/fileDownload&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../public/123.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setFileDownload</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="模板引擎"><a href="#模板引擎" class="header-anchor">#</a> 模板引擎</h3> <p><a href="https://www.expressjs.com.cn/resources/template-engines.html" target="_blank" rel="noopener noreferrer">模板引擎<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="日志管理"><a href="#日志管理" class="header-anchor">#</a> 日志管理</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> createLogger<span class="token punctuation">,</span> format<span class="token punctuation">,</span> transports <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'winston'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;winston-daily-rotate-file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 日志信息格式处理</span>
<span class="token keyword">const</span> <span class="token function-variable function">getCustomFormat</span> <span class="token operator">=</span> <span class="token parameter">level</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> format<span class="token punctuation">.</span><span class="token function">combine</span><span class="token punctuation">(</span>
        format<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">&quot;YYYY-MM-DD HH:mm:ss&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        format<span class="token punctuation">.</span><span class="token function">align</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        format<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token parameter">i</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token punctuation">.</span>level<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token punctuation">[</span>i<span class="token punctuation">.</span>timestamp<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token comment">// 因为每个类型的日志都会触发所以需要进行level判断</span>
            <span class="token keyword">return</span> i<span class="token punctuation">.</span>level <span class="token operator">===</span> level <span class="token operator">?</span> msg<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// 日志默认配置</span>
<span class="token keyword">const</span> defaultOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">datePattern</span><span class="token operator">:</span> <span class="token string">&quot;YYYY-MM-DD&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">zippedArchive</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">maxSize</span><span class="token operator">:</span> <span class="token string">&quot;20m&quot;</span><span class="token punctuation">,</span> 
    <span class="token literal-property property">maxFiles</span><span class="token operator">:</span> <span class="token string">&quot;14d&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 要保留的最大日志数14天</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">getYM</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">YYYY</span> <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">MM</span> <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">YYYY</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">MM</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 全局日志</span>
<span class="token keyword">const</span> globalLogger <span class="token operator">=</span> <span class="token function">createLogger</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">transports</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">transports<span class="token punctuation">.</span>DailyRotateFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment">// 文件名以日期命名</span>
            <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">logs/info/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getYM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/%DATE%.log</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            <span class="token literal-property property">level</span><span class="token operator">:</span> <span class="token string">&quot;info&quot;</span><span class="token punctuation">,</span>
            <span class="token operator">...</span>defaultOptions<span class="token punctuation">,</span>
            <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token function">getCustomFormat</span><span class="token punctuation">(</span><span class="token string">&quot;info&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// 这里可以单独处理每个类型的日志</span>
            <span class="token comment">// format: format.combine(</span>
            <span class="token comment">//     format.printf(({ level, message }) =&gt; {</span>
            <span class="token comment">//         return level === &quot;error&quot; ? &quot;单独处理全局错误日志&quot; : '';</span>
            <span class="token comment">//     })</span>
            <span class="token comment">// )</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">transports<span class="token punctuation">.</span>DailyRotateFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">logs/error/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getYM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/%DATE%.log</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            <span class="token literal-property property">level</span><span class="token operator">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span>
            <span class="token operator">...</span>defaultOptions<span class="token punctuation">,</span>
            <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token function">getCustomFormat</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment">// 权限日志</span>
<span class="token keyword">const</span> authLogger <span class="token operator">=</span> <span class="token function">createLogger</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">transports</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">transports<span class="token punctuation">.</span>DailyRotateFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">logs/authLog/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getYM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/%DATE%.log</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token function">getCustomFormat</span><span class="token punctuation">(</span><span class="token string">&quot;info&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token operator">...</span>defaultOptions<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    globalLogger<span class="token punctuation">,</span>
    authLogger
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><p>记录日志</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> globalLogger<span class="token punctuation">,</span> authLogger <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./logger.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

globalLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;记录日志&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> message<span class="token punctuation">,</span> stack <span class="token punctuation">}</span> <span class="token operator">=</span> err<span class="token punctuation">;</span>
    <span class="token keyword">const</span> msg <span class="token operator">=</span> message <span class="token operator">+</span> <span class="token string">&quot;\r\n stack: &quot;</span> <span class="token operator">+</span> stack <span class="token operator">+</span> <span class="token string">&quot;\r\n&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 记录错误日志</span>
    globalLogger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">'server Error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="koa"><a href="#koa" class="header-anchor">#</a> Koa</h2> <p><code>Express</code> 就是 <a href="https://koa.bootcss.com/#" target="_blank" rel="noopener noreferrer"><code>koa</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的前生, 也可以理解为 Koa 是ES6版的 Express, 由原班人马打造,</p> <p>只是把ES5语法改成ES6, 并且换了个名目前最新的 Koa 版本是 <code>koa2</code></p> <p>安装<code>npm install koa</code></p> <p><strong>简单使用</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// koa 是一个构造函数</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ctx 是一个上下文对象, 包括 request 和 response 对象</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span> <span class="token comment">// 响应状态码</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'hello koa'</span><span class="token punctuation">;</span> <span class="token comment">// 响应体</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用下一个中间件(后续有其他的中间件需要执行时必须要调用, 不然就会阻塞在这里)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">8000</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">服务启动</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">端口</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>访问 <code>http://localhost:8000/</code> 就可以看到<code>hello koa</code>内容</p> <blockquote><p><a href="https://www.ruanyifeng.com/blog/2017/08/koa.html" target="_blank" rel="noopener noreferrer">阮一峰教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h3 id="koa参数设置"><a href="#koa参数设置" class="header-anchor">#</a> Koa参数设置</h3> <p>应用程序设置是 <code>app</code> 实例上的属性, 目前支持如下：</p> <ul><li><code>app.env</code> 默认是 <strong>NODE_ENV</strong> 或 <strong>&quot;development&quot;</strong></li> <li><code>app.keys</code> 签名的 cookie 密钥数组</li> <li><code>app.proxy</code> 当真正的代理头字段将被信任时
<ul><li>忽略 <code>.subdomains</code> 的 <code>app.subdomainOffset</code> 偏移量, 默认为 2</li></ul></li> <li><code>app.proxyIpHeader</code> 代理 ip 消息头, 默认为 <code>X-Forwarded-For</code></li> <li><code>app.maxIpsCount</code> 从代理 ip 消息头读取的最大 ips, 默认为 <strong>0</strong> (代表无限)</li></ul> <p>可以将设置传递给构造函数:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// or</span>

<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>proxy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="app的常用属性-方法"><a href="#app的常用属性-方法" class="header-anchor">#</a> app的常用属性/方法</h3> <h4 id="app-use方法"><a href="#app-use方法" class="header-anchor">#</a> app.use方法</h4> <p><code>app.use(function)</code></p> <p>将给定的中间件方法添加到此应用程序, <code>app.use()</code> 返回 <code>this</code>, 因此可以链式表达</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>someMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>someOtherMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 等同于</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>someMiddleware<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>someOtherMiddleware<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="app-listen方法"><a href="#app-listen方法" class="header-anchor">#</a> app.listen方法</h4> <p><code>app.listen(port[,callback])</code></p> <p>将 Koa 应用程序被绑定到指定端口</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">8000</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">服务启动</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">端口</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="app-context属性"><a href="#app-context属性" class="header-anchor">#</a> app.context属性</h4> <p><code>app.context</code> 是创建 <code>ctx</code> 的原型, 可以添加一些通用方法到 <code>app.context</code> 中从而使用更少的 <strong>中间件</strong> 或者<code>require()</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 挂载工具函数</span>
app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>util <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">log</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils/log.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">hi</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello koa'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">myName</span><span class="token operator">:</span> <span class="token string">'张三'</span>
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>util<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>util<span class="token punctuation">.</span>myName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 张三</span>
    ctx<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">hi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'hello koa'</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="ctx-app"><a href="#ctx-app" class="header-anchor">#</a> ctx.app</h4> <p>应用程序实例引用</p> <h4 id="app-emit"><a href="#app-emit" class="header-anchor">#</a> app.emit</h4> <p>Koa 应用扩展了内部 <a href="http://nodejs.cn/api/events.html#events_class_eventemitter" target="_blank" rel="noopener noreferrer">EventEmitter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <code>app.emit</code> 可以触发一个以第一个参数定义的事件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 监听事件</span>
app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">date</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 触发事件</span>
app<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">,</span> <span class="token string">'2022-01-28'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="ctx-respond"><a href="#ctx-respond" class="header-anchor">#</a> ctx.respond</h4> <p>为了绕过 Koa 的内置 response 处理, 你可以显式设置 <code>ctx.respond = false</code>, 这样 Koa 就不会处理你的 response</p> <blockquote><p>这个属性官方不支持使用, 只是便于那些希望在 Koa 中使用传统的 <code>fn(req, res){...}</code> 功能和中间件的人</p></blockquote> <h3 id="中间件-2"><a href="#中间件-2" class="header-anchor">#</a> 中间件</h3> <p>中间件是 Koa 的一个重要的概念, 它是一个执行的链条, 整个链条组成了一个运行的周期</p> <p>中间件可以写成同步的也可以写成异步的(<code>async</code>+<code>await</code>)</p> <h4 id="洋葱模型"><a href="#洋葱模型" class="header-anchor">#</a> 洋葱模型</h4> <p>Koa 是运用了洋葱模型的代表框架之一</p> <p><img src="/note-sites/assets/img/ycmx1.94cfd64f.png" alt=""></p> <p>上面的图有点抽象, 复习一下 <strong>Express</strong> 的中间件过程</p> <p><img src="/note-sites/assets/img/image-20220126152507915.16c3c200.png" alt="image-20220126152507915"></p> <p>请求（Request）直接依次贯穿各个中间件, 最后通过请求处理函数返回响应（Response）, 非常简单, 然后来看看 <strong>Koa</strong> 的中间件是什么样的：</p> <p><img src="/note-sites/assets/img/image-20220126152610623.306d26b4.png" alt="image-20220126152610623"></p> <p>可以看到, <strong>Koa</strong> 中间件不像 <strong>Express</strong> 中间件那样在请求通过了之后就完成了自己的使命, 相反, 中间件的执行清晰地分为<strong>两个阶段</strong></p> <h5 id="koa-中间件的定义"><a href="#koa-中间件的定义" class="header-anchor">#</a> Koa 中间件的定义</h5> <p>Koa 的中间件是一个这样的函数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">middleware</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 第一阶段</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 第二阶段</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>ctx封装了请求和响应对象后面细说, Koa 的<code>next</code> 函数返回的是一个 <strong>Promise</strong>,</p> <p>在这个 <strong>Promise</strong> 进入完成状态（Fulfilled）后, 就会去执行中间件中第二阶段的代码</p> <p>可以利用这个特性来记录每次请求的方法, url, 状态码, 响应时间</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 记录一个时间</span>
    <span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行下一个中间件</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算时间差</span>
    <span class="token keyword">const</span> ms <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
    <span class="token comment">// 输出记录</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ms<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>多个中间件的运行顺序</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 访问权限</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'&gt;&gt;&gt; 1.权限验证通过...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 执行下一个中间件</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'&lt;&lt;&lt; 6.权限验证通过之后'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 日志记录</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'&gt;&gt;&gt; 2.日志记录完成...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 执行下一个中间件</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'&lt;&lt;&lt; 5.日志记录完成之后'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 响应处理</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'hello koa'</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'&gt;&gt;&gt; 3.数据响应完成...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行下一个中间件</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'&lt;&lt;&lt; 4.数据响应完成之后'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">8000</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">服务启动</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">端口</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>访问 <code>http://localhost:8000/</code> 会按照洋葱模型的顺序执行结果如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1.</span>权限验证通过<span class="token operator">...</span>
<span class="token operator">&gt;&gt;&gt;</span> <span class="token number">2.</span>日志记录完成<span class="token operator">...</span> 
<span class="token operator">&gt;&gt;&gt;</span> <span class="token number">3.</span>数据响应完成<span class="token operator">...</span> 
<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span> <span class="token number">4.</span>数据响应完成之后
<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span> <span class="token number">5.</span>日志记录完成之后
<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span> <span class="token number">6.</span>权限验证通过之后
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>洋葱模型的执行顺序规律就是, 一开按照顺序依次执行中间件, 执行到最后一个中间件时, 会一直向上返回控制器</p></blockquote> <h3 id="上下文-context"><a href="#上下文-context" class="header-anchor">#</a> 上下文(Context)</h3> <p><strong>Koa</strong> <strong>Context</strong> 将 node 的 <code>request</code> 和 <code>response</code> 对象封装到单个对象中</p> <p>为编写 Web 应用程序和 API 提供了许多有用的方法</p> <p>每个请求都将创建一个 <code>Context</code>对象, 并在中间件中作为接收器引用</p> <p><code>Context</code>对象可以解决中间件之间的依赖问题, 是中间件之间的全局变量</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 可以随便放数据</span>
    ctx<span class="token punctuation">.</span>myData <span class="token operator">=</span> <span class="token string">&quot;第一个中间件的数据&quot;</span><span class="token punctuation">;</span>
  
    <span class="token comment">// 还可以把请求参数都往上一级挪一下</span>
  	<span class="token keyword">const</span> <span class="token punctuation">{</span> body<span class="token punctuation">,</span> reqeust<span class="token punctuation">,</span> params <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> body<span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>reqeust <span class="token operator">=</span> reqeust<span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>params <span class="token operator">=</span> params<span class="token punctuation">;</span>
  
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行下一个中间件</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>myData<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第一个中间件的数据</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><blockquote><p><code>await next()</code>执行下一个中间件时, 一定要放到语句的最后, 不然中间的修改参数下一个中间件就会失效</p></blockquote> <h4 id="请求处理-ctx-request"><a href="#请求处理-ctx-request" class="header-anchor">#</a> 请求处理(<a href="https://koa.bootcss.com/#request" target="_blank" rel="noopener noreferrer">ctx.request<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ctx<span class="token punctuation">.</span>req<span class="token punctuation">;</span> <span class="token comment">// 原生 node 的 request 对象</span>

<span class="token comment">// header</span>
ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'authorization'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回请求头对象里的指定字段(不区分大小写)</span>
ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">;</span> <span class="token comment">// 请求头</span>
ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>protocol<span class="token punctuation">;</span> <span class="token comment">// 请求协议</span>
ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>type<span class="token punctuation">;</span> <span class="token comment">// 请求 Content-Type</span>
ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>charset<span class="token punctuation">;</span> <span class="token comment">// 请求字符集</span>

<span class="token comment">// method</span>
ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method<span class="token punctuation">;</span> <span class="token comment">// 请求类型</span>
ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query<span class="token punctuation">;</span> <span class="token comment">// query 数据(params参数, 带?)</span>
ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>querystring <span class="token comment">// 根据 ? 获取原始查询字符串(不带?)</span>
ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span> <span class="token comment">// 请求体数据, 依赖 koa-bodyparse 第三方模块</span>

<span class="token comment">// path</span>
ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">;</span> <span class="token comment">// WHATWG 解析的 URL 字符串</span>
ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>origin<span class="token punctuation">;</span> <span class="token comment">// 获取URL的来源(完整路径)</span>
ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>href<span class="token punctuation">;</span> <span class="token comment">// 获取完整的URL(包括params参数)</span>
ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>path<span class="token punctuation">;</span> <span class="token comment">// 请求路径名</span>

<span class="token comment">// host</span>
ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>host<span class="token punctuation">;</span> <span class="token comment">// 主机号(带端口)</span>
ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>hostname<span class="token punctuation">;</span> <span class="token comment">// 主机名(不带端口)</span>
ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>ip<span class="token punctuation">;</span> <span class="token comment">// ip地址</span>
crx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>subdomains<span class="token punctuation">;</span> <span class="token comment">//子域(数组形式)</span>

<span class="token comment">// cookie</span>
ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span> <span class="token comment">// 获取 cookie</span>
ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token comment">// 设置 cookie</span>
    <span class="token string-property property">'expires'</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 时间</span>
    <span class="token string-property property">'path'</span><span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token comment">// 路径</span>
    <span class="token string-property property">'domain'</span><span class="token operator">:</span> <span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> <span class="token comment">// 域</span>
    <span class="token string-property property">'httpOnly'</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 禁止js获取</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// error</span>
ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">'Not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h4 id="ctx-request-fresh"><a href="#ctx-request-fresh" class="header-anchor">#</a> ctx.request.fresh</h4> <p>检查请求缓存是否“新鲜”, 也就是内容没有改变</p> <p>此方法用于 <code>If-None-Match</code> / <code>ETag</code>, 和 <code>If-Modified-Since</code> 和 <code>Last-Modified</code> 之间的缓存协商</p> <p>在设置一个或多个这些响应头后应该引用它</p> <h4 id="ctx-request-stale"><a href="#ctx-request-stale" class="header-anchor">#</a> ctx.request.stale</h4> <p>与 <code>ctx.request.fresh</code> 相反</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 新鲜度检查需要状态20x或304</span>
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'ETag'</span><span class="token punctuation">,</span> <span class="token string">'123'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 缓存是好的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>fresh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">304</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 缓存是陈旧的</span>
    <span class="token comment">// 获取新数据</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'最新的数据'</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="request-is-types"><a href="#request-is-types" class="header-anchor">#</a> request.is(types...)</h4> <p>检查传入请求是否包含 <code>Content-Type</code> 消息头字段,  并且包含任意的 mime <code>type</code>。 如果没有请求主体, 返回 <code>null</code>。 如果没有内容类型, 或者匹配失败, 则返回 <code>false</code>。 反之则返回匹配的 content-type</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用 Content-Type: text/html; charset=utf-8</span>
    ctx<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; 'html'</span>
    ctx<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; 'text/html'</span>
    ctx<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">'text/*'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; 'text/html'</span>

    <span class="token comment">// 当 Content-Type 是 application/json 时</span>
    ctx<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">'json'</span><span class="token punctuation">,</span> <span class="token string">'urlencoded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; 'json'</span>
    ctx<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; 'application/json'</span>
    ctx<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">,</span> <span class="token string">'application/*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; 'application/json'</span>

    ctx<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不匹配就会返回 false</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>例如, 如果要确保仅将图像发送到给定路由</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">'image/*'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 处理</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">415</span><span class="token punctuation">,</span> <span class="token string">'images only!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="request-accepts-types"><a href="#request-accepts-types" class="header-anchor">#</a> request.accepts(types)</h4> <p>与 <code>request.is()</code>类似</p> <h4 id="request别名"><a href="#request别名" class="header-anchor">#</a> Request别名</h4> <p><img src="/note-sites/assets/img/image-20220830214728074.b9882ddc.png" alt="image-20220830214728074"></p> <h4 id="响应处理-ctx-response"><a href="#响应处理-ctx-response" class="header-anchor">#</a> 响应处理(<a href="https://koa.bootcss.com/#response" target="_blank" rel="noopener noreferrer">ctx.response<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ctx<span class="token punctuation">.</span>res<span class="token punctuation">;</span> <span class="token comment">// 原生 node 的 response 对象</span>

ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">;</span> <span class="token comment">// 响应头</span>

<span class="token comment">// 用一个对象设置多个响应头</span>
ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string-property property">'Etag'</span><span class="token operator">:</span> <span class="token string">'1234'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'Last-Modified'</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 根据字段获取响应头vale(不区分大小写)</span>
ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'Last-Modified'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 响应数据, 简写 ctx.body</span>
ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 响应状态码, 简写 ctx.status</span>
ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span> 
<span class="token comment">// 响应的状态消息字符串 默认情况下, response.message 与 response.status 关联, 简写 ctx.message</span>
ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">'ok'</span><span class="token punctuation">;</span>

<span class="token comment">// 响应 Content-Type</span>
ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'text/html; charset=utf-8'</span><span class="token punctuation">;</span> <span class="token comment">// defaule</span>

<span class="token comment">// 删除消息头 field</span>
ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 类似 ctx.request.is()</span>
response<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>types<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 重定向</span>
ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'https://www.baidu.com/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h4 id="ctx-response-append-field-value"><a href="#ctx-response-append-field-value" class="header-anchor">#</a> ctx.response.append(field, value)</h4> <p>追加响应头字段数据</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'Link'</span><span class="token punctuation">,</span> <span class="token string">'&lt;http://127.0.0.1/&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'Link'</span><span class="token punctuation">,</span> <span class="token string">'&lt;http://localhost/&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'Link'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// [ '&lt;http://127.0.0.1/&gt;', '&lt;http://localhost/&gt;' ]</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="response-别名"><a href="#response-别名" class="header-anchor">#</a> Response 别名</h4> <p><img src="/note-sites/assets/img/image-20220830214755893.d72a8c19.png" alt="image-20220830214755893"></p> <p>绕过 <strong>Koa</strong> 的 <strong>response</strong> 处理是 <strong>不被支持的</strong>, 应避免使用以下 node 属性：</p> <ul><li><code>res.statusCode</code></li> <li><code>res.writeHead()</code></li> <li><code>res.write()</code></li> <li><code>res.end()</code></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ctx.res.end('res.end'); 不推荐使用原生 node 响应对象处理</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'ctx.response'</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p>官方说不支持, 测试了一下是支持的, 不推荐这样使用</p></blockquote> <h3 id="错误处理-2"><a href="#错误处理-2" class="header-anchor">#</a> 错误处理</h3> <p>默认情况下, <strong>Koa</strong> 会将所有错误输出到 <strong>stderr</strong>, 可以添加一个<code>error</code>事件来捕获错误</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发生了错误'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果 req/res 期间出现错误, 并且 <em>无法</em> 响应客户端, <code>Context</code>实例仍然被传递</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发生了错误'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'上下文对象'</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>当发生错误<strong>并且</strong>仍然可以响应客户端时, 也没有数据被写入 <strong><a href="https://zh.wikipedia.org/wiki/%E7%B6%B2%E8%B7%AF%E6%8F%92%E5%BA%A7" target="_blank" rel="noopener noreferrer">socket<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong> 中, Koa 将用一个状态码 <strong>500</strong> “内部服务器错误” 进行适当的响应</p> <h3 id="koa流行依赖-包"><a href="#koa流行依赖-包" class="header-anchor">#</a> Koa流行依赖(包)</h3> <p><code>koa</code>没有捆绑任何中间件, 需要添加中间件的话只能是自己组合</p> <h4 id="koa-router"><a href="#koa-router" class="header-anchor">#</a> koa-router</h4> <p><a href="https://github.com/koajs/router/blob/HEAD/API.md" target="_blank" rel="noopener noreferrer">koa-router<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>如果是不使用第三方包来写路由的话, 代码就会这样</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">'/'</span><span class="token operator">:</span> <span class="token comment">// 首页</span>
            ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span>
            ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'index'</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'/list'</span><span class="token operator">:</span> <span class="token comment">// 列表页</span>
            ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span>
            ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'list'</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">'Not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 404</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>代码就会写的很长, 很繁琐, 当然社区已经有人把这些封装好了就是<code>koa-router</code></p> <p><strong>koa-router</strong></p> <p>安装<code>npm install koa-router -S</code></p> <p>这是一个路由管理模块, 可以专门新建一个目录来存放路由控制器, 然后这些控制器通过 <code>app.js</code> 的 <code>koa-router</code> 模块加载</p> <p><code>app.js</code>文件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 实例化路由</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 可以使用中间来判断首页</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'index'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 单独使用(或分文件)也可以</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;test...&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 也可以通过 fs.readdirSync 读取 urls 目录下的所有文件名, 并挂载到 router 上面</span>
<span class="token keyword">const</span> urlPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./urls'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> urls <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>urlPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
urls<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 引入对应的文件</span>
    <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>urlPath <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 挂载到路由上</span>
    router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
        <span class="token string">'/'</span> <span class="token operator">+</span> item<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        module<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        module<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 挂载到 app 上</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">8000</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">服务启动</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">端口</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p><code>/urls/home.js</code>文件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> home <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//=&gt; /home</span>
home<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'home'</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//=&gt; home/list</span>
home<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/list'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'home-list'</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> home<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="静态文件-2"><a href="#静态文件-2" class="header-anchor">#</a> 静态文件</h4> <p><a href="https://www.npmjs.com/package/koa-static" target="_blank" rel="noopener noreferrer">koa-static<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>像一些静态文件的处理, Koa 也要现成的模块</p> <p>安装静态文件模块<code>npm install koa-static -S</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 引入 koa-static</span>
<span class="token keyword">const</span> koaStatic <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> resolve <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 静态文件目录</span>
<span class="token keyword">const</span> staticPath <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./static'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 应用</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">koaStatic</span><span class="token punctuation">(</span>staticPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>访问<code>http://localhost:8000/xxx.png</code>就可以访问静态资源了</p> <h4 id="koa-bodyparser"><a href="#koa-bodyparser" class="header-anchor">#</a> koa-bodyparser</h4> <p><a href="https://www.npmjs.com/package/koa-bodyparser" target="_blank" rel="noopener noreferrer">koa-bodyparser<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>一个解析 <code>POST</code> 数据的模块, 相当于<strong>Express</strong>里的<code>body-parser</code></p> <p>安装 <code>npm install koa-bodyparser -S</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-bodyparser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 一定要放到中间件或路由的前面</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// post请求的 请求体数据会被挂载到 ctx.request.body, 是一个 key =&gt; value 的集合</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>需要使用文件上传可以用<a href="https://www.npmjs.com/package/koa-body" target="_blank" rel="noopener noreferrer"><code>koa-body</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>模块来完成</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> koaBody <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-body'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">koaBody</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">multipart</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 支持文件上传</span>
    <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">'gzip'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">formidable</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">uploadDir</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'public/upload/'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 设置文件上传目录</span>
        <span class="token literal-property property">keepExtensions</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token comment">// 保持文件的后缀</span>
        <span class="token literal-property property">maxFieldsSize</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token comment">// 文件上传大小</span>
        <span class="token function-variable function">onFileBegin</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 文件上传前的设置</span>
            <span class="token comment">// console.log(`name: ${name}`);</span>
            <span class="token comment">// console.log(file);</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>获取上传后文件的信息, 则需要在 <code>ctx.request.files</code> 中获取</p> <p>获取其他的表单字段, 则需要在 <code>ctx.request.body</code> 中获取</p> <h4 id="koa-cors"><a href="#koa-cors" class="header-anchor">#</a> @koa/cors</h4> <p><a href="https://www.npmjs.com/package/@koa/cors" target="_blank" rel="noopener noreferrer">@koa/cors<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 类似于 <strong>Express</strong>中的<code>cors</code>, 同样是处理跨域请求</p> <p>安装<code>npm install @koa/cors -S</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@koa/cors&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 注册中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="koa-multer"><a href="#koa-multer" class="header-anchor">#</a> @koa/multer</h4> <p><a href="https://www.npmjs.com/package/@koa/multer" target="_blank" rel="noopener noreferrer">@koa/multer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>模块使用功同<a href="https://www.npmjs.com/package/multer" target="_blank" rel="noopener noreferrer">multer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="koa-views"><a href="#koa-views" class="header-anchor">#</a> koa-views</h4> <p><a href="https://www.npmjs.com/package/koa-views" target="_blank" rel="noopener noreferrer">koa-views<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是一个视图管理模块, 它的灵活度很高, 支持很多的模版引擎, 以 <code>ejs</code>引擎为例</p> <p>安装 <code>npm install koa-views egg.js -S</code></p> <p><code>app.js</code>文件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> views <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-views'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> resolve <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 视图目录</span>
<span class="token keyword">const</span> viewsPath <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./views'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 应用</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">views</span><span class="token punctuation">(</span>viewsPath<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// ejs 文件扩展名映射到引擎</span>
    <span class="token literal-property property">extension</span><span class="token operator">:</span> <span class="token string">'ejs'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// render 渲染方法, 这里加载到 views/index.ejs 文件, 第二参数是传参到模版</span>
    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'index页面'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>新建一个<code>views</code>目录, 存放视图文件, 再新建一个<code>index.ejs</code>, 内容如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>ejs<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">%=</span>message<span class="token operator">%</span><span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> ejs 的模版语法<span class="token punctuation">,</span> 读取变量 message <span class="token operator">|</span> 是从 render 传递过来 <span class="token operator">--</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>ejs</strong></p> <p><a href="https://ejs.bootcss.com/#promo" target="_blank" rel="noopener noreferrer">ejs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是一个非常简洁的 JavaScript 模版引擎, 使用起来也很简单</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 读取变量</span>
<span class="token operator">&lt;</span><span class="token operator">%=</span><span class="token operator">%</span><span class="token operator">&gt;</span> 

<span class="token comment">// 控制流程, 循环操作</span>
<span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">%</span><span class="token operator">&gt;</span> 

<span class="token comment">// 例子</span>
<span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">%</span><span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span><span class="token operator">%</span> arr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">%=</span>element<span class="token operator">%</span><span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">%</span><span class="token punctuation">}</span><span class="token operator">%</span><span class="token operator">&gt;</span>

<span class="token comment">// 引入文件</span>
<span class="token operator">&lt;</span><span class="token operator">%</span> include file <span class="token operator">%</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="koa-compose"><a href="#koa-compose" class="header-anchor">#</a> koa-compose</h4> <p><code>koa-compose</code>模块可以将多个中间件合成为一个</p> <p>安装<code>npm install koa-compose -S</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> compose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-compose'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 打印请求时间, 请求类型, 请求URL</span>
<span class="token keyword">const</span> <span class="token function-variable function">logger</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 返回数据</span>
<span class="token keyword">const</span> <span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'hello koa-compose'</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'main'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 组合到一起从右到左执行</span>
<span class="token keyword">const</span> middlewares <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token punctuation">[</span>logger<span class="token punctuation">,</span> main<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 应用</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>middlewares<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>测试访问输出</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Thu Jan <span class="token number">27</span> <span class="token number">2022</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">07</span> <span class="token constant">GMT</span><span class="token operator">+</span><span class="token number">0800</span> <span class="token punctuation">(</span>中国标准时间<span class="token punctuation">)</span> <span class="token constant">GET</span> <span class="token operator">/</span>
main
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="koa封装数据库操作"><a href="#koa封装数据库操作" class="header-anchor">#</a> Koa封装数据库操作</h4> <p>先把操作mysql[封装](#Node 连接 MySQL)成一个函数, 然后保存到上下文对象中</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 直接将工具函数挂载到 app.context 上(推荐)</span>
app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>util <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">mysql</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils/mysql'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 或者通过一个中间件, 把所有的工具关联起来</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>util <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">mysql</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils/mysql'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment">// 在后面的中间直接操作数据库</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">mysql</span><span class="token punctuation">(</span><span class="token string">'select * from user'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span>'
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="koa记录日志"><a href="#koa记录日志" class="header-anchor">#</a> Koa记录日志</h4> <p>日志模块用的是第三方的 Node.js 模块 <a href="https://www.npmjs.com/package/log4js" target="_blank" rel="noopener noreferrer">log4js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, 日志的功能也可以定制成一个工具, 存放到 <code>utils</code> 目录</p> <p>安装<code>npm install log4js -S</code></p> <p>封装<code>log4js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> log4js <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'log4js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 配置日志信息</span>
log4js<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">appenders</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">everything</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'file'</span><span class="token punctuation">,</span>
            <span class="token comment">// 输出日志目录, 按天分类</span>
            <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">logs/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.log</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">categories</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">appenders</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'everything'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token literal-property property">level</span><span class="token operator">:</span> <span class="token string">'info'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> logger <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> logger<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><code>app.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token comment">// 挂载日志模块</span>
app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>util <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">log</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils/log.js'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">// 记录日志</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	ctx<span class="token punctuation">.</span>util<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'记录一个日志'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>生成的日志如下</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAeAAAAAvCAYAAAA7HRlAAAAXpklEQVR4nO2dT0wbZ/rHP/vT7wYZatQFkhiRYERbWBKFhXo31iqsHFCsKrn8GoF8Cj2kQuohl6j6pUoOQZtVxXUltD00PVmgZC/pgYgEldWKSi4RKEFJVQsnIJwE6AqKY593DzMez4znvw2Y5v1IlerhnXee+ZP3O8/zPvM+v3n/dz3/QSAQCAQCwZ7yP/ttgEAgEAgEbyNCgAUCgUAg2AeEAAsEAoFAsA8IARYIBAKBYB8QAiwQCASCA83orbEDefz/rbAdAoFAIKhiRm+Ncf3a1bL2d0M5x9ht3JzDXtgvBFggEAjeIq5fu1oiwlaCZCZCboRpLz3Swrl4fbGwa7tX9usFuO8zRgda1J+5xb/z5Z3lPTFEIPg10XrxBsOnDqm//f5bahg5TfxEjfp7beYB/7hbERN3gQb+b/wkzervTR6MPOZpmb22XrzBcNsyt/+a4LmP/c+MjHG2aBRr01f5arZMo1SiXL51rnjOa/e5Pj5Tqc73DDMx2u+wrhu0outHhL0ey+/frWwy8YBXeXjtb/zTsqsQkaEwQfX3BnMTM2R0bQJ0nI/RVRg38immvn1EVtdNlMHexuLv9SSTs2ldL1L3BWLttervbGqKqYVtS8us0PeTY2n6Hs+29G2CfXEiTdZ/934cG3sN556ZTzCXLt2uR2+Xa3vre4gNtCP5OS8Te1RbLdpV5h6Z9WN87jB9ZpwxPJuWNts9w6V9GO15fucm1+8AtHHx/z+l1aOVOnLLJK6+YNO4PXyc4Utt1JXsUBS+zi/66Q8ahDt8nOFLh1n55nu+SwIfn+RKtKGkF6PYG18Gdp58z+3xvO64/xh5IP/vxye5EvVxrhWm9eINzjY7jWnlMMNX12TBPTMyxlmrZn2fMTrALtrhjXJFqhrE2Uxsd1OEnTxmP8f0GIIO0HE+DPMJJtOF3zEi53s0g5M8UEqpKSYXttU2sb7t4mBZ30OsF+YmErJw1/cQGwgT694qDoShKLGjr5iaUPoNRRnsjRHZMREAG4J9cSKHUmo/UvcFYgNRsspLQ2Hgz8wnmCNOpClP1of4urNXEZF8iqmJGf0LCUB6Rrmuil1HX5W8uHizN0RkoB0JAB/npbFHPXZvlGB6RnPf2pHWk0zOw2BvI9kd7+Lr7tqlmZvQGKM8M5FQ2sPzoAjnmyST36bVYxuPpb3Gk2Z914doqfH/olYxki+4nXwB1PDnsdMce24URIVcHil8nIa7JiKuYu+tykK+yYOR7+U24eMMXzrN8IjFMauCNn7fdojcYqIqRO/XhJPY7LZA2wnebnvClcSjAG/z7NuE7nfmZY6uo8Utwb4wwfWkIr6aNu3HCJKWB+6tR0xNaLrZSrOab6dFs8k4+JNeIWPpHVoQihJp2mBuoihi2ZVXZNvbaQlBJg3ZhXtMLgAE6OgA8julwugGR3vll5egK68tQPBoLbzZLrHFvb3F480RJsKKIUrhE+3xth4xNfEIAKm7E8ix7UN//d9rj8cLddNVk2NJq9jbO2TRHCsUJdYOS9MJa3EN1CH5eaHZL355zco7h+kMv2Az6WP/8HE+DOZ5/I1GoJMvuN0scSXaRiflh5kFu49RFA+CQJlhJq7GbQdFhMtOwpIkjVDU99DVlGNpWu+pRNprAbu35HoCNdh7T/UBJHKsuh5wA3R0NJJNTWmEJ0BHRPYIS0VLsSGV9ifATvaGuumq2WDuWzfummLLS7sR3t7eYF+MLlJMzW4RPG/dVyGUbRpa1hKKKl7hI9PjSVIt5FNkLEwueJWuQtSO91rx7NeT3jxQRWxbjgV4trWt8+CnChEd5Zmx61eqq4H8q8o8J3tCnu+Sea6cbeC7pLUPbEVD92HqyJeK91qWHdp4/2N4Wsl56bY4n39yilrttjf6JrZz7IZcFk59yuipQj+Lurlk4/xwaT/1PPn6Jur0vcdQstHOs7eKYeq9zrGxS7py47F69Wq17QuC6Bft/m5F1Wkfv/ZY7We23cnW8gQ4FCWiEVzp2BGNZ6CE+0gxl8oROWrtWQb7lLCspQAowullwK0P0aIRdVkAYGk+Rbb3SKnnVB+QhdlPCNXRXnlgJ5+jayhORG1nNn9OUYBWnF5IzO2Vui9oPP+Q88uNlSepzh8XbE1YeNEBpEOYeuxGnK+v1b3Wz7tahoft2HrE1Hwdg70xBtuL/ajPneIhZ48W/w6lc8SSVAs17cSGlEZmOQ7Vxt3XrI0fppNNf95qLsvPxm3JPNlL5ZumQxHf7emrfKkkSslJWMUmsqht8fDaTUUEo1y+9Smfowja7N+4Pgvq/PuyudC1XrzBez9e5fq4sqHvM0YHPuXyz5VL0lJzAapsDtgMM6/S7u/Gtk5iU6436md/u338ZkFX0qv2L8BK4k1mvhiqk6RaWH9KtvsCg0oYb3JL9rKsBmfZA9OHifUUhXxKF7o1SYTRDoSBOiQ2WNrukQfK1BSTE9sQitJlFj4M1Fl7XW6TkSztlb1V8q8056nMn/eFSkPSbkKcVvYqEYfM/D1ZLEPHCJJjyUL3MrMJJq2OoQkxE4oyOBS3OG9nj70YOrfD6l5DYfrjmWwMkaE4g81ek7BCRArJYvkcUk0twY4epLSSH1BXA9SSfaYV5SiDvX+iY6U436u/ZvK8fuw8VS7Cm/zrSRsfjdTw1PQ+NNA/3k+/+jvP40KS1h5ypv8UtWv3VfEtJcrZU4dYm76pEbIZHi5GGG77kFaWXWdKP79zk6+0G2Z/ZG2gxar5/mMWGdjFrGsroXEb2j0IIeBKsUdJWDKqN2k2T9YUJpJVxA6AEC1NkJk3DpSawdZSfJWkJdN5U+2AbEUjkcgOUxMJtf9gcyOsJ0s8OXnwtRA94xylJRb2Kt5q5pn2PAvz54GSkLibEKe5vXJoltRUMaHI7ry8kF5gqSNGS10AMKh5RaIHdve6xBiWUp0ETa6dJYo3j5ociCKu7XSFHjGXLobRl0rmo8MEAoDpNUyzuh4meMjsb9XF5sJr+LiBBlMBdvhkqFbit6BP4grXIJFnZa1SFrbR8A7kllcdWzYPjDE6YNj4xrSpzeFMBA2o2OlUmuUEX15LOLfbZazmV7Xb3gbxdfoEys018CzARY/VJHQKsJ7Uh+u6OwmyYfCaXAy2ZgOmZzaY03ol9T10WbwMBI/Wljev59le+ZjZl6VzuLp5dZt9jfbK1xpo14dQoZbIUNz3J0JASUhfZ++xIx7n5419+7t2bkLeehs3mNP27ybZK3TM5PnV2+I2/L7vJF/ww9l+/tTtbd5xc+E1OycO0xCGpxqP2HJu2DfLbP4CJ95tAextLP9b3iiXPzkFi3/nuhqelr/pFThjJrR+5mkPGl5eLNwkgnlYCzpAx/nCJz3m4pvN5qCpk456ZYOauKNpX99DrPCZkpX4hqIMDrSTnU/4Fwwl4aarO1DoVE3csQ6h+kzAcrJ3K81qHqS6gLop2Bejq2aDpZL2csQga+uymtubXbjH5ERC898US3l5DnNywmibfD8Hh6L6b2vNT9Dm2hU8x1eWCVjBvjiDQxeKz4Wua+/3unDt5ozPjxImtz6nGiSNDcG+MEE2WFW6yaxtQE2dMueN8rlcI9nUguXctzwNYmJLlfL0p02aWw972yn5gh8yNZy8dJLOwrbwcT46UcPaTGUzoNf+/QaaP+CM8tuYxAQz/LQGzQOfqW0qxZkRzYIaAJktchwiUHiYjMldXshskaOF9/rKNLLClJN8ZfUd7tuKWZKbU/KZaw9YHvQANMkngDaRKLtwjzkpTmQgThcgLxKhDVNrvks1emkFb1gZ9ACCvXEGe4tNPHlwJgk3WZ2HZTKHXLDJywIPruzd5tlcipYBzTmvJ5mcMDmGZTjXj70ussvNsJjzLvkmuF0bvCs8FzbRkRLz3Fw7iwU4zK6dDaXPJnLOgHb6Iz3DXHOcyFBc2WDy/BpsyZYVoSkT40IcJ05zZRxsw8l3l3kcPs1J268SSnn6lwfwRb9unng3VuV6fucmD98dK2YLr93n+vQHjP6x2Oaf41dhZEyXUQxes4qVeWNNhnRu8T5P3jmH+pq8nODOYhvDarh7lYdfL/KHTzRvcSWifI7RW+coWdCopK/9X2nQb5jYyct9GzzhSvGb93/X8x/11wHI1BMIDhb2mbhONIycJt762nwlrGpGWQmrEktRCiqP1RyuFVai6rQO814JsdeXCT/FGPxcMydEMQaBQCB4y/BTZMFqH6dVqaoVr58h+S1MYYeJByyKMQgE5SKKMUClijEIBL9W9AIsEAgEAoFgT/CQBS0QCAQCgaBSCAEWCAQCgWAfEAIsEAgEAsE+IARYIBAIBIJ9QAiwQCAQCA405ZQ63M/ji++ABQKB4C2i3EIJbsWmmr8B9rMQx24gBFggEAjeIqwq91i1dbPNyF56pE6rcVnhtx5wJdELsFiIQyCoCGIhDqjUQhytF28w3LbM7b8mXNf61XJmZIyzmioL5VdS0iJXUFK738X6vLuJ3TKS1YxTScBKH8vv361sMvGAVx3WgjYuSG+2+L6hcEA+VVqs3Ljgv0lBAeOC/37L6en7ybE0fa+kjrFcZtH6796PY2Ov4dzVIvcmRRCK6O1yba9S6k/yc14WRRlKKiJp2lXmHjn0U845mR7P2I+L59f478Dw/D6/c5Prd0BdC9q7iUVyy+ZrQRuLMagUha/zi376gwbhDh9n+NJhVr75nu+SKOs2N5T0YhR748vAzpPvuT2uLeqwyT9GHsj/q6wFvd+0XrzB2WanMa0cZvjqmiy4Z0b0xSF0VNk6++WKVDWIs1U1pt0SYSeP2c8xPYagA3ScD4NaGUceqCLnezQDlDwwSWqVGLlNrG+7OEDV9xDrhbmJhCzc9T3EBsLEureKg24oSuzoq2K1mlCUwd4YkR0TAbAh2FcooSj3I3VfIDYQJau8NBQG4sx8gjniRJp8Fq93Za8yaOflko4lpQ/TM2rFIan7gtyfYeD3Zq+m+hQ+zktjj3rs3ijB9IzmvsllCifnYbC30XvlJfB4r8s8J63NphWVXD6/SglF+frI++ie370g+YLbyRdADX8eO82x50ZBVMjlkcLHabhrV9DB3luVhXyTByPfy23Cxxm+dJrhEYtjVgVt/L7tELnFRFWI3q8JJ7HZbYF2Wn96Nz3hSuIxC3qbZ99qB8VtMi9zuhbBvjDB9aRmIFLaNB0regtbj/Q1hZV6uTrSM0xqxSe94q7EnZZQlEjTBnOafrIrr8jSSEtI+a3U0J1LK4XV8zv+agI72iu/vATXk/p2plgXnHdvb/F4c+vAuo/rZ4b2eFuPmJpIMDmbRqqrAXJs+9Ef1/e63HOSxRubWtTOz2+AjojcR/HfQZrVdZCOhoq1hKuJX16zwmE6wz73Dx/nw2Cex99oBDr5gtszm9SdaCvWCBZUNaO3xnT/HVTcVCVyqsNbLZSdhCVJGqGo76GrKcfStGZwq+8h0l4LtvVHXdStrQ8gkWPV9QAfoKOjkWxqSjNIy4OnBCaipdiQSvsTYCd7Q91y4fZv3bjvii0v7dw7e3uDfTG6SDE1u0XwvHVfhVC2aWhZSyiqeN7mLw+SVAv5FBkLkwueu6sQtcW9dntOVkjdnXL0wSa07fj8Fu6jto9QVJ4OqFZHkDzfJfNcOdvAd0nvRQ0bug9TR57NpOEPa1l2aOP9j+FpJeel2+J8/skptNWmeaNvYjvHbqzRq6n5y5tF3VyycX64tJ96nnx9E3X63mMo2WintobxXufY2CVduRErr4KmbV+uIPqpMey0j197rPZzW0FJS3kCHIoS0QxY0rEjSGpYUJlHI8VcKkfkqLVnGexTwrKWAqAI53rS/XxffYgWjajLAgBL8ymyvUdKPbX6gCzMfkKojvbKLwPkc3QNxYmo7SyK1xcEaMXphcTcXqn7guz5TzwiS8j55cbKc1XnWgu2Jiw9U+kQph67Eefra36vvZ+TkRBd7bVk80eIDcWLmzXzu26e32BzI+RTuukW2SNvJILz+e8bd1+zNn6YTjb9JUXlsvxs3JbMk71Uvmk6FPHdnr7Kl0qilJyEVWwii9oWD6/dVEQwyuVbn/I5iqDN/o3rs+BUi7n14g3e+/Eq18eVDX2fMTrwKZd/rlySlpoLUGVzwGa48SqtcBPyLTck7Gd/u338ZkFXMrTtX4CVxJvMfEIdKCWpFtafku2+wGA7LE0nmNySvSyrwVn2wAoDqxnFgXBKFzY0JMqAPlkmUIfEBkvbPcSGlLDjxDaEonSZzR0G6qw9bLfJSJb2yt4q+Vea81Tmz/tCpeHQQJ1GCCywslfx2DLz92SxDB0jSI4lC63KzCaYtDrG1iOmJh7J/x+KMjgUtzhvZ489u3CPyQWb85FPyvxeezwnU5QXFunNUybVKIQsoJHuNFML2y6e3wDBQ5B9mUbqixNrkl9K5gjQ4cMj31s2+deTNj4aqeGp6X1ooH+8n371d57HhSStPeRM/ylq1+6r4ltKlLOnDrE2fVMjZDM8XIww3PYhrSy7zpR+fucmX2k3zP7ImtZzrjbMIgO7mHVtJTRu51cPyjxsJdijJCwZ1ZucTpR6pE1hIllF7AAI0dIEmXnjqK0ZbC3Ft+hhlM7ZyfPRz2wtbSQS2WFqIqH2H2xuhPVkiScnz2FaiJ4hGckaC3uVwT/zTHue8txi19FASUhcqquB/Ctbb8rc3uIcZ0Ekbc/LC+kFljpitNQFAIPyVSR6YHWvK3ROygvL0hNt32lW18NEpHrUc7J9fgPy8dtjtMwnmCyIRH2IlhqHiEUVsLnwGj5uoMFUgB0+GaqV+C3ok7jCNUjkWVmrlIVtNLwDueVVx5bNA2OMDhg2vjFtanM4E0EDKnY6lWY5wZfXEvtthWWSk3bb2yC+Tp9AubkGngW46LGahE4BdAksyrwbGwavyU5YFZTwJ2o2qh/0CVjyHJ/5y0DwaK2j6Nni2V75mNmXpXO4unl1m32N9srXGmiPMdiubV9LZCju+xMhoCSkr7P32BGP8/PGvq2v3a6ek9nLoYvnN6tLwILgiXYkm/nvqiH5gh/O9vOnbm/zjpsLr9k5cZiGMDzVeMSWc8O+WWbzFzjxbgtgb2P53/JGufzJKVj8O9fV8LT8Ta/AGTOh9TNPe9Dw8mLhJhvbQxZ0gI7zhU96zMU3m81BUycd9coGNXFH076+h1jhMw8r8Q1FGVQ+8/A9uG7vkKWRru5AoVP585X1pE0I1WcClpO9Spa3VBdQNwX7YnTVbLBU0l4Whayte2dubyFDuvjfFEt5WTAmJ4y2yfdzcCiq+abb8gRtrl0hAeuVpQAF++IMDl0oPhe6ru2vnadzUsLkpueUXiFDLQH1FigZ1fkUS8o5OT+/22TfgNTerfYvz03nWJpzymyvDp7+tElz62FvOyVf8EOmhpOXThYznsPH+ehEDWsz5S+0oWXt32+g+QPOKL+NSUwww09r0DzwmdqmUpwZ0SyoAZDZIschAoWbbUzu8kJmixwtvNdXppEVppzkK6vvcN9WzJLcnJLPXHvAsmAAtMtzqipFbzi7cI85KU5kIE4XIC9woA1Ta77hNHo0BW+4voeYMt8a7I0z2Fts4snb2XrE1Hwdg73F42R1HpbJHHLBJjvP3Igre7d5NpeiZUBzzlbfoVqGc/3Y6yK73AyLOe+Sb4LbtcG7wnNhEx0pMc/PvfZ5TqSZmz/GoOY4WYPH7fz8QmZ2iqXzMSJqIpeH8600xoU4TpzmyjjYhpPvLvM4fJqTHlO2n/7lAXzRr5sn3o1VuZ7fucnDd8eK2cJr97k+/QGjfyy2+ef4VRgZ02UUg9esYmXeWJMhnVu8z5N3zqG+oy0nuLPYxrAa7l7l4deL/OETzZtkiSifY/TWOUoWNCrpa/9XGvQbJnbyct8GT7hS/Ob93/X8R/11ADL1BIKDhX0mrhMNI6eJt742XwmrmlFWwqrEUpSCyuPmW1otVqLqtA7zXgmx15cJP8UY/FwzJ0QxBoFAIHjL8FNkwWofp1WpqhWvnyH5LUxhh4kHLIoxCATlIooxQKWKMQgEv1b0AiwQCAQCgWBP8LgWtEAgEAgEgkogBFggEAgEgn3gv51Qa7kSyrI1AAAAAElFTkSuQmCC" alt="image-20220126143441527"></p> <h2 id="rest"><a href="#rest" class="header-anchor">#</a> REST</h2> <p><a href="https://www.runoob.com/nodejs/nodejs-restful-api.html" target="_blank" rel="noopener noreferrer">REST<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 即表述性状态传递, 是一种软件架构风格, 是一组架构约束条件和原则</p> <p><a href="https://www.runoob.com/nodejs/nodejs-restful-api.html" target="_blank" rel="noopener noreferrer">REST<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>即表述性状态传递, 是一种软件架构风格,表述性状态转移是一组架构约束条件和原则</p> <p>满足这些约束条件和原则的应用程序或设计就是RESTful, 并不是标准通常使用 JSON 数据格式</p> <blockquote><p><a href="https://www.runoob.com/w3cnote/restful-architecture.html" target="_blank" rel="noopener noreferrer">REST架构详解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h4 id="http-方法"><a href="#http-方法" class="header-anchor">#</a> HTTP 方法</h4> <p>以下为 REST 基本架构的四个方法：</p> <ul><li><strong>GET</strong> - 用于获取数据</li> <li><strong>PUT</strong> - 用于更新或添加数据</li> <li><strong>DELETE</strong> - 用于删除数据</li> <li><strong>POST</strong> - 用于添加数据</li></ul> <h2 id="网络请求"><a href="#网络请求" class="header-anchor">#</a> 网络请求</h2> <p>node中也可以使用<code>axios</code>来发送网络请求, 因为<code>axios</code>是一个异构项目, 同时兼容js的浏览器端和node服务端:</p> <h3 id="axios"><a href="#axios" class="header-anchor">#</a> axios</h3> <h4 id="文件上传-2"><a href="#文件上传-2" class="header-anchor">#</a> 文件上传</h4> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">&quot;axios&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> fileFromSync <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;fetch-blob/from.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FormData <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;formdata-polyfill/esm.min.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> serverUrl <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8100&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 服务器地址</span>
<span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token function">fileFromSync</span><span class="token punctuation">(</span><span class="token string">&quot;./package.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文件路径</span>

<span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建一个FormData对象</span>
formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将文件内容添加到FormData中</span>

<span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	url<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>serverUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/uploadFile</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
	method<span class="token operator">:</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span>
	headers<span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token string-property property">&quot;Content-Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;multipart/form-data&quot;</span> <span class="token comment">// 设置请求头中的Content-Type为multipart/form-data</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	data<span class="token operator">:</span> formData
<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;上传成功: &quot;</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;error: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="分片下载文件"><a href="#分片下载文件" class="header-anchor">#</a> 分片下载文件</h4> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> fs <span class="token keyword">from</span> <span class="token string">&quot;node:fs&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">&quot;axios&quot;</span><span class="token punctuation">;</span>

<span class="token comment">/** 文件信息 */</span>
<span class="token keyword">type</span> <span class="token class-name">FileInfoType</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">/** 文件大小 */</span>
  size<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token comment">/** 文件名称 */</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 获取文件的大小
 * @param url 请求地址
 * @returns
 */</span>
<span class="token keyword">const</span> getFileLength <span class="token operator">=</span> <span class="token punctuation">(</span>url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>FileInfoType<span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		axios
			<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token comment">// const contentLength = res.headers[&quot;content-length&quot;];</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;文件长度获取失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 分片获取文件内容
 * @param url 请求地址
 * @param startIndex 开始位置
 * @param endIndex 结束位置
 * @returns
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">getRangeContent</span> <span class="token operator">=</span> <span class="token punctuation">(</span>url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> startIndex<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> endIndex<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
		headers<span class="token operator">:</span> <span class="token punctuation">{</span>
			Range<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bytes=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>startIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>endIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		responseType<span class="token operator">:</span> <span class="token string">&quot;arraybuffer&quot;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 连接 arraybuffer
 * @param arrayBufferArray
 * @returns
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">concatArrayBuffer</span> <span class="token operator">=</span> <span class="token punctuation">(</span>arrayBufferArray<span class="token operator">:</span> ArrayBuffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token comment">// 获取总长度</span>
	<span class="token keyword">const</span> totalLength <span class="token operator">=</span> arrayBufferArray<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pre<span class="token punctuation">,</span> cur<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		pre <span class="token operator">+=</span> cur<span class="token punctuation">.</span>byteLength<span class="token punctuation">;</span>
		<span class="token keyword">return</span> pre<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 构建结果</span>
	<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>totalLength<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 偏移量</span>
	<span class="token keyword">let</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	arrayBufferArray<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token comment">// 向后拼接</span>
		result<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 偏移量追加</span>
		offset <span class="token operator">+=</span> item<span class="token punctuation">.</span>byteLength<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 一份分为 100 字节</span>
<span class="token keyword">const</span> <span class="token constant">RANGE_SIZE</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token comment">// 文件信息接口</span>
<span class="token keyword">const</span> <span class="token constant">GET_FILE_INFO</span> <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8100/getFileInfo?file=test.txt&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 文件下载接口</span>
<span class="token keyword">const</span> <span class="token constant">DOWNLOAD_FILE</span> <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8100/downloadFile?file=test.txt&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 记录执行时间</span>
<span class="token keyword">let</span> time <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token comment">// 获取文件信息</span>
		<span class="token keyword">const</span> fileInfo<span class="token operator">:</span> FileInfoType <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getFileLength</span><span class="token punctuation">(</span><span class="token constant">GET_FILE_INFO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 切分</span>
		<span class="token keyword">const</span> num <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>fileInfo<span class="token punctuation">.</span>size <span class="token operator">/</span> <span class="token constant">RANGE_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 临时文件存储的目录</span>
		<span class="token keyword">const</span> tempFileDir <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./rangeTemp/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileInfo<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> isExists <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>tempFileDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isExists<span class="token punctuation">)</span> fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>tempFileDir<span class="token punctuation">,</span> <span class="token punctuation">{</span> recursive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 存储已经保存的文件路径</span>
		<span class="token keyword">const</span> files<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token comment">//// 单个请求</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> startIndex <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token constant">RANGE_SIZE</span><span class="token punctuation">;</span>
			<span class="token keyword">const</span> endIndex <span class="token operator">=</span> startIndex <span class="token operator">+</span> <span class="token constant">RANGE_SIZE</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getRangeContent</span><span class="token punctuation">(</span><span class="token constant">DOWNLOAD_FILE</span><span class="token punctuation">,</span> startIndex<span class="token punctuation">,</span> endIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n第</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">次请求, 本次的数据: </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tempFileDir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
			fs<span class="token punctuation">.</span><span class="token function">appendFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> res<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span> encoding<span class="token operator">:</span> <span class="token string">&quot;binary&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 保存文件路径</span>
			files<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">////</span>

		<span class="token comment">//// 并行请求</span>
		<span class="token comment">// const apis = [];</span>
		<span class="token comment">// for (let i = 0; i &lt; num; i++) {</span>
		<span class="token comment">// 	const startIndex = i * RANGE_SIZE;</span>
		<span class="token comment">// 	const endIndex = startIndex + RANGE_SIZE - 1;</span>
		<span class="token comment">//   apis.push(getRangeContent(DOWNLOAD_FILE, startIndex, endIndex))</span>
		<span class="token comment">// }</span>
		<span class="token comment">// const resList = await Promise.allSettled(apis);</span>
		<span class="token comment">// resList.forEach((item, idx) =&gt; {</span>
		<span class="token comment">//   if (item.status === &quot;fulfilled&quot;) {</span>
		<span class="token comment">//     console.log(`\n第${idx + 1}次请求, 本次的数据: `);</span>
		<span class="token comment">//     console.log(item.value.data);</span>
		<span class="token comment">//     console.log(&quot;-&quot;.repeat(100));</span>
		<span class="token comment">//     const filePath = `${tempFileDir}/${idx + 1}`;</span>
		<span class="token comment">//     fs.appendFileSync(filePath, item.value.data, { encoding: &quot;binary&quot; });</span>
		<span class="token comment">//     // 保存文件路径</span>
		<span class="token comment">//     files.push(filePath);</span>
		<span class="token comment">//   } else {</span>
		<span class="token comment">//     console.error(`第${idx}个索引的分片数据请求失败:`, item.reason);</span>
		<span class="token comment">//     // TODO 重新请求失败的分片数据</span>
		<span class="token comment">//   }</span>
		<span class="token comment">// });</span>
		<span class="token comment">////</span>

		<span class="token comment">// 读取临时文件合并成最终文件</span>
		<span class="token keyword">const</span> ws <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileInfo<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> encoding<span class="token operator">:</span> <span class="token string">&quot;binary&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> idx<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token punctuation">{</span> encoding<span class="token operator">:</span> <span class="token string">&quot;binary&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 复制数据</span>
			rs<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span>

			rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token comment">// 删除临时文件</span>
				fs<span class="token punctuation">.</span><span class="token function">rm</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>

					<span class="token comment">// 删除临时文件目录</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">===</span> files<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						fs<span class="token punctuation">.</span><span class="token function">rmdir</span><span class="token punctuation">(</span>tempFileDir<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>

							<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;共用时: &quot;</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;err: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;err: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br></div></div><h3 id="request"><a href="#request" class="header-anchor">#</a> request</h3> <h4 id="get请求"><a href="#get请求" class="header-anchor">#</a> GET请求</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;request&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">request</span><span class="token punctuation">(</span><span class="token string">&quot;https://www.baidu.com/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> response<span class="token punctuation">,</span> body</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;请求失败&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// console.log(response); // 响应信息的集合</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>statusCode <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// 响应体</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="post请求"><a href="#post请求" class="header-anchor">#</a> POST请求</h4> <p><strong>application/x-www-form-urlencoded (普通表单)</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;request&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

request<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">url</span><span class="token operator">:</span> url<span class="token punctuation">,</span>
    <span class="token literal-property property">form</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'value'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> response<span class="token punctuation">,</span> body</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回的结果和 GET请求 一样</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>application/json (JSON表单)</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">url</span><span class="token operator">:</span> url<span class="token punctuation">,</span>
  <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">json</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;content-type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">&quot;value&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> response<span class="token punctuation">,</span> body</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 返回的结果和 GET请求 一样</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>multipart/form-data (上传文件)</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">&quot;https://www.baidu.com/&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 普通文本</span>
  <span class="token literal-property property">field</span><span class="token operator">:</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// 文件</span>
  <span class="token literal-property property">file</span><span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">&quot;./img.jpg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

request<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">url</span><span class="token operator">:</span> url<span class="token punctuation">,</span>
    <span class="token literal-property property">formData</span><span class="token operator">:</span> formData
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> response<span class="token punctuation">,</span> body</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回的结果和 GET请求 一样F</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="保存文件"><a href="#保存文件" class="header-anchor">#</a> 保存文件</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;request&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;events&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// request 会返回文件流实例</span>
<span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">&quot;https://www.jmjc.tech/public/home/img/flower.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>


<span class="token comment">// 通过 可写流+pipe 就可以实现文件下载到本地</span>
<span class="token function">request</span><span class="token punctuation">(</span><span class="token string">&quot;https://www.jmjc.tech/public/home/img/flower.png&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">&quot;./flower.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 下载文件到本地</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="命令行输出颜色"><a href="#命令行输出颜色" class="header-anchor">#</a> 命令行输出颜色</h2> <p>终端命令行输出颜色除了使用第三方库还可以使用ANSI Escape Code(ANSI转义码)实现, 常用的ANSI转义码如下:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>\x1b[30m黑色文本\x1b[0m
\x1b[31m红色文本\x1b[0m
\x1b[32m绿色文本\x1b[0m
\x1b[33m黄色文本\x1b[0m
\x1b[34m蓝色文本\x1b[0m
\x1b[35m紫色文本\x1b[0m
\x1b[36m青色文本\x1b[0m
\x1b[37m白色文本\x1b[0m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>基本使用:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;\x1b[31m%s\x1b[0m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;红色文本&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;\x1b[33m%s\x1b[0m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;黄色文本&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;\x1b[36m青色文本\x1b[0m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="typescript"><a href="#typescript" class="header-anchor">#</a> TypeScript</h2> <p>node环境下不能直接运行<code>.ts</code>文件, 还是需要将<code>.ts</code>文件编译为<code>.js/.cjs/.mjs</code>才可以被node直接执行, 好在可以使用一些工具库来直接运行<code>.ts</code>文件, 比较常用的是<code>ts-node</code>和<code>tsx</code>, 基本使用如下:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># ts-node </span>
<span class="token function">node</span> <span class="token parameter variable">--loader</span> ts-node/esm ./index.ts

<span class="token comment"># tsx</span>
tsx ./index.ts
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p><code>tsx</code>这个库比较好用可以直接运行<code>.ts</code>文件, 但是因为比较新, 有时会出现一些<code>BUG</code></p></blockquote> <h2 id="node-连接-mysql"><a href="#node-连接-mysql" class="header-anchor">#</a> Node 连接 MySQL</h2> <p>安装 <a href="https://www.npmjs.com/package/mysql" target="_blank" rel="noopener noreferrer"><strong>MySql</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <code>npm install mysql -S</code></p> <p>封装成<code>Promise</code>+ 线程池的通用函数</p> <blockquote><p><a href="https://www.expressjs.com.cn/guide/database-integration.html" target="_blank" rel="noopener noreferrer">Node 集成数据库<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;mysql&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取连接对象</span>
<span class="token keyword">const</span> pool <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 地址</span>
    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
    <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 用户</span>
    <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 密码</span>
    <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 数据库</span>
    <span class="token literal-property property">connectionLimit</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// 线程数</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 封装成函数</span>
<span class="token keyword">function</span> <span class="token function">db</span><span class="token punctuation">(</span><span class="token parameter">sql<span class="token punctuation">,</span> sqlParams <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 封装成 Promise</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 连接数据库</span>
        pool<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> conn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 连接对象调用 query方法 查询 sql语句, 并传入 参数sqlParams</span>
            conn<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> sqlParams<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token comment">// 查询到的数据(数组)</span>
                <span class="token comment">// console.log(results);</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 释放连接</span>
                conn<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 终止连接</span>
                <span class="token comment">// conn.destroy();</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 暴露数据库操作函数</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> db<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>参数说明:</p> <table><thead><tr><th style="text-align:left;">参数</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;"><strong>host</strong></td> <td style="text-align:left;">主机地址 （默认：localhost）</td></tr> <tr><td style="text-align:left;"><strong>user</strong></td> <td style="text-align:left;">用户名</td></tr> <tr><td style="text-align:left;"><strong>password</strong></td> <td style="text-align:left;">密码</td></tr> <tr><td style="text-align:left;"><strong>port</strong></td> <td style="text-align:left;">端口号 （默认：3306）</td></tr> <tr><td style="text-align:left;"><strong>database</strong></td> <td style="text-align:left;">数据库名</td></tr> <tr><td style="text-align:left;"><strong>charset</strong></td> <td style="text-align:left;">连接字符集（默认：'UTF8_GENERAL_CI', 注意字符集的字母都要大写）</td></tr> <tr><td style="text-align:left;"><strong>localAddress</strong></td> <td style="text-align:left;">此IP用于TCP连接（可选）</td></tr> <tr><td style="text-align:left;"><strong>socketPath</strong></td> <td style="text-align:left;">连接到unix域路径, 当使用 host 和 port 时会被忽略</td></tr> <tr><td style="text-align:left;"><strong>timezone</strong></td> <td style="text-align:left;">时区（默认：'local'）</td></tr> <tr><td style="text-align:left;"><strong>connectTimeout</strong></td> <td style="text-align:left;">连接超时（默认：不限制；单位：毫秒）</td></tr> <tr><td style="text-align:left;"><strong>stringifyObjects</strong></td> <td style="text-align:left;">是否序列化对象</td></tr> <tr><td style="text-align:left;"><strong>typeCast</strong></td> <td style="text-align:left;">是否将列值转化为本地JavaScript类型值 （默认：true）</td></tr> <tr><td style="text-align:left;"><strong>queryFormat</strong></td> <td style="text-align:left;">自定义query语句格式化方法</td></tr> <tr><td style="text-align:left;"><strong>supportBigNumbers</strong></td> <td style="text-align:left;">数据库支持bigint或decimal类型列时, 需要设此option为true （默认：false）</td></tr> <tr><td style="text-align:left;"><strong>bigNumberStrings</strong></td> <td style="text-align:left;">supportBigNumbers和bigNumberStrings启用 强制bigint或decimal列以JavaScript字符串类型返回（默认：false）</td></tr> <tr><td style="text-align:left;"><strong>dateStrings</strong></td> <td style="text-align:left;">强制timestamp,datetime,data类型以字符串类型返回, 而不是JavaScript Date类型（默认：false）</td></tr> <tr><td style="text-align:left;"><strong>debug</strong></td> <td style="text-align:left;">开启调试（默认：false）</td></tr> <tr><td style="text-align:left;"><strong>multipleStatements</strong></td> <td style="text-align:left;">是否许一个query中有多个MySQL语句 （默认：false）</td></tr> <tr><td style="text-align:left;"><strong>flags</strong></td> <td style="text-align:left;">用于修改连接标志</td></tr> <tr><td style="text-align:left;"><strong>ssl</strong></td> <td style="text-align:left;">使用ssl参数（与crypto.createCredenitals参数格式一至）或一个包含ssl配置文件名称的字符串, 目前只捆绑Amazon RDS的配置文件</td></tr></tbody></table></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2023/5/28 23:10:20</span></div></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-bac73764 data-v-c0d124fa><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#node中的js" class="sidebar-link reco-side-node中的js" data-v-bac73764>Node中的js</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#几个术语" class="sidebar-link reco-side-几个术语" data-v-bac73764>几个术语</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#ip地址和端口号" class="sidebar-link reco-side-ip地址和端口号" data-v-bac73764>IP地址和端口号</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#node中的全局变量" class="sidebar-link reco-side-node中的全局变量" data-v-bac73764>node中的全局变量</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#global" class="sidebar-link reco-side-global" data-v-bac73764>global</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#this" class="sidebar-link reco-side-this" data-v-bac73764>this</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#globalthis" class="sidebar-link reco-side-globalthis" data-v-bac73764>globalThis</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#filename" class="sidebar-link reco-side-filename" data-v-bac73764>__filename</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#dirname" class="sidebar-link reco-side-dirname" data-v-bac73764>__dirname</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#process" class="sidebar-link reco-side-process" data-v-bac73764>process</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#setimmediate" class="sidebar-link reco-side-setimmediate" data-v-bac73764>setImmediate</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#fs" class="sidebar-link reco-side-fs" data-v-bac73764>fs</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#readline" class="sidebar-link reco-side-readline" data-v-bac73764>readline</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#path" class="sidebar-link reco-side-path" data-v-bac73764>path</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#os" class="sidebar-link reco-side-os" data-v-bac73764>os</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#events" class="sidebar-link reco-side-events" data-v-bac73764>events</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#其他模块" class="sidebar-link reco-side-其他模块" data-v-bac73764>其他模块</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#http" class="sidebar-link reco-side-http" data-v-bac73764>http</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#类" class="sidebar-link reco-side-类" data-v-bac73764>类</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#mime" class="sidebar-link reco-side-mime" data-v-bac73764>MIME</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#zlib" class="sidebar-link reco-side-zlib" data-v-bac73764>zlib</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#url" class="sidebar-link reco-side-url" data-v-bac73764>url</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#旧版api" class="sidebar-link reco-side-旧版api" data-v-bac73764>旧版API</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#新版api" class="sidebar-link reco-side-新版api" data-v-bac73764>新版API</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#转换格式api" class="sidebar-link reco-side-转换格式api" data-v-bac73764>转换格式API</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#querystring" class="sidebar-link reco-side-querystring" data-v-bac73764>querystring</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#parse-和-encode" class="sidebar-link reco-side-parse-和-encode" data-v-bac73764>parse 和 encode</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#escape-和-unescape" class="sidebar-link reco-side-escape-和-unescape" data-v-bac73764>escape 和 unescape</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#buffer" class="sidebar-link reco-side-buffer" data-v-bac73764>Buffer</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#buffer的作用" class="sidebar-link reco-side-buffer的作用" data-v-bac73764>Buffer的作用</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#访问-buffer-的内容" class="sidebar-link reco-side-访问-buffer-的内容" data-v-bac73764>访问 buffer 的内容</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#复制-buffer" class="sidebar-link reco-side-复制-buffer" data-v-bac73764>复制 buffer</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#切片buffer" class="sidebar-link reco-side-切片buffer" data-v-bac73764>切片buffer</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#stream" class="sidebar-link reco-side-stream" data-v-bac73764>stream</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#什么是流" class="sidebar-link reco-side-什么是流" data-v-bac73764>什么是流</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#流的优点" class="sidebar-link reco-side-流的优点" data-v-bac73764>流的优点</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#使用流读取和写入文件" class="sidebar-link reco-side-使用流读取和写入文件" data-v-bac73764>使用流读取和写入文件</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#流驱动的-node-js-api" class="sidebar-link reco-side-流驱动的-node-js-api" data-v-bac73764>流驱动的 Node.js API</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#不同类型的流" class="sidebar-link reco-side-不同类型的流" data-v-bac73764>不同类型的流</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#crypto" class="sidebar-link reco-side-crypto" data-v-bac73764>crypto</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#child-process" class="sidebar-link reco-side-child-process" data-v-bac73764>child_process</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#开发环境与生产环境" class="sidebar-link reco-side-开发环境与生产环境" data-v-bac73764>开发环境与生产环境</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#断点调试" class="sidebar-link reco-side-断点调试" data-v-bac73764>断点调试</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#错误处理" class="sidebar-link reco-side-错误处理" data-v-bac73764>错误处理</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#创建异常" class="sidebar-link reco-side-创建异常" data-v-bac73764>创建异常</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#错误对象" class="sidebar-link reco-side-错误对象" data-v-bac73764>错误对象</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#处理异常" class="sidebar-link reco-side-处理异常" data-v-bac73764>处理异常</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#捕获未捕获的异常" class="sidebar-link reco-side-捕获未捕获的异常" data-v-bac73764>捕获未捕获的异常</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#promise-异常" class="sidebar-link reco-side-promise-异常" data-v-bac73764>Promise 异常</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#node-js-中记录对象" class="sidebar-link reco-side-node-js-中记录对象" data-v-bac73764>Node.js 中记录对象</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#node-模块化" class="sidebar-link reco-side-node-模块化" data-v-bac73764>Node 模块化</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#使用-typescript" class="sidebar-link reco-side-使用-typescript" data-v-bac73764>使用 TypeScript</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#webassembly" class="sidebar-link reco-side-webassembly" data-v-bac73764>WebAssembly</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#关键概念" class="sidebar-link reco-side-关键概念" data-v-bac73764>关键概念</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#生成-webassembly-模块" class="sidebar-link reco-side-生成-webassembly-模块" data-v-bac73764>生成 WebAssembly 模块</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#与操作系统交互" class="sidebar-link reco-side-与操作系统交互" data-v-bac73764>与操作系统交互</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#express" class="sidebar-link reco-side-express" data-v-bac73764>Express</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#app-use" class="sidebar-link reco-side-app-use" data-v-bac73764>app.use</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#请求和响应" class="sidebar-link reco-side-请求和响应" data-v-bac73764>请求和响应</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#覆盖-express-api" class="sidebar-link reco-side-覆盖-express-api" data-v-bac73764>覆盖 Express API</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#静态文件" class="sidebar-link reco-side-静态文件" data-v-bac73764>静态文件</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#路由" class="sidebar-link reco-side-路由" data-v-bac73764>路由</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#中间件" class="sidebar-link reco-side-中间件" data-v-bac73764>中间件</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#使用token" class="sidebar-link reco-side-使用token" data-v-bac73764>使用token</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#解析body参数" class="sidebar-link reco-side-解析body参数" data-v-bac73764>解析body参数</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#文件上传" class="sidebar-link reco-side-文件上传" data-v-bac73764>文件上传</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#文件下载" class="sidebar-link reco-side-文件下载" data-v-bac73764>文件下载</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#模板引擎" class="sidebar-link reco-side-模板引擎" data-v-bac73764>模板引擎</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#日志管理" class="sidebar-link reco-side-日志管理" data-v-bac73764>日志管理</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#koa" class="sidebar-link reco-side-koa" data-v-bac73764>Koa</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#koa参数设置" class="sidebar-link reco-side-koa参数设置" data-v-bac73764>Koa参数设置</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#app的常用属性-方法" class="sidebar-link reco-side-app的常用属性-方法" data-v-bac73764>app的常用属性/方法</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#中间件-2" class="sidebar-link reco-side-中间件-2" data-v-bac73764>中间件</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#上下文-context" class="sidebar-link reco-side-上下文-context" data-v-bac73764>上下文(Context)</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#错误处理-2" class="sidebar-link reco-side-错误处理-2" data-v-bac73764>错误处理</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#koa流行依赖-包" class="sidebar-link reco-side-koa流行依赖-包" data-v-bac73764>Koa流行依赖(包)</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#rest" class="sidebar-link reco-side-rest" data-v-bac73764>REST</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#网络请求" class="sidebar-link reco-side-网络请求" data-v-bac73764>网络请求</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#axios" class="sidebar-link reco-side-axios" data-v-bac73764>axios</a></li><li class="level-3" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#request" class="sidebar-link reco-side-request" data-v-bac73764>request</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#命令行输出颜色" class="sidebar-link reco-side-命令行输出颜色" data-v-bac73764>命令行输出颜色</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#typescript" class="sidebar-link reco-side-typescript" data-v-bac73764>TypeScript</a></li><li class="level-2" data-v-bac73764><a href="/note-sites/guide/Node/Node.html#node-连接-mysql" class="sidebar-link reco-side-node-连接-mysql" data-v-bac73764>Node 连接 MySQL</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-2a01419c data-v-2a01419c><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-2a01419c><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-2a01419c></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-2a01419c></path></svg></div></div></div>
    <script src="/note-sites/assets/js/app.b8d6499c.js" defer></script><script src="/note-sites/assets/js/5.2f78da70.js" defer></script><script src="/note-sites/assets/js/1.9e97c91a.js" defer></script><script src="/note-sites/assets/js/14.1d565f25.js" defer></script>
  </body>
</html>
